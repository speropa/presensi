<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Online Guru</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/speropa/presensi/main/ikon%20presensi.jpg">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #f9fafb;
            --text-primary: #1f2937; --text-secondary: #6b7280; --border-color: #e5e7eb;
            --accent-color: #2563eb; --accent-hover: #1d4ed8;
        }
        
        html {
            font-size: 14px;
        }

        @media (max-width: 720px) {
            html {
                font-size: 12px;
            }
        }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .app-bg { background-color: var(--bg-primary); }
        .card-bg { background-color: var(--bg-secondary); border: 1px solid var(--border-color); }
        .input-bg { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .input-bg:focus { border-color: var(--accent-color); ring: 1; ring-color: var(--accent-color); }
        .text-main { color: var(--text-primary); }
        .text-sub { color: var(--text-secondary); }
        .border-main { border-color: var(--border-color); }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .animate-shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        .nav-link.active { color: var(--accent-color); transform: scale(1.1); }
        .vertical-th { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; padding-bottom: 8px; padding-top: 8px; }
        button:disabled, select:disabled { background-color: #e5e7eb; cursor: not-allowed; color: #9ca3af; }
        
        .pin-input-dashes { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 4rem; }
        .pin-input-dashes .pin-dash { width: 16px; height: 16px; border-radius: 50%; background-color: #d1d5db; transition: background-color 0.2s ease; }
        .pin-input-dashes .pin-dash.filled { background-color: #1f2937; }
        
        .ios-keypad-button { display: flex; align-items: center; justify-content: center; width: 75px; height: 75px; border-radius: 50%; font-size: 2rem; font-weight: 400; transition: background-color 0.2s ease; cursor: pointer; background-color: #e5e7eb; color: #1f2937; }
        .ios-keypad-button:active { background-color: #d1d5db; }
        .ios-keypad-button.functional { background-color: transparent; border: none; }
        .dashboard-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .highlight-card { border-left: 5px solid #2563eb; }
        .persistent-card { border-left: 5px solid #f59e0b; }
        .completed-card { border-left: 5px solid #22c55e; }
        .future-card { border-left: 5px solid #9ca3af; }
        
        .presensi-table select, .presensi-table input {
            width: 100%; text-align: center; padding: 4px; border-radius: 6px;
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
        }
        .presensi-table input[type=number] { width: 60px; }
        .presensi-table th, .presensi-table td { padding: 8px; border: 1px solid var(--border-color); vertical-align: middle; text-align: center; }
        .presensi-table .nama-col { text-align: left; }
    </style>
</head>
<body class="app-bg">
    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-75 flex items-center justify-center z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div></div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden fade-in z-[100]"><p id="toast-message"></p></div>
    
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md card-bg rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold text-center text-main mb-2">Login Guru</h2>
            <p class="text-center text-sub mb-8">Gunakan akun yang terdaftar untuk masuk.</p>
            <form id="login-form">
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-sub mb-1">Email</label><input type="email" id="email" class="w-full px-4 py-2 input-bg rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div>
                <div class="mb-6"><label for="password" class="block text-sm font-medium text-sub mb-1">Password</label><input type="password" id="password" class="w-full px-4 py-2 input-bg rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div>
                <p id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">Masuk</button>
            </form>
        </div>
    </div>

    <div id="app" class="hidden">
        <div id="offline-indicator" class="bg-yellow-500 text-center text-white p-2 text-sm hidden fixed top-0 w-full z-[90]">Anda sedang offline. Perubahan akan disinkronkan saat kembali online.</div>
        <header class="w-full">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center card-bg shadow-md rounded-b-xl">
                <div class="flex items-center">
                    <h1 id="user-display-name" class="text-xl font-bold text-main">Memuat...</h1>
                </div>
                <div class="relative flex items-center">
                    <button id="install-pwa-btn" class="hidden p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 mr-2" title="Instal Aplikasi">
                        <i class="fa-solid fa-download text-xl text-main"></i>
                    </button>
                    <button id="burger-menu-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fa-solid fa-bars text-xl text-main"></i>
                    </button>
                    <div id="dropdown-menu" class="hidden absolute right-0 top-full mt-2 w-56 card-bg rounded-lg shadow-xl z-20">
                        <div class="p-2">
                            <div class="flex items-center justify-between px-3 py-2 text-sub">
                                <div class="flex items-center"><i class="fa-solid fa-unlock-alt w-6"></i><span class="ml-2">Bebas Presensi & Nonaktifkan Notifikasi</span></div>
                                <label for="bebas-presensi-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="bebas-presensi-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div></label>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 pb-24">
            <div id="page-dashboard" class="page-content">
                <div id="dashboard-container" class="mb-6">
                    <div class="mb-4">
                        <h2 id="dashboard-greeting" class="text-2xl font-bold text-main">Selamat Datang!</h2>
                        <p id="dashboard-date" class="text-sub"></p>
                    </div>
                    <div id="dashboard-jadwal-cerdas"></div>
                </div>
            </div>
            <div id="page-presensi" class="page-content hidden">
                <div class="card-bg p-4 rounded-xl shadow-md mb-6" id="filter-container">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Filter Presensi & Nilai</h3>
                        <button id="delete-daily-data-btn" class="bg-red-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="hidden sm:inline">Hapus Data Hari Ini</span></button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="filter-mapel" class="text-sm font-medium">Mata Pelajaran</label><select id="filter-mapel" class="w-full mt-1 p-2 input-bg rounded-lg"><option value="">Pilih Mapel...</option></select></div>
                        <div><label for="filter-kelas" class="text-sm font-medium">Kelas</label><select id="filter-kelas" class="w-full mt-1 p-2 input-bg rounded-lg" disabled><option value="">Pilih Kelas...</option></select></div>
                        <div><label for="filter-tanggal" class="text-sm font-medium">Tanggal</label><input type="date" id="filter-tanggal" class="w-full mt-1 p-2 input-bg rounded-lg"></div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button id="terapkan-filter-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Terapkan</button>
                        <div class="flex items-center space-x-2"><span id="mode-label" class="text-sm font-medium text-sub">Mode: Presensi</span><button id="toggle-mode-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600 focus:outline-none"><span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" id="toggle-mode-switch"></span></button></div>
                    </div>
                </div>
                <div id="content-area" class="hidden">
                    <div class="p-4 rounded-xl shadow-md mb-6 bg-yellow-50 dark:bg-yellow-900/50 border border-yellow-200 dark:border-yellow-800">
                        <div class="flex items-center">
                            <label for="kegiatan-pembelajaran" class="text-sm font-bold text-main">Kegiatan Hari Ini</label>
                            <span id="kegiatan-save-status" class="text-xs text-green-700 dark:text-green-400 font-medium ml-2 hidden"></span>
                        </div>
                        <input type="text" id="kegiatan-pembelajaran" placeholder="Contoh: Mengerjakan Latihan Bab 3" class="w-full mt-2 p-2 input-bg rounded-lg">
                        <div class="mt-4 pt-4 border-t border-yellow-200 dark:border-yellow-800">
                            <h4 class="text-sm font-semibold mb-2">Riwayat Kegiatan</h4>
                            <div id="kegiatan-history-list" class="space-y-3 text-xs"></div>
                            <button id="kegiatan-history-toggle-more" data-state="partial" class="text-blue-600 text-xs font-semibold mt-2 hidden">Selengkapnya &darr;</button>
                        </div>
                    </div>
                    <div class="card-bg p-4 rounded-xl shadow-md mb-6" id="presensi-search-container">
                        <label for="search-presensi-student" class="block text-sm font-medium text-sub mb-1">Cari Siswa:</label>
                        <input type="text" id="search-presensi-student" placeholder="Cari berdasarkan nama..." class="w-full px-4 py-2 input-bg rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="student-table-container" class="card-bg p-4 rounded-xl shadow-md overflow-x-auto"></div>
                    <div id="save-all-container" class="mt-6 text-center"><button id="save-all-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed dark:disabled:bg-gray-600" disabled>Simpan Semua Perubahan</button></div>
                </div>
            </div>
            <div id="page-kelola-siswa" class="page-content hidden">
                <div class="card-bg p-4 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Tambah Siswa Baru</h3>
                        <div class="flex items-center space-x-2">
                            <label for="csv-upload" class="bg-blue-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-blue-600 cursor-pointer flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span class="hidden sm:inline">Unggah</span></label>
                            <input type="file" id="csv-upload" class="hidden" accept=".csv">
                            <button id="download-template-btn" class="bg-gray-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-gray-700 flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span class="hidden sm:inline">Unduh</span></button>
                            <button id="delete-all-students-btn" class="bg-red-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-red-600 flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="hidden sm:inline">Hapus Semua</span></button>
                        </div>
                    </div>
                    <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="student-name" class="text-sm font-medium">Nama Lengkap</label><input type="text" id="student-name" required class="w-full mt-1 p-2 input-bg rounded-lg"></div>
                        <div><label for="student-class" class="text-sm font-medium">Kelas</label><input type="text" id="student-class" required placeholder="Contoh: 7A" class="w-full mt-1 p-2 input-bg rounded-lg"></div>
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 h-fit">Tambah Siswa</button>
                    </form>
                </div>
                <div class="card-bg p-4 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="text-lg font-bold mb-2 sm:mb-0">Daftar Semua Siswa</h3>
                        <input type="text" id="search-all-students" placeholder="Cari siswa..." class="w-full sm:w-auto px-3 py-2 input-bg rounded-lg">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead style="background-color: #F0F8FF;" class="text-black"><tr><th class="p-3">No</th><th class="p-3">Nama Lengkap</th><th class="p-3">Kelas</th><th class="p-3 text-center">Aksi</th></tr></thead>
                            <tbody id="all-students-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="page-kelola-mapel" class="page-content hidden">
                 <div class="card-bg p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-lg font-bold mb-3">Tambah Mata Pelajaran</h3>
                    <form id="add-mapel-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="mapel-name" class="text-sm font-medium">Nama Mapel</label><input type="text" id="mapel-name" required class="w-full mt-1 p-2 input-bg rounded-lg"></div>
                        <div><label for="mapel-class" class="text-sm font-medium">Untuk Kelas</label><select id="mapel-class" required class="w-full mt-1 p-2 input-bg rounded-lg"><option value="">Memuat Kelas...</option></select></div>
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 h-fit">Tambah Mapel</button>
                    </form>
                </div>
                <div class="card-bg p-4 rounded-xl shadow-md">
                    <h3 class="text-lg font-bold mb-4">Daftar Mata Pelajaran</h3>
                    <div id="mapel-list-container" class="space-y-3"></div>
                </div>
            </div>
            <div id="page-jadwal" class="page-content hidden">
                <div class="card-bg p-4 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Jadwal Pelajaran</h3>
                        <div class="flex items-center space-x-3">
                            <span id="jadwal-mode-label" class="text-sm font-medium text-sub">Mode: Gambar</span>
                            <button id="toggle-jadwal-mode-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-blue-600 focus:outline-none"><span id="toggle-jadwal-mode-switch" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-5"></span></button>
                        </div>
                    </div>
                </div>
                <div id="jadwal-view-gambar" class="hidden">
                     <div class="card-bg p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Jadwal (Gambar)</h3>
                            <div class="flex items-center space-x-2">
                                <label id="jadwal-upload-label" for="jadwal-upload" class="bg-blue-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-600 cursor-pointer flex items-center space-x-2 transition-colors"><i class="fa-solid fa-upload"></i><span class="hidden sm:inline">Unggah</span></label>
                                <input type="file" id="jadwal-upload" class="hidden" accept="image/*">
                                <button id="delete-jadwal-btn" class="bg-red-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-600 flex items-center space-x-2 transition-colors hidden"><i class="fa-solid fa-trash"></i><span class="hidden sm:inline">Hapus</span></button>
                            </div>
                        </div>
                        <div id="jadwal-image-container" class="mt-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 min-h-[60vh] flex items-center justify-center bg-white">
                             <div id="jadwal-placeholder" class="text-center text-sub dark:text-gray-700"><i class="fa-solid fa-image text-5xl mb-4"></i><p>Belum ada jadwal yang diunggah.</p><p class="text-sm">Silakan unggah gambar jadwal Anda.</p></div>
                            <img id="jadwal-image" src="" alt="Jadwal Pelajaran" class="max-w-full max-h-[70vh] rounded-lg hidden object-contain"/>
                        </div>
                    </div>
                </div>
                <div id="jadwal-view-dinamis">
                    <div class="card-bg p-4 rounded-xl shadow-md mb-6">
                        <h3 class="text-lg font-bold mb-4">Buat Jadwal Pelajaran</h3>
                        <form id="add-jadwal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label for="jadwal-hari" class="text-sm font-medium">Hari</label>
                                <select id="jadwal-hari" required class="w-full mt-1 p-2 input-bg rounded-lg">
                                    <option value="senin">Senin</option><option value="selasa">Selasa</option><option value="rabu">Rabu</option><option value="kamis">Kamis</option><option value="jumat">Jumat</option><option value="sabtu">Sabtu</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label for="jadwal-jam-mulai" class="text-sm font-medium">Mulai</label><input type="time" id="jadwal-jam-mulai" required class="w-full mt-1 p-2 input-bg rounded-lg"></div>
                                <div><label for="jadwal-jam-selesai" class="text-sm font-medium">Selesai</label><input type="time" id="jadwal-jam-selesai" required class="w-full mt-1 p-2 input-bg rounded-lg"></div>
                            </div>
                            <div><label for="jadwal-mapel" class="text-sm font-medium">Mata Pelajaran</label><select id="jadwal-mapel" required class="w-full mt-1 p-2 input-bg rounded-lg"><option value="">Pilih Mapel...</option></select></div>
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 h-fit w-full">Tambah Jadwal</button>
                        </form>
                    </div>
                    <div class="card-bg p-4 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4">Jadwal Tersimpan</h3>
                        <div id="jadwal-terstruktur-container" class="space-y-6"></div>
                    </div>
                </div>
            </div>
            <div id="page-hasil-rekap" class="page-content hidden">
                <div class="card-bg p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-lg font-bold mb-4">Rekapitulasi Presensi & Nilai</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="rekap-filter-mapel" class="text-sm font-medium">Mata Pelajaran</label><select id="rekap-filter-mapel" class="w-full mt-1 p-2 input-bg rounded-lg"><option value="">Pilih Mapel...</option></select></div>
                        <div><label for="rekap-filter-kelas" class="text-sm font-medium">Kelas</label><select id="rekap-filter-kelas" class="w-full mt-1 p-2 input-bg rounded-lg" disabled><option value="">Pilih Kelas...</option></select></div>
                        <div class="flex items-end"><button id="terapkan-rekap-btn" class="w-full bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Terapkan</button></div>
                    </div>
                </div>
                <div id="rekap-table-container" class="card-bg p-4 rounded-xl shadow-md overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Data Rekapitulasi</h3>
                        <div class="relative inline-block text-left">
                            <button id="rekap-download-dropdown-btn" class="bg-gray-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-gray-700 flex items-center space-x-2 hidden"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span class="hidden sm:inline">Unduh Rekap</span><svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                            <div id="rekap-download-options" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg card-bg ring-1 ring-black ring-opacity-5 focus:outline-none hidden"><div class="py-1"><button id="download-csv-btn" class="text-main block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Unduh sebagai CSV</button><button id="print-rekap-btn" class="text-main block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700">Cetak (PDF)</button></div></div>
                        </div>
                    </div>
                    <div id="rekap-search-container" class="mb-4 hidden"><label for="search-rekap-student" class="block text-sm font-medium text-sub mb-1">Cari Siswa:</label><input type="text" id="search-rekap-student" placeholder="Cari berdasarkan nama..." class="w-full px-4 py-2 input-bg rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                    <div id="rekap-dynamic-table-content"></div>
                </div>
            </div>
        </main>
        <div class="fixed bottom-0 left-0 right-0 card-bg shadow-[0_-2px_5px_rgba(0,0,0,0.1)] z-40">
            <nav class="container mx-auto flex justify-around">
                <button data-page="dashboard" class="nav-link active flex flex-col items-center text-sub hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span class="text-xs font-medium">Dasbor</span></button>
                <button data-page="presensi" class="nav-link flex flex-col items-center text-sub hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg><span class="text-xs font-medium">Presensi</span></button>
                <button data-page="kelola-siswa" class="nav-link flex flex-col items-center text-sub hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 013.39-2.142 3.002 3.002 0 013.39 2.142M9 11a4 4 0 110-8 4 4 0 010 8z"></path></svg><span class="text-xs font-medium">Siswa</span></button>
                <button data-page="kelola-mapel" class="nav-link flex flex-col items-center text-sub hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span class="text-xs font-medium">Mapel</span></button>
                <button data-page="jadwal" class="nav-link flex flex-col items-center text-sub hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="text-xs font-medium">Jadwal</span></button>
                <button data-page="hasil-rekap" class="nav-link flex flex-col items-center text-sub hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="text-xs font-medium">Rekap</span></button>
            </nav>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-[60] hidden p-4"><div id="modal-content" class="card-bg rounded-xl shadow-lg p-6 w-full max-w-md fade-in"></div></div>

    <div id="image-viewer-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[70] hidden p-4 fade-in">
        <button id="close-image-viewer-btn" class="absolute top-4 right-4 text-white text-5xl font-bold hover:text-gray-300 transition-colors">&times;</button>
        <img id="fullscreen-image" src="" class="max-w-full max-h-full object-contain">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const GITHUB_USERNAME = "speropa";
        const GITHUB_REPO = "presensi";
        const firebaseConfig = { apiKey: "AIzaSyDPJFRn9ymq3OH0Kg9E09rEjc6W9SASh2Q", authDomain: "presensi-online-fe404.firebaseapp.com", databaseURL: "https://presensi-online-fe404-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "presensi-online-fe404", storageBucket: "presensi-online-fe404.firebasestorage.app", messagingSenderId: "608665441560", appId: "1:608665441560:web:90fea4bb8596289e048ba6d" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentMode = 'presensi', allStudents = {}, allMapel = {}, allJadwalTerstruktur = {}, hasUnsavedChanges = false, pendingAction = null, pendingPage = null, currentUserKey = null, currentUserName = null, githubToken = null, deferredPrompt, allLoginData = null, currentJadwalMode = 'dinamis', dashboardUpdateInterval = null, isBebasPresensi = false;
        let cropper = null; 
        let availableClasses = new Set(), unsavedChanges = {}, currentPresensiStudentsData = [], currentRekapData = { presensi: {}, nilai: {}, kegiatan: {}, kelas: '' };
        let allPresensiData = {}, allKegiatanData = {}, allNilaiData = {};

        const el = id => document.getElementById(id);
        const loadingSpinner = el('loading-spinner'), loginPage = el('login-page'), mainApp = el('app'), userDisplayName = el('user-display-name'), offlineIndicator = el('offline-indicator'), installPwaBtn = el('install-pwa-btn'), filterMapel = el('filter-mapel'), filterKelas = el('filter-kelas'), filterTanggal = el('filter-tanggal'), terapkanBtn = el('terapkan-filter-btn'), rekapFilterMapel = el('rekap-filter-mapel'), rekapFilterKelas = el('rekap-filter-kelas'), terapkanRekapBtn = el('terapkan-rekap-btn'), deleteDailyDataBtn = el('delete-daily-data-btn'), toggleModeBtn = el('toggle-mode-btn'), toggleModeSwitch = el('toggle-mode-switch'), modeLabel = el('mode-label'), contentArea = el('content-area'), kegiatanInput = el('kegiatan-pembelajaran'), studentTableContainer = el('student-table-container'), saveAllBtn = el('save-all-btn'), kegiatanHistoryList = el('kegiatan-history-list'), kegiatanHistoryToggleMore = el('kegiatan-history-toggle-more'), presensiSearchContainer = el('presensi-search-container'), searchPresensiStudentInput = el('search-presensi-student'), addStudentForm = el('add-student-form'), allStudentsTable = el('all-students-table'), csvUploadInput = el('csv-upload'), downloadTemplateBtn = el('download-template-btn'), deleteAllStudentsBtn = el('delete-all-students-btn'), searchAllStudentsInput = el('search-all-students'), addMapelForm = el('add-mapel-form'), mapelListContainer = el('mapel-list-container'), jadwalUploadInput = el('jadwal-upload'), jadwalUploadLabel = el('jadwal-upload-label'), jadwalImageContainer = el('jadwal-image-container'), jadwalImage = el('jadwal-image'), jadwalPlaceholder = el('jadwal-placeholder'), deleteJadwalBtn = el('delete-jadwal-btn'), imageViewerModal = el('image-viewer-modal'), closeImageViewerBtn = el('close-image-viewer-btn'), fullscreenImage = el('fullscreen-image'), rekapTableContainer = el('rekap-table-container'), rekapDownloadDropdownBtn = el('rekap-download-dropdown-btn'), rekapDownloadOptions = el('rekap-download-options'), downloadCsvBtn = el('download-csv-btn'), printRekapBtn = el('print-rekap-btn'), rekapSearchContainer = el('rekap-search-container'), searchRekapStudentInput = el('search-rekap-student'), rekapDynamicTableContent = el('rekap-dynamic-table-content'), addJadwalForm = el('add-jadwal-form'), jadwalTerstrukturContainer = el('jadwal-terstruktur-container'), toggleJadwalModeBtn = el('toggle-jadwal-mode-btn'), toggleJadwalModeSwitch = el('toggle-jadwal-mode-switch'), jadwalModeLabel = el('jadwal-mode-label'), jadwalViewGambar = el('jadwal-view-gambar'), jadwalViewDinamis = el('jadwal-view-dinamis'), dashboardGreeting = el('dashboard-greeting'), dashboardDate = el('dashboard-date'), dashboardJadwalCerdas = el('dashboard-jadwal-cerdas'), modal = el('modal'), modalContent = el('modal-content'), burgerMenuBtn = el('burger-menu-btn'), dropdownMenu = el('dropdown-menu');
        const navLinks = document.querySelectorAll('.nav-link'), pages = document.querySelectorAll('.page-content');
        
        const saveToLocal = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error("Gagal menyimpan ke localStorage:", e); } };
        const loadFromLocal = (key) => { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : null; } catch (e) { console.error("Gagal memuat dari localStorage:", e); return null; } };
        
        const mapelColorPalette = [{ bg: 'bg-sky-100', text: 'text-sky-800' }, { bg: 'bg-amber-100', text: 'text-amber-800' }, { bg: 'bg-violet-100', text: 'text-violet-800' }, { bg: 'bg-lime-100', text: 'text-lime-800' }, { bg: 'bg-rose-100', text: 'text-rose-800' }, { bg: 'bg-teal-100', text: 'text-teal-800' }, { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800' }, { bg: 'bg-indigo-100', text: 'text-indigo-800' }, { bg: 'bg-emerald-100', text: 'text-emerald-800' }, { bg: 'bg-cyan-100', text: 'text-cyan-800' }, { bg: 'bg-pink-100', text: 'text-pink-800' }, { bg: 'bg-green-100', text: 'text-green-800' }, { bg: 'bg-purple-100', text: 'text-purple-800' }];
        const kelasColorPalette = { 'A': { bg: 'bg-red-100', text: 'text-red-800' }, 'B': { bg: 'bg-orange-100', text: 'text-orange-800' }, 'C': { bg: 'bg-yellow-100', text: 'text-yellow-800' }, 'D': { bg: 'bg-green-100', text: 'text-green-800' }, 'E': { bg: 'bg-blue-100', text: 'text-blue-800' }, 'F': { bg: 'bg-purple-100', text: 'text-purple-800' }, 'DEFAULT': { bg: 'bg-gray-100', text: 'text-gray-800' } };
        function getDeterministicColor(str, type) { if (!str) return kelasColorPalette['DEFAULT']; if (type === 'kelas') { const rombel = str.charAt(str.length - 1).toUpperCase(); return kelasColorPalette[rombel] || kelasColorPalette['DEFAULT']; } if (type === 'mapel') { let hash = 0; for (let i = 0; i < str.length; i++) { hash += str.charCodeAt(i); } const index = hash % mapelColorPalette.length; return mapelColorPalette[index]; } return kelasColorPalette['DEFAULT']; }
        function getLocalISODate(date = new Date()) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatDateToIndonesian(date) { return date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }
        
        function formatReadableDate(isoDate, formatType = 'long') {
            const date = new Date(isoDate + 'T00:00:00'); 
            if (formatType === 'long') {
                return date.toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }
            return date.toLocaleDateString('id-ID'); 
        }
    
        const showLoader = () => loadingSpinner.classList.remove('hidden'); const hideLoader = () => loadingSpinner.classList.add('hidden'); const showToast = (message, isError = false) => { const toast = el('toast'); el('toast-message').textContent = message; toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg fade-in z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`; toast.classList.remove('hidden'); setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.classList.add('hidden'), 300); }, 3000); }; const openModal = (content) => { modalContent.innerHTML = content; modal.classList.remove('hidden'); }; window.closeModal = () => { if (cropper) { cropper.destroy(); cropper = null; } modalContent.classList.add('fade-out'); setTimeout(() => { modal.classList.add('hidden'); modalContent.classList.remove('fade-out'); modalContent.innerHTML = ''; }, 300); }; const showAlertModal = (title, message, isError = false) => { const titleColorClass = isError ? 'text-red-600' : 'text-gray-800'; const content = `<h3 class="text-lg font-bold mb-2 ${titleColorClass}">${title}</h3><p class="text-sub mb-6">${message}</p><div class="flex justify-end"><button onclick="window.closeModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Oke</button></div>`; openModal(content); }; const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); function sanitizeForPath(name) { if (!name) return 'unknown-user'; return name.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, ''); } const showUnsavedChangesModal = (action, targetPage = null) => { pendingAction = action; pendingPage = targetPage; const content = `<h3 class="text-lg font-bold mb-2">Perubahan Belum Disimpan</h3><p class="text-sub mb-6">Ada perubahan presensi atau nilai yang belum disimpan. Apakah Anda ingin menyimpannya?</p><div class="flex justify-end space-x-2"><button onclick="window.handleUnsavedChangesAction('cancel')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleUnsavedChangesAction('save')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`; openModal(content); };
        
        window.handleUnsavedChangesAction = async (action) => { closeModal(); if (action === 'save') { await handleSaveAllData(); if (pendingAction === 'applyFilter') { handleTerapkanFilter(true); } else if (pendingAction === 'changePage' && pendingPage) { switchPage(pendingPage, true); } } pendingAction = null; pendingPage = null; }; 
        
        function filterAllStudentsTable() { allStudentsTable.innerHTML = ''; const query = searchAllStudentsInput.value.toLowerCase(); const fullStudents = JSON.parse(allStudentsTable.dataset.fullStudents || '[]'); const filteredStudents = fullStudents.filter(student => student.nama.toLowerCase().includes(query) || student.kelas.toLowerCase().includes(query)); let tableRowsHtml = ''; if (filteredStudents.length === 0) { tableRowsHtml = `<tr><td colspan="4" class="text-center p-4 text-sub">Belum ada data siswa.</td></tr>`; } else { filteredStudents.forEach((student, index) => { tableRowsHtml += `<tr class="border-b border-main hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3 text-center">${index + 1}</td><td class="p-3 font-medium">${student.nama}</td><td class="p-3">${student.kelas}</td><td class="p-3 text-center"><div class="flex justify-center items-center space-x-2"><button onclick="window.showEditStudentModal('${student.id}')" class="p-2 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onclick="window.showDeleteStudentModal('${student.id}', '${student.nama}')" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></td></tr>`; }); } allStudentsTable.innerHTML = tableRowsHtml; } 
        
        function filterRekapTable() {
            const query = searchRekapStudentInput.value.toLowerCase();
            const { presensi: presensiData, nilai: nilaiData, kegiatan: kegiatanData, kelas } = currentRekapData;
            
            if (!presensiData && !nilaiData && !kegiatanData) {
                rekapDynamicTableContent.innerHTML = '<p class="text-center text-sub">Tidak ada data.</p>';
                return;
            }
            if (Object.values(allStudents).filter(s => s.kelas === kelas).length === 0) {
                rekapDynamicTableContent.innerHTML = '<p class="text-center text-sub">Tidak ada siswa.</p>';
                return;
            }
            
            const dateSet = new Set([
                ...Object.keys(presensiData),
                ...Object.keys(nilaiData),
                ...Object.keys(kegiatanData)
            ]);
            const sortedDates = Array.from(dateSet).sort(); 

            if (sortedDates.length === 0) {
                rekapDynamicTableContent.innerHTML = '<p class="text-center text-sub">Tidak ada data.</p>';
                return;
            }
            
            let tableHTML = `<table class="w-full text-xs text-left whitespace-nowrap"><thead style="background-color: #F0F8FF;" class="text-black">`;
            
            tableHTML += `<tr>`;
            tableHTML += `<th class="p-2 border border-main text-center w-10" rowspan="2">No</th>`;
            tableHTML += `<th class="p-2 border border-main text-center" rowspan="2">Nama</th>`;
            sortedDates.forEach(date => {
                const [y, m, d] = date.split('-');
                tableHTML += `<th class="vertical-th border border-main" rowspan="2">${d}/${m}/${y.slice(-2)}</th>`;
            });
            
            tableHTML += `<th class="p-2 border border-main text-center font-bold" colspan="3">Jumlah</th>`;
            tableHTML += `</tr>`;

            tableHTML += `<tr>`;
            tableHTML += `<th class="p-2 border border-main text-center font-bold" style="background-color: #FFFACD;">S</th>`;
            tableHTML += `<th class="p-2 border border-main text-center font-bold" style="background-color: #E0FEE0;">I</th>`;
            tableHTML += `<th class="p-2 border border-main text-center font-bold" style="background-color: #FFEEEE;">A</th>`;
            tableHTML += `</tr>`;
            
            tableHTML += `</thead><tbody>`;
            
            const statusSymbols = { Hadir: '•', Sakit: 'S', Izin: 'I', Alpa: 'A' }, statusColors = { S: 'text-orange-600', I: 'text-green-600', A: 'text-red-600' };
            let filteredCount = 0;
            Object.entries(allStudents).filter(([id, student]) => student.kelas === kelas).sort(([, a], [, b]) => a.nama.localeCompare(b.nama)).forEach(([studentId, student]) => {
                if (student.nama.toLowerCase().includes(query)) {
                    
                    let countS = 0, countI = 0, countA = 0;
                    
                    tableHTML += `<tr class="border-b border-main"><td class="p-2 border border-main text-center">${filteredCount + 1}</td><td class="p-2 border border-main font-medium">${student.nama}</td>`;
                    sortedDates.forEach(date => {
                        const status = presensiData[date]?.[studentId]?.status, nilai = nilaiData[date]?.[studentId]?.nilai;
                        
                        if (status === 'Sakit') countS++;
                        else if (status === 'Izin') countI++;
                        else if (status === 'Alpa') countA++;

                        let cellContent = '-';
                        let cellBgClass = ''; 
                        if (status || nilai || nilai === 0) {
                            const symbol = status ? statusSymbols[status] || '?' : '•', colorClass = status ? statusColors[status] || '' : '', nilaiHtml = (nilai || nilai === 0) ? `<br><span class="font-bold">${nilai}</span>` : '';
                            cellContent = `<span class="${colorClass}">${symbol}</span>${nilaiHtml}`;
                            
                            if (status === 'Sakit') cellBgClass = 'bg-orange-100';
                            else if (status === 'Izin') cellBgClass = 'bg-green-100';
                            else if (status === 'Alpa') cellBgClass = 'bg-red-100';
                        }
                        tableHTML += `<td class="p-2 border border-main text-center ${cellBgClass}">${cellContent}</td>`; 
                    });

                    tableHTML += `<td class="p-2 border border-main text-center font-bold" style="background-color: #FFFACD;">${countS}</td>`;
                    tableHTML += `<td class="p-2 border border-main text-center font-bold" style="background-color: #E0FEE0;">${countI}</td>`;
                    tableHTML += `<td class="p-2 border border-main text-center font-bold" style="background-color: #FFEEEE;">${countA}</td>`;
                    
                    tableHTML += `</tr>`;
                    filteredCount++;
                }
            });

            tableHTML += `<tr class="border-b border-main" style="background-color: #f9fafb; font-weight: bold;">`;
            tableHTML += `<td class="p-2 border border-main text-left" colspan="2">Kegiatan Pembelajaran</td>`;
            sortedDates.forEach(date => {
                const kegiatan = kegiatanData[date]?.deskripsi || '-';
                
                tableHTML += `<td class="vertical-th border border-main" style="font-weight: 500;">${kegiatan}</td>`;
            });
            
            tableHTML += `<td class="p-2 border border-main text-center">-</td>`;
            tableHTML += `<td class="p-2 border border-main text-center">-</td>`;
            tableHTML += `<td class="p-2 border border-main text-center">-</td>`;
            tableHTML += `</tr>`;

            tableHTML += `</tbody></table>`;
            rekapDynamicTableContent.innerHTML = tableHTML;
            if (filteredCount === 0 && query !== '') {
                rekapDynamicTableContent.innerHTML = `<p class="text-center text-sub">Siswa tidak ditemukan.</p>`;
            }
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const namaSnapshot = await get(ref(db, 'users_data/user1/nama'));
                    const namaData = namaSnapshot.val();
                    
                    if (!namaData || !namaData.name) {
                        throw new Error("Data 'nama' untuk 'user1' tidak ditemukan.");
                    }
                    
                    currentUserName = namaData.name; 
                    saveToLocal('lastUserName', currentUserName);
                    
                } catch (error) {
                    console.warn("Gagal fetch nama, mungkin offline. Memuat nama dari cache localStorage...");
                    currentUserName = loadFromLocal('lastUserName'); 
                    if (!currentUserName) {
                        currentUserName = "Guru";
                    }
                }
                
                handleSuccessfulLogin('user1'); 
                
            } else {
                try {
                    await signInWithEmailAndPassword(auth, 'mdsr@gmail.com', '12345678');
                    
                } catch (error) {
                    console.warn("Gagal sign-in, mungkin offline.");
                    const lastUserKey = loadFromLocal('lastUserKey');
                    if (lastUserKey) {
                        console.log("Memuat aplikasi dalam mode offline berdasarkan sesi terakhir.");
                        currentUserName = loadFromLocal('lastUserName') || "Guru";
                        handleSuccessfulLogin(lastUserKey);
                    } else {
                        loginPage.classList.remove('hidden');
                        mainApp.classList.add('hidden');
                        hideLoader();
                    }
                }
            }
        });
        
        async function handleSuccessfulLogin(userKey) {
            showLoader();
            try {
                saveToLocal('lastUserKey', userKey);
                currentUserKey = userKey;
                mainApp.classList.remove('hidden');
                showToast("Login berhasil!");
                loadAllDataFromLocal();
                initializeDataListeners(); 
                setupEventListeners();
                el('filter-tanggal').value = getLocalISODate();
                handleToggleJadwalMode();
                switchPage('dashboard');
                if (dashboardUpdateInterval) clearInterval(dashboardUpdateInterval);
                dashboardUpdateInterval = setInterval(displayDashboard, 10000);
                fetchGithubToken();
            } catch (error) {
                console.error("Error detail saat login:", error);
                showAlertModal("Error", `Terjadi kesalahan setelah login: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        async function updateHeaderUI() { if (!currentUserKey) return; const displayName = currentUserName || "Pengguna"; userDisplayName.textContent = `Halo, ${displayName.charAt(0).toUpperCase() + displayName.slice(1)}`; }
        async function fetchGithubToken() { try { const token = (await get(ref(db, 'token/github'))).val(); if(token) { githubToken = token; saveToLocal('githubToken', token); } else if (!githubToken) { showAlertModal("Konfigurasi Error", "Token GitHub tidak ditemukan.", true); } } catch (error) { if (!githubToken) showAlertModal("Konfigurasi Error", "Gagal mengambil token GitHub.", true); } }
        
        function switchPage(pageId, force = false) { if (!force && hasUnsavedChanges && !el('page-presensi').classList.contains('hidden')) { showUnsavedChangesModal('changePage', pageId); return; } document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden')); el(`page-${pageId}`).classList.remove('hidden'); document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active')); document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active'); if (pageId === 'hasil-rekap') handleTerapkanRekap(); }
        
        function loadAllDataFromLocal() {
            if (!currentUserKey) return;
            const userKeyPrefix = `user_${currentUserKey}_`;
            
            allStudents = loadFromLocal(userKeyPrefix + 'siswa') || {};
            allMapel = loadFromLocal(userKeyPrefix + 'mapel') || {};
            allJadwalTerstruktur = loadFromLocal(userKeyPrefix + 'jadwal_terstruktur') || {};
            allPresensiData = loadFromLocal(userKeyPrefix + 'presensi') || {};
            allKegiatanData = loadFromLocal(userKeyPrefix + 'kegiatan') || {};
            allNilaiData = loadFromLocal(userKeyPrefix + 'nilai') || {}; 
            githubToken = loadFromLocal('githubToken');
            updateHeaderUI();
            renderStudentsTable();
            updateClassFilters();
            renderMapelList();
            updateMapelFilter();
            updateJadwalMapelFilter();
            renderJadwalTerstruktur();
            displayDashboard();
        }

        function initializeDataListeners() {
            if (!currentUserKey) return;
            const userPath = `users_data/${currentUserKey}`;
            const userKeyPrefix = `user_${currentUserKey}_`;
            
            onValue(ref(db, `${userPath}/siswa/`), (s) => { allStudents = s.val() || {}; saveToLocal(userKeyPrefix + 'siswa', allStudents); renderStudentsTable(); updateClassFilters(); displayDashboard(); });
            onValue(ref(db, `${userPath}/mapel/`), (s) => { allMapel = s.val() || {}; saveToLocal(userKeyPrefix + 'mapel', allMapel); renderMapelList(); updateMapelFilter(); updateJadwalMapelFilter(); displayDashboard(); });
            onValue(ref(db, `${userPath}/jadwal_terstruktur`), (s) => { 
                allJadwalTerstruktur = s.val() || {}; 
                saveToLocal(userKeyPrefix + 'jadwal_terstruktur', allJadwalTerstruktur); 
                renderJadwalTerstruktur(); 
                displayDashboard(); 
                // TAMBAHAN: Jadwalkan ulang notifikasi saat jadwal berubah
                scheduleAllNotifications();
            });
            onValue(ref(db, `${userPath}/jadwal`), (s) => { const d = s.val(); saveToLocal(userKeyPrefix + 'jadwal_gambar', d); const hasImage = d && d.imageUrl; jadwalImage.src = hasImage ? d.imageUrl : ''; jadwalImage.classList.toggle('hidden', !hasImage); jadwalImage.classList.toggle('cursor-pointer', hasImage); jadwalPlaceholder.classList.toggle('hidden', hasImage); jadwalUploadLabel.classList.toggle('hidden', hasImage); deleteJadwalBtn.classList.toggle('hidden', !hasImage); });
            onValue(ref(db, `${userPath}/presensi`), (s) => { allPresensiData = s.val() || {}; saveToLocal(userKeyPrefix + 'presensi', allPresensiData); displayDashboard(); });
            onValue(ref(db, `${userPath}/kegiatan`), (s) => { allKegiatanData = s.val() || {}; saveToLocal(userKeyPrefix + 'kegiatan', allKegiatanData); displayDashboard(); });
            onValue(ref(db, `${userPath}/nilai`), (s) => { allNilaiData = s.val() || {}; saveToLocal(userKeyPrefix + 'nilai', allNilaiData); });
        }
        function renderStudentsTable() { allStudentsTable.innerHTML = ''; if (Object.keys(allStudents).length === 0) { allStudentsTable.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-sub">Belum ada siswa.</td></tr>`; return; } const sortedStudents = Object.entries(allStudents).map(([id, data]) => ({ id, ...data })).sort((a, b) => a.kelas.localeCompare(b.kelas) || a.nama.localeCompare(b.nama)); allStudentsTable.dataset.fullStudents = JSON.stringify(sortedStudents); filterAllStudentsTable(); }
        function renderMapelList() { mapelListContainer.innerHTML = ''; if (Object.keys(allMapel).length === 0) { mapelListContainer.innerHTML = `<p class="text-center p-4 text-sub">Belum ada mapel.</p>`; return; } Object.entries(allMapel).forEach(([id, mapel]) => { mapelListContainer.innerHTML += `<div class="bg-white dark:bg-white dark:text-gray-800 p-3 rounded-lg flex justify-between items-center"><div><p class="font-semibold">${mapel.nama}</p><p class="text-sm text-sub dark:text-gray-600">Kelas: ${mapel.kelas}</p></div><div class="flex items-center space-x-2"><button onclick="window.showEditMapelModal('${id}')" class="p-2 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400"><i class="fa-solid fa-pencil"></i></button><button onclick="window.showDeleteMapelModal('${id}', '${mapel.nama}', '${mapel.kelas}')" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>`; }); }
        function updateClassFilters() { availableClasses.clear(); Object.values(allStudents).forEach(s => availableClasses.add(s.kelas)); const classOptionsHtml = '<option value="">Pilih Kelas</option>' + Array.from(availableClasses).sort().map(k => `<option value="${k}">${k}</option>`).join(''); el('mapel-class').innerHTML = classOptionsHtml; }
        function updateMapelFilter() { const uniqueMapelNames = new Set(Object.values(allMapel).map(m => m.nama)); const mapelOptionsHtml = '<option value="">Pilih Mapel...</option>' + Array.from(uniqueMapelNames).sort().map(name => `<option value="${name}">${name}</option>`).join(''); filterMapel.innerHTML = mapelOptionsHtml; rekapFilterMapel.innerHTML = mapelOptionsHtml; updateClassFilter('presensi'); updateClassFilter('rekap'); }
        function updateJadwalMapelFilter() { const mapelOptions = Object.entries(allMapel).map(([id, m]) => ({ id, nama: m.nama, kelas: m.kelas })).sort((a, b) => a.nama.localeCompare(b.nama) || a.kelas.localeCompare(b.kelas)); el('jadwal-mapel').innerHTML = '<option value="">Pilih Mapel & Kelas...</option>' + mapelOptions.map(m => `<option value="${m.id}">${m.nama} - ${m.kelas}</option>`).join(''); }
        function updateClassFilter(prefix) { const mapelSelect = el(prefix === 'presensi' ? 'filter-mapel' : 'rekap-filter-mapel'); const kelasSelect = el(prefix === 'presensi' ? 'filter-kelas' : 'rekap-filter-kelas'); if (!mapelSelect || !kelasSelect) return; const selectedMapel = mapelSelect.value; kelasSelect.innerHTML = '<option value="">Pilih Kelas...</option>'; if (!selectedMapel) { kelasSelect.disabled = true; return; } const classes = new Set(Object.values(allMapel).filter(m => m.nama === selectedMapel).map(m => m.kelas)); kelasSelect.innerHTML += Array.from(classes).sort().map(k => `<option value="${k}">${k}</option>`).join(''); kelasSelect.disabled = false; }
        
        function setupPreLoginEventListeners() {
            el('login-form').addEventListener('submit', async (e) => { e.preventDefault(); showLoader(); const email = el('email').value, password = el('password').value; if (!email || !password) { el('login-error').textContent = "Email & Password wajib diisi."; el('login-error').classList.remove('hidden'); hideLoader(); return; } try { await signInWithEmailAndPassword(auth, email, password); el('login-error').classList.add('hidden'); el('password').value = ''; } catch (error) { el('login-error').textContent = "Email atau Password salah."; el('login-error').classList.remove('hidden'); } finally { hideLoader(); } });
        }

        function setupEventListeners() {
            burgerMenuBtn.addEventListener('click', () => dropdownMenu.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    document.querySelectorAll('.presensi-dropdown').forEach(d => {
                        d.classList.add('hidden');
                    });
                }
                if (!burgerMenuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
            
            el('bebas-presensi-toggle').addEventListener('change', (e) => { 
                isBebasPresensi = e.target.checked; 
                displayDashboard(); 
                // TAMBAHAN: Perbarui notifikasi berdasarkan toggle
                scheduleAllNotifications();
            });
            
            navLinks.forEach(link => { link.addEventListener('click', () => switchPage(link.dataset.page)); });
            addStudentForm.addEventListener('submit', handleAddStudent);
            csvUploadInput.addEventListener('change', handleCsvUpload);
            downloadTemplateBtn.addEventListener('click', handleDownloadTemplate);
            deleteAllStudentsBtn.addEventListener('click', showDeleteAllStudentsConfirmationModal);
            addMapelForm.addEventListener('submit', handleAddMapel);
            toggleModeBtn.addEventListener('click', handleToggleMode);
            terapkanBtn.addEventListener('click', () => handleTerapkanFilter(false));
            deleteDailyDataBtn.addEventListener('click', showDeleteDailyDataConfirmationModal);
            kegiatanInput.addEventListener('change', handleSaveKegiatan);
            saveAllBtn.addEventListener('click', handleSaveAllData);
            terapkanRekapBtn.addEventListener('click', handleTerapkanRekap);
            filterMapel.addEventListener('change', () => updateClassFilter('presensi'));
            rekapFilterMapel.addEventListener('change', () => updateClassFilter('rekap'));
            jadwalUploadInput.addEventListener('change', handleJadwalUpload);
            deleteJadwalBtn.addEventListener('click', showDeleteJadwalConfirmation);
            rekapDownloadDropdownBtn.addEventListener('click', toggleRekapDownloadDropdown);
            downloadCsvBtn.addEventListener('click', handleDownloadCSV);
            printRekapBtn.addEventListener('click', handlePrintRekap);
            addJadwalForm.addEventListener('submit', handleAddJadwal);
            toggleJadwalModeBtn.addEventListener('click', handleToggleJadwalMode);
            kegiatanHistoryToggleMore.addEventListener('click', () => { const isPartial = kegiatanHistoryToggleMore.dataset.state === 'partial'; kegiatanHistoryToggleMore.dataset.state = isPartial ? 'full' : 'partial'; renderKegiatanHistory(JSON.parse(kegiatanHistoryList.dataset.fullhistory || '[]')); });
            searchPresensiStudentInput.addEventListener('input', filterPresensiTable);
            searchAllStudentsInput.addEventListener('input', filterAllStudentsTable);
            searchRekapStudentInput.addEventListener('input', filterRekapTable);
            jadwalImage.addEventListener('click', () => { if (jadwalImage.src) { fullscreenImage.src = jadwalImage.src; imageViewerModal.classList.remove('hidden'); } });
            closeImageViewerBtn.addEventListener('click', () => imageViewerModal.classList.add('hidden'));
            imageViewerModal.addEventListener('click', (e) => { if (e.target === imageViewerModal) imageViewerModal.classList.add('hidden'); });
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
            if (!navigator.onLine) handleOfflineStatus();
        }

        function handleAddStudent(e) { e.preventDefault(); const nama = el('student-name').value.trim().toUpperCase(), kelas = el('student-class').value.trim().toUpperCase(); if (!nama || !kelas) return showToast("Nama dan kelas wajib diisi.", true); showLoader(); set(push(ref(db, `users_data/${currentUserKey}/siswa`)), { nama, kelas }).then(() => { showToast("Siswa berhasil ditambahkan."); addStudentForm.reset(); refreshRekapTableIfNeeded(); }).catch(err => showAlertModal("Error", `Gagal: ${err.message}`, true)).finally(hideLoader); }
        function handleCsvUpload(e) { const file = e.target.files[0]; if (!file) return; showLoader(); Papa.parse(file, { header: false, skipEmptyLines: true, delimiter: ";", complete: (results) => { const data = {}; results.data.slice(1).forEach(row => { if (Array.isArray(row) && row.length > 2) { const nama = row[1]?.trim().toUpperCase(), kelas = row[2]?.trim().toUpperCase(); if (nama && kelas) data[push(ref(db, `users_data/${currentUserKey}/siswa`)).key] = { nama, kelas }; } }); if (Object.keys(data).length > 0) { update(ref(db, `users_data/${currentUserKey}/siswa`), data).then(() => { showToast(`${Object.keys(data).length} siswa diunggah.`); refreshRekapTableIfNeeded(); }).catch(err => showAlertModal("Error", `Gagal: ${err.message}`, true)).finally(hideLoader); } else { showAlertModal("Gagal", "Tidak ada data valid.", true); hideLoader(); } csvUploadInput.value = ''; }, error: (err) => { showAlertModal("Error", `Gagal: ${err.message}`, true); hideLoader(); } }); }
        function handleDownloadTemplate() { window.open('https://drive.google.com/uc?export=download&id=1itiQBK37vt58iorp2ZIUtKSeu19Z7Dhq', '_blank'); }
        function handleAddMapel(e) { e.preventDefault(); const nama = el('mapel-name').value.trim().toUpperCase(), kelas = el('mapel-class').value.toUpperCase(); if (!nama || !kelas) return showToast("Nama mapel dan kelas wajib diisi.", true); showLoader(); set(push(ref(db, `users_data/${currentUserKey}/mapel`)), { nama, kelas }).then(() => { showToast("Mapel berhasil ditambahkan."); addMapelForm.reset(); }).catch(err => showAlertModal("Error", `Gagal: ${err.message}`, true)).finally(hideLoader); }
        function handleToggleMode() { currentMode = currentMode === 'presensi' ? 'nilai' : 'presensi'; const isNilai = currentMode === 'nilai'; toggleModeSwitch.style.transform = isNilai ? 'translateX(1.25rem)' : 'translateX(0)'; toggleModeBtn.classList.toggle('bg-blue-600', isNilai); toggleModeBtn.classList.toggle('bg-gray-200', !isNilai); modeLabel.textContent = `Mode: ${isNilai ? 'Nilai' : 'Presensi'}`; if (!contentArea.classList.contains('hidden')) handleTerapkanFilter(true); }
        
        async function handleSaveKegiatan() { 
            const selectedMapelName = filterMapel.value, kelas = filterKelas.value, tanggal = filterTanggal.value; 
            let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas); 
            if (!mapelId || !kelas || !tanggal) return; 
            
            const statusEl = el('kegiatan-save-status');
            statusEl.textContent = 'Menyimpan...';
            statusEl.classList.remove('hidden');

            const dataPath = `users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}/${tanggal}`;
            const dataToSave = { deskripsi: kegiatanInput.value.trim() };

            if (navigator.onLine) {
                try {
                    await set(ref(db, dataPath), dataToSave);
                    statusEl.textContent = 'Tersimpan otomatis!';
                    setTimeout(() => statusEl.classList.add('hidden'), 2500); 
                } catch(err) {
                    showAlertModal("Error", `Gagal menyimpan: ${err.message}`, true)
                    statusEl.textContent = 'Gagal menyimpan!';
                    setTimeout(() => statusEl.classList.add('hidden'), 2500); 
                }
            } else {
                const pending = loadFromLocal('pending-updates') || {};
                pending[dataPath] = dataToSave;
                saveToLocal('pending-updates', pending);
                statusEl.textContent = 'Tersimpan (offline)';
                setTimeout(() => statusEl.classList.add('hidden'), 2500); 
                handleOfflineStatus();
            }
        }
        
        function abbreviateName(fullName) {
            if (!fullName) return '';
            const words = fullName.split(' ').filter(w => w);
            if (words.length <= 2) return fullName;
            const firstTwo = words.slice(0, 2).join(' ');
            const initials = words.slice(2).map(w => `${w.charAt(0)}.`).join('');
            return `${firstTwo} ${initials}`;
        }

        function formatDateForHeader(isoDate) {
            const date = new Date(isoDate + 'T00:00:00');
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            return `${days[date.getDay()]}, ${date.getDate()}/${date.getMonth() + 1}`;
        }

        function filterPresensiTable() {
            const query = searchPresensiStudentInput.value.toLowerCase();
            const table = studentTableContainer.querySelector('table');
            if (!table) return;
            const rows = table.querySelector('tbody').querySelectorAll('tr.student-row');
            rows.forEach(row => {
                const fullName = row.dataset.fullName.toLowerCase();
                const noteRow = row.nextElementSibling;
                const isVisible = fullName.includes(query);
                row.classList.toggle('hidden', !isVisible);
                if (noteRow && noteRow.classList.contains('note-row')) {
                    noteRow.classList.toggle('hidden', !isVisible || noteRow.dataset.visible === 'false');
                }
            });
        }

        async function handleTerapkanFilter(force = false) {
            if (!force && hasUnsavedChanges) return showUnsavedChangesModal('applyFilter');
            const selectedMapelName = filterMapel.value, kelas = filterKelas.value, tanggal = filterTanggal.value;
            if (!selectedMapelName || !kelas || !tanggal) return showToast("Filter harus lengkap.", true);
            
            let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas);
            if (!mapelId) return showAlertModal("Error", "Kombinasi Mapel & Kelas tidak ditemukan.", true);
            
            showLoader();
            contentArea.classList.remove('hidden');
            studentTableContainer.innerHTML = '<p class="col-span-full text-center text-sub">Memuat data presensi...</p>';
            
            await fetchAndRenderKegiatanHistory(kelas, mapelId);
            
            // DIGANTI: Ambil kegiatan dari data global, bukan 'get()'
            const kegiatan = allKegiatanData[kelas]?.[mapelId]?.[tanggal];
            kegiatanInput.value = kegiatan?.deskripsi || '';

            const studentsInClass = Object.entries(allStudents)
                .filter(([, s]) => s.kelas === kelas)
                .map(([id, d]) => ({ id, ...d }))
                .sort((a, b) => a.nama.localeCompare(b.nama));
            
            currentPresensiStudentsData = studentsInClass;

            if (studentsInClass.length === 0) {
                studentTableContainer.innerHTML = `<p class="col-span-full text-center text-sub">Tidak ada siswa di kelas ${kelas}.</p>`;
                hideLoader();
                presensiSearchContainer.classList.add('hidden');
                return;
            }

            // DIGANTI: Ambil presensi dan nilai dari data global, bukan 'get()'
            const allHistoricalPresensi = allPresensiData[kelas]?.[mapelId] || {};
            const allHistoricalNilai = allNilaiData[kelas]?.[mapelId] || {};

            const dateSet = new Set(Object.keys(allHistoricalPresensi));
            Object.keys(allHistoricalNilai).forEach(d => dateSet.add(d));
            
            const dateHeaders = [tanggal]; 
            
            const otherDates = Array.from(dateSet)
                .filter(d => d !== tanggal) 
                .sort()
                .reverse(); 
            
            dateHeaders.push(...otherDates);

            renderPresensiTable(studentsInClass, dateHeaders, allHistoricalPresensi, allHistoricalNilai);

            presensiSearchContainer.classList.remove('hidden');
            searchPresensiStudentInput.value = '';
            hasUnsavedChanges = false;
            unsavedChanges = {};
            updateSaveButtonState();
            hideLoader();
        }

        const presensiStatusInfo = {
            Hadir: { symbol: 'H', color: 'bg-[#F0F8FF] text-black', modalColor: 'bg-[#F0F8FF] hover:bg-sky-200 text-black' },
            Sakit: { symbol: 'S', color: 'bg-orange-300 text-black', modalColor: 'bg-orange-300 hover:bg-orange-400 text-black' },
            Izin: { symbol: 'I', color: 'bg-green-300 text-black', modalColor: 'bg-green-300 hover:bg-green-400 text-black' },
            Alpa: { symbol: 'A', color: 'bg-red-300 text-black', modalColor: 'bg-red-300 hover:bg-red-400 text-black' }
        };

        function renderPresensiTable(students, dates, presensiData, nilaiData) {
            const mainDate = filterTanggal.value;
            let tableHTML = `<table class="w-full text-sm presensi-table whitespace-nowrap"><thead style="background-color: #F0F8FF;" class="text-black sticky top-0 z-10"><tr><th>No</th><th>Nama Lengkap</th>`;
            dates.forEach(date => {
                const isMainDate = date === mainDate;
                const headerClass = isMainDate ? '' : 'vertical-th';
                const fontWeightClass = isMainDate ? 'font-bold' : '';
                tableHTML += `<th class="${headerClass} ${fontWeightClass}">${formatDateForHeader(date)}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            if (students.length === 0) {
                tableHTML += `<tr><td colspan="${dates.length + 2}" class="text-center p-4">Tidak ada siswa di kelas ini.</td></tr>`;
            } else {
                students.forEach((student, index) => {
                    
                    tableHTML += `<tr class="student-row" data-student-id="${student.id}" data-full-name="${student.nama}">
                        <td>${index + 1}</td>
                        <td class="nama-col">${abbreviateName(student.nama)}</td>
                        `;

                    dates.forEach(date => {
                        const pData = presensiData[date]?.[student.id] || {};
                        const nData = nilaiData[date]?.[student.id] || {};
                        const status = pData.status || 'Hadir';
                        const nilai = (nData.nilai !== undefined && nData.nilai !== null) ? nData.nilai : '';

                        let cellContent = '';
                        
                        if (date === mainDate) {
                            if (currentMode === 'presensi') {
                                const info = presensiStatusInfo[status];
                                cellContent = `<div class="relative inline-block text-left w-full">
                                    <button
                                        type="button"
                                        onclick="window.togglePresensiDropdown(event, '${student.id}', '${date}')"
                                        id="btn-${student.id}-${date}"
                                        class="w-full text-center p-2 rounded-md font-bold transition-colors ${info.color}"
                                    >
                                        ${info.symbol}
                                    </button>
                                    <div
                                        id="dropdown-${student.id}-${date}"
                                        class="presensi-dropdown hidden origin-top-right absolute right-0 mt-2 w-full rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-20"
                                    >
                                        <div class="py-1 flex flex-col" role="menu" aria-orientation="vertical">
                                            ${Object.keys(presensiStatusInfo).map(statusName => {
                                                const s_info = presensiStatusInfo[statusName];
                                                return `<button
                                                            onclick="window.selectPresensiStatus('${student.id}', '${date}', '${statusName}')"
                                                            class="w-full text-left px-4 py-2 text-sm font-bold transition-colors ${s_info.modalColor}"
                                                            role="menuitem"
                                                        >
                                                            ${statusName}
                                                        </button>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>`;
                            } else {
                                cellContent = `<input type="number" min="0" max="100" value="${nilai}" oninput="window.updateNilai(this, '${student.id}', '${date}')" placeholder="-">`;
                            }
                        } else {
                            const statusSymbols = { Hadir: '•', Sakit: 'S', Izin: 'I', Alpa: 'A' };
                            const statusColors = { S: 'text-orange-600', I: 'text-green-600', A: 'text-red-600' };
                            const historicalStatus = presensiData[date]?.[student.id]?.status;
                            const historicalNilai = nilaiData[date]?.[student.id]?.nilai;

                            if (historicalStatus || historicalNilai !== undefined) {
                                const symbol = historicalStatus ? statusSymbols[historicalStatus] || '?' : '•';
                                const colorClass = historicalStatus ? statusColors[historicalStatus] || '' : '';
                                const nilaiHtml = (historicalNilai !== undefined && historicalNilai !== null) ? `<br><span class="font-bold text-xs">${historicalNilai}</span>` : '';
                                cellContent = `<span class="${colorClass}">${symbol}</span>${nilaiHtml}`;
                            } else {
                                cellContent = '-';
                            }
                        }
                        tableHTML += `<td>${cellContent}</td>`;
                    });
                    tableHTML += `</tr>`;
                    
                });
            }
            tableHTML += `</tbody></table>`;
            studentTableContainer.innerHTML = tableHTML;
        }

        function updateSaveButtonState() {
            saveAllBtn.disabled = !hasUnsavedChanges;
        }

        function updateChange(studentId, date, data) {
            if (!unsavedChanges[studentId]) unsavedChanges[studentId] = {};
            if (!unsavedChanges[studentId][date]) unsavedChanges[studentId][date] = {};
            Object.assign(unsavedChanges[studentId][date], data);
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }
        
        window.togglePresensiDropdown = (event, studentId, date) => {
            event.stopPropagation();
            const dropdown = el(`dropdown-${studentId}-${date}`);
            const isHidden = dropdown.classList.contains('hidden');
            document.querySelectorAll('.presensi-dropdown').forEach(d => {
                if (d.id !== dropdown.id) {
                    d.classList.add('hidden');
                }
            });
            dropdown.classList.toggle('hidden', !isHidden);
        };

        window.selectPresensiStatus = (studentId, date, newStatus) => {
            updateChange(studentId, date, { status: newStatus });
            const button = el(`btn-${studentId}-${date}`);
            const dropdown = el(`dropdown-${studentId}-${date}`);
            if (button) {
                const info = presensiStatusInfo[newStatus];
                button.textContent = info.symbol;
                button.className = 'w-full text-center p-2 rounded-md font-bold transition-colors';
                info.color.split(' ').forEach(cls => { if(cls) button.classList.add(cls); });
            }
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        };

        window.updateNilai = (input, studentId, date) => {
            const nVal = input.value.trim();
            if (nVal === '') {
                updateChange(studentId, date, { nilai: null }); 
            } else {
                updateChange(studentId, date, { nilai: nVal }); 
            }
        };
        
        async function handleSaveAllData() {
            const selectedMapelName = filterMapel.value, kelas = filterKelas.value;
            if (!selectedMapelName || !kelas) return showAlertModal("Error", "Filter tidak lengkap.", true);
            let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas);
            if (!mapelId) return showAlertModal("Error", "Kombinasi Mapel & Kelas tidak valid.", true);

            showLoader();
            const updates = {};
            let hasInvalidGrade = false;

            // Membangun 'updates' dari data yang sudah ada di database (untuk offline)
            const allCurrentPresensi = allPresensiData[kelas]?.[mapelId] || {};
            const allCurrentNilai = allNilaiData[kelas]?.[mapelId] || {};

            for (const studentId in unsavedChanges) {
                for (const date in unsavedChanges[studentId]) {
                    const changes = unsavedChanges[studentId][date];
                    
                    if (changes.hasOwnProperty('status')) {
                        const presensiPath = `users_data/${currentUserKey}/presensi/${kelas}/${mapelId}/${date}/${studentId}`;
                        // Ambil data dari cache global, bukan 'get()'
                        const currentData = allCurrentPresensi[date]?.[studentId] || { status: 'Hadir' };
                        const finalData = { ...currentData };
                        if (changes.hasOwnProperty('status')) finalData.status = changes.status;
                        
                        updates[presensiPath] = finalData;
                    }

                    if (changes.hasOwnProperty('nilai')) {
                        const nilaiPath = `users_data/${currentUserKey}/nilai/${kelas}/${mapelId}/${date}/${studentId}`;
                        
                        if (changes.nilai === null) {
                            updates[nilaiPath] = null;
                        } else {
                            const nVal = String(changes.nilai).trim(); 
                            const n = parseFloat(nVal.replace(',', '.'));
                            if (!isNaN(n) && n >= 0 && n <= 100) {
                                updates[nilaiPath] = { nilai: n };
                            } else {
                                hasInvalidGrade = true;
                            }
                        }
                    }
                }
            }

            if (hasInvalidGrade) {
                hideLoader();
                return showAlertModal("Gagal", "Nilai harus antara 0-100.", true);
            }

            if (Object.keys(updates).length === 0) {
                hideLoader();
                return showToast("Tidak ada perubahan untuk disimpan.", true);
            }

            if (navigator.onLine) {
                try {
                    await update(ref(db), updates);
                    showToast("Semua perubahan disimpan.");
                    hasUnsavedChanges = false;
                    unsavedChanges = {};
                    updateSaveButtonState();
                    handleTerapkanFilter(true);
                } catch (err) {
                    hideLoader();
                    showAlertModal("Error", `Gagal menyimpan: ${err.message}`, true);
                }
            } else {
                const pending = loadFromLocal('pending-updates') || {};
                Object.assign(pending, updates);
                saveToLocal('pending-updates', pending);
                showToast("Offline. Perubahan disimpan lokal.");
                hasUnsavedChanges = false;
                unsavedChanges = {};
                updateSaveButtonState();
                handleTerapkanFilter(true); // Memuat ulang tabel dari data (sekarang offline)
            }
        }
        
        async function handleJadwalUpload(e) { const file = e.target.files[0]; if (!file || !currentUserKey || !currentUserName) return showAlertModal("Error", "Info pengguna tidak lengkap.", true); if (!githubToken) return showAlertModal("Error", "Token GitHub tidak ditemukan.", true); if (!file.type.startsWith('image/')) return showAlertModal("Error", "Pilih file gambar.", true); showLoader(); const sanitizedUserName = sanitizeForPath(currentUserName); const filePath = `schedules/${currentUserKey}/${sanitizedUserName}/schedule.jpg`; const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`; try { const content = await fileToBase64(file); let sha = null; try { const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${githubToken}` } }); if (res.ok) sha = (await res.json()).sha; } catch (e) {} const payload = { message: `Update jadwal ${new Date().toISOString()}`, content, sha }; const res = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!res.ok) throw new Error((await res.json()).message); const data = await res.json(); await set(ref(db, `users_data/${currentUserKey}/jadwal`), { imageUrl: data.content.download_url }); showToast("Jadwal berhasil diunggah."); } catch (error) { showAlertModal("Gagal", `Gagal mengunggah: ${error.message}`, true); } finally { jadwalUploadInput.value = ''; hideLoader(); } }
        function showDeleteJadwalConfirmation() { openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Jadwal?</h3><p class="mb-6">Yakin ingin menghapus gambar jadwal?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteJadwal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`); }
        async function handleDeleteJadwal() { if (!currentUserKey || !currentUserName || !githubToken) return showAlertModal("Error", "Info tidak lengkap.", true); closeModal(); showLoader(); const sanitizedUserName = sanitizeForPath(currentUserName); const filePath = `schedules/${currentUserKey}/${sanitizedUserName}/schedule.jpg`; const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`; try { const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${githubToken}` } }); if (res.ok) { const { sha } = await res.json(); const delRes = await fetch(apiUrl, { method: 'DELETE', headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify({ message: `Hapus jadwal ${new Date().toISOString()}`, sha }) }); if (!delRes.ok) throw new Error((await delRes.json()).message); } await remove(ref(db, `users_data/${currentUserKey}/jadwal`)); showToast("Jadwal berhasil dihapus."); } catch (error) { showAlertModal("Gagal", `Gagal menghapus: ${error.message}`, true); } finally { hideLoader(); } };
        window.showEditStudentModal=(s)=>{const d=allStudents[s];let c='';Array.from(availableClasses).sort().forEach(k=>{c+=`<option value="${k}" ${k===d.kelas?'selected':''}>${k}</option>`;});openModal(`<h3 class="text-lg font-bold mb-4">Edit Siswa</h3><div class="mb-4"><label>Nama</label><input type="text" id="edit-student-name" value="${d.nama}" class="w-full mt-1 p-2 input-bg rounded-lg"></div><div class="mb-6"><label>Kelas</label><select id="edit-student-class" class="w-full mt-1 p-2 input-bg rounded-lg">${c}</select></div><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleEditStudent('${s}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`);};window.handleEditStudent=(s)=>{const n=el('edit-student-name').value.trim().toUpperCase(),c=el('edit-student-class').value.toUpperCase();if(!n||!c)return showToast("Nama & kelas wajib.",true);showLoader();update(ref(db,`users_data/${currentUserKey}/siswa/${s}`),{nama:n,kelas:c}).then(()=>{showToast("Data siswa diperbarui.");closeModal();refreshRekapTableIfNeeded();}).catch(e=>showAlertModal("Error",e.message,true)).finally(hideLoader);};window.showDeleteStudentModal=(s,n)=>{openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Siswa?</h3><p class="mb-6">Yakin hapus <b>${n}</b> dan semua datanya?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteStudent('${s}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`);};window.handleDeleteStudent=async(s)=>{showLoader();try{const u={};u[`users_data/${currentUserKey}/siswa/${s}`]=null;const[p,n]=await Promise.all([get(ref(db,`users_data/${currentUserKey}/presensi`)),get(ref(db,`users_data/${currentUserKey}/nilai`))]);const ap=p.val()||{},an=n.val()||{};for(const k in ap){for(const m in ap[k]){if(ap[k][m][s])u[`users_data/${currentUserKey}/presensi/${k}/${m}/${s}`]=null;}}for(const k in an){for(const m in an[k]){if(an[k][m][s])u[`users_data/${currentUserKey}/nilai/${k}/${m}/${s}`]=null;}}await update(ref(db),u);showToast("Siswa dihapus.");closeModal();refreshRekapTableIfNeeded();}catch(e){showAlertModal("Error",e.message,true);}finally{hideLoader();}};
        window.showEditMapelModal=(m)=>{const d=allMapel[m];let c='';Array.from(availableClasses).sort().forEach(k=>{c+=`<option value="${k}" ${k===d.kelas?'selected':''}>${k}</option>`;});openModal(`<h3 class="text-lg font-bold mb-4">Edit Mapel</h3><div class="mb-4"><label>Nama</label><input type="text" id="edit-mapel-name" value="${d.nama}" class="w-full mt-1 p-2 input-bg rounded-lg"></div><div class="mb-6"><label>Kelas</label><select id="edit-mapel-class" class="w-full mt-1 p-2 input-bg rounded-lg">${c}</select></div><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleEditMapel('${m}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`);};window.handleEditMapel=(m)=>{const n=el('edit-mapel-name').value.trim().toUpperCase(),c=el('edit-mapel-class').value.toUpperCase();if(!n||!c)return showToast("Nama & kelas wajib.",true);showLoader();update(ref(db,`users_data/${currentUserKey}/mapel/${m}`),{nama:n,kelas:c}).then(()=>{showToast("Mapel diperbarui.");closeModal();}).catch(e=>showAlertModal("Error",e.message,true)).finally(hideLoader);};window.showDeleteMapelModal=(m,n,c)=>{openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Mapel?</h3><p class="mb-6">Yakin hapus <b>${n} (${c})</b> dan semua datanya?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteMapel('${m}','${c}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`);};window.handleDeleteMapel=async(m,c)=>{showLoader();try{const u={};u[`users_data/${currentUserKey}/mapel/${m}`]=null;u[`users_data/${currentUserKey}/presensi/${c}/${m}`]=null;u[`users_data/${currentUserKey}/nilai/${c}/${m}`]=null;u[`users_data/${currentUserKey}/kegiatan/${c}/${m}`]=null;const s={};for(const d in allJadwalTerstruktur){for(const i in allJadwalTerstruktur[d]){if(allJadwalTerstruktur[d][i].mapelId===m)s[`users_data/${currentUserKey}/jadwal_terstruktur/${d}/${i}`]=null;}}await update(ref(db),s);await update(ref(db),u);showToast("Mapel dihapus.");closeModal();refreshRekapTableIfNeeded();}catch(e){showAlertModal("Error",e.message,true);}finally{hideLoader();}};
        function renderKegiatanHistory(historyData) { kegiatanHistoryList.innerHTML = ''; if (historyData.length === 0) { kegiatanHistoryList.innerHTML = '<p class="text-center text-gray-400">Tidak ada riwayat.</p>'; kegiatanHistoryToggleMore.classList.add('hidden'); return; } kegiatanHistoryList.dataset.fullhistory = JSON.stringify(historyData); const isPartial = kegiatanHistoryToggleMore.dataset.state === 'partial'; const dataToShow = isPartial ? historyData.slice(0, 2) : historyData; dataToShow.forEach(item => { const [y,m,d] = item.tanggal.split('-'), date = new Date(y,m-1,d); kegiatanHistoryList.innerHTML += `<div class="p-2 border-b border-yellow-200 dark:border-yellow-800"><p class="font-semibold">${formatDateToIndonesian(date)}</p><p class="text-sub">${item.deskripsi}</p></div>`; }); kegiatanHistoryToggleMore.classList.toggle('hidden', historyData.length <= 2); kegiatanHistoryToggleMore.innerHTML = isPartial ? 'Lainnya &darr;' : 'Ringkas &uarr;'; }
        
        async function fetchAndRenderKegiatanHistory(kelas, mapelId) { 
            kegiatanHistoryList.innerHTML = '<p>Memuat...</p>'; 
            // DIGANTI: Ambil kegiatan dari data global, bukan 'get()'
            const allKegiatan = allKegiatanData[kelas]?.[mapelId] || {}; 
            const historyList = Object.entries(allKegiatan).filter(([,d]) => d.deskripsi).map(([t,d]) => ({ tanggal: t, deskripsi: d.deskripsi })).sort((a,b) => b.tanggal.localeCompare(a.tanggal)); 
            renderKegiatanHistory(historyList); 
        }
        
        async function handleTerapkanRekap() {
            const selectedMapelName = rekapFilterMapel.value, kelas = rekapFilterKelas.value;
            if (!selectedMapelName || !kelas) {
                rekapDynamicTableContent.innerHTML = '<p class="text-center text-sub">Pilih Mapel & Kelas.</p>';
                rekapSearchContainer.classList.add('hidden');
                rekapDownloadDropdownBtn.classList.add('hidden');
                return;
            }
            let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas);
            if (!mapelId) return showAlertModal("Error", "Kombinasi tidak ditemukan.", true);
            
            showLoader();
            rekapDynamicTableContent.innerHTML = '<p class="text-center text-sub">Memuat...</p>';
            
            const [presensi, nilai, kegiatan] = await Promise.all([
                get(ref(db, `users_data/${currentUserKey}/presensi/${kelas}/${mapelId}`)),
                get(ref(db, `users_data/${currentUserKey}/nilai/${kelas}/${mapelId}`)),
                get(ref(db, `users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}`)) 
            ]);
            
            currentRekapData = {
                presensi: presensi.val() || {},
                nilai: nilai.val() || {},
                kegiatan: kegiatan.val() || {}, 
                kelas
            };
            
            rekapSearchContainer.classList.remove('hidden');
            rekapDownloadDropdownBtn.classList.remove('hidden');
            searchRekapStudentInput.value = '';
            filterRekapTable(); 
            hideLoader();
        }
        
        function toggleRekapDownloadDropdown() { rekapDownloadOptions.classList.toggle('hidden'); }
        function handleDownloadCSV() {
            rekapDownloadOptions.classList.add('hidden');
            const table = rekapDynamicTableContent.querySelector('table');
            if (!table) return showToast("Tidak ada data.", true);
            
            const headerRow1Els = table.rows[0].querySelectorAll('th');
            const headerRow1 = Array.from(headerRow1Els)
                                    .map(th => `"${th.textContent.trim()}"`).join(';');

            const paddingCount = headerRow1Els.length > 0 ? headerRow1Els.length - 1 : 0; 
            const header2Padding = Array(paddingCount).fill('""').join(';'); 

            const headerRow2Data = Array.from(table.rows[1].querySelectorAll('th'))
                                    .map(th => `"${th.textContent.trim()}"`).join(';');
            
            const finalHeaderRow2 = header2Padding + (paddingCount > 0 ? ';' : '') + headerRow2Data;
            
            let csv = [headerRow1, finalHeaderRow2];
            
            for (let i = 2; i < table.rows.length; i++) {
                const rowData = Array.from(table.rows[i].querySelectorAll('td')).map(td => {
                    let cellText = td.textContent.trim().replace(/\s*\n\s*/g, ' ').trim();
                    const isKegiatanRow = (i === table.rows.length - 1);
                    
                    if (!isKegiatanRow) {
                        const gradeMatch = cellText.match(/([\d\.]+)$/);
                        if (gradeMatch) {
                            cellText = gradeMatch[1];
                        } else if (cellText === '•') {
                            cellText = '-';
                        }
                    }
                    
                    return `"${cellText}"`;
                });
                
                csv.push(rowData.join(';'));
            }
            
            const blob = new Blob(["\uFEFF" + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const mapelName = rekapFilterMapel.value;
            const kelasName = rekapFilterKelas.value;
            a.download = `rekap_${mapelName.replace(/\s/g, '_')}_${kelasName}.csv` || 'rekap.csv';
            
            a.click();
            URL.revokeObjectURL(url);
            showToast("CSV diunduh.");
        }
        function handlePrintRekap() { 
            rekapDownloadOptions.classList.add('hidden'); 
            const content = rekapDynamicTableContent.innerHTML; 
            if (!content || content.includes('Tidak ada data')) return showToast("Tidak ada data.", true); 
            const pW = window.open('', '', 'height=600,width=800'); 
            
            pW.document.write(`<html><head><title>Cetak Rekap</title><style>body{font-family:Inter,sans-serif;margin:20px;font-size:9px;}h1{font-size:16px;}table{width:100%;border-collapse:collapse;margin-top:15px;font-size:9px;}th,td{border:1px solid #e2e8f0;padding:4px;}th{background-color:#f1f5f9}.vertical-th{writing-mode:vertical-rl;transform:rotate(180deg)}@media print{body{-webkit-print-color-adjust:exact}th{background-color:#f1f5f9!important}}</style></head><body><h1>Rekapitulasi</h1>`); 
            
            pW.document.write(content); 
            pW.document.write('</body></html>'); 
            pW.document.close(); 
            pW.print(); 
        }
        function refreshRekapTableIfNeeded() { const rekapPage = el('page-hasil-rekap'); if (!rekapPage.classList.contains('hidden') && rekapFilterMapel.value) handleTerapkanRekap(); }
        function showDeleteAllStudentsConfirmationModal() { const content = `<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Semua Data?</h3><p class="mb-4">Tindakan ini akan **menghapus semua data siswa, presensi, nilai, mapel, dan jadwal secara permanen!**</p><p class="mb-6">Masukkan password Anda:</p><div class="mb-4"><label for="confirm-password">Password</label><input type="password" id="confirm-password" class="w-full mt-1 p-2 input-bg rounded-lg" required><p id="confirm-password-error" class="text-red-500 mt-2 hidden"></p></div><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button id="confirm-delete-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus Semua</button></div>`; openModal(content); el('confirm-delete-all-btn').addEventListener('click', handleDeleteAllStudents); }
        async function handleDeleteAllStudents() {
            const pw = el('confirm-password').value, errEl = el('confirm-password-error');
            if (!pw) { errEl.textContent = "Password wajib diisi."; errEl.classList.remove('hidden'); return; }
            errEl.classList.add('hidden');
            showLoader();
            const user = auth.currentUser;
            if (!user) { closeModal(); hideLoader(); return showAlertModal("Gagal", "Tidak terautentikasi.", true); }
            try {
                await reauthenticateWithCredential(user, EmailAuthProvider.credential(user.email, pw));
                await remove(ref(db, `users_data/${currentUserKey}`));
                showToast("Semua data berhasil dihapus.");
                closeModal();
                allStudents = {}; allMapel = {}; allJadwalTerstruktur = {};
                availableClasses.clear();
                currentPresensiStudentsData = [];
                
                currentRekapData = { presensi: {}, nilai: {}, kegiatan: {}, kelas: '' };
                renderStudentsTable(); renderMapelList(); updateMapelFilter(); updateClassFilters();
                studentTableContainer.innerHTML = '';
                rekapDynamicTableContent.innerHTML = '';
                contentArea.classList.add('hidden');
                kegiatanInput.value = '';
            } catch (error) {
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errEl.textContent = "Password salah."; errEl.classList.remove('hidden');
                } else {
                    showAlertModal("Error", `Gagal menghapus: ${error.message}`, true);
                }
            } finally {
                hideLoader();
            }
        }
        function showDeleteDailyDataConfirmationModal() { const mapel = filterMapel.value, kelas = filterKelas.value, tgl = filterTanggal.value; if (!mapel || !kelas || !tgl) return showToast("Filter harus lengkap.", true); const date = new Date(tgl + 'T00:00:00'); const content = `<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Data Hari Ini?</h3><p class="mb-6">Yakin ingin menghapus data <b>${mapel} (${kelas})</b> pada <b>${formatDateToIndonesian(date)}</b>?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteDailyData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`; openModal(content); }
        async function handleDeleteDailyData() { const mapel = filterMapel.value, kelas = filterKelas.value, tgl = filterTanggal.value; let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === mapel && allMapel[id].kelas === kelas); if (!mapelId) return showAlertModal("Error", "Gagal menemukan data.", true); closeModal(); showLoader(); try { const updates = {}; updates[`users_data/${currentUserKey}/presensi/${kelas}/${mapelId}/${tgl}`] = null; updates[`users_data/${currentUserKey}/nilai/${kelas}/${mapelId}/${tgl}`] = null; updates[`users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}/${tgl}`] = null; await update(ref(db), updates); showToast("Data hari ini dihapus."); handleTerapkanFilter(true); } catch (err) { showAlertModal("Error", `Gagal: ${err.message}`, true); } finally { hideLoader(); } }
        
        async function handleAddJadwal(e) { e.preventDefault(); const hari = el('jadwal-hari').value, jam_mulai = el('jadwal-jam-mulai').value, jam_selesai = el('jadwal-jam-selesai').value, mapelId = el('jadwal-mapel').value; if (!hari || !jam_mulai || !jam_selesai || !mapelId) return showToast("Semua kolom wajib diisi.", true); if (jam_mulai >= jam_selesai) return showToast("Jam mulai harus sebelum jam selesai.", true); showLoader(); const mapelData = allMapel[mapelId]; const newScheduleData = { jam_mulai, jam_selesai, mapelId, mapelNama: mapelData.nama, kelas: mapelData.kelas }; const newScheduleRef = push(ref(db, `users_data/${currentUserKey}/jadwal_terstruktur/${hari}`)); try { await set(newScheduleRef, newScheduleData); showToast("Jadwal berhasil ditambahkan."); addJadwalForm.reset(); } catch (err) { showAlertModal("Error", `Gagal menambahkan jadwal: ${err.message}`, true); } finally { hideLoader(); } }
        function renderJadwalTerstruktur() { jadwalTerstrukturContainer.innerHTML = ''; const daysOrder = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu']; daysOrder.forEach(day => { const daySchedule = allJadwalTerstruktur[day]; if (daySchedule) { const dayName = day.charAt(0).toUpperCase() + day.slice(1); let dayHtml = `<div class="mb-4"><h4 class="text-md font-bold border-b border-main pb-2 mb-2">${dayName}</h4><div class="space-y-2">`; Object.entries(daySchedule).sort(([,a],[,b])=>a.jam_mulai.localeCompare(b.jam_mulai)).forEach(([id, item]) => { dayHtml += `<div class="bg-white dark:bg-white dark:text-gray-800 p-3 rounded-lg flex justify-between items-center"><div><p class="font-medium">${item.jam_mulai} - ${item.jam_selesai}</p><p class="text-sm text-sub dark:text-gray-600">${item.mapelNama} - ${item.kelas}</p></div><div class="flex items-center"><button onclick="window.showEditJadwalModal('${day}','${id}')" class="p-2 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400"><i class="fa-solid fa-pencil"></i></button><button onclick="window.handleDeleteJadwalEntry('${day}','${id}')" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>`; }); dayHtml += `</div></div>`; jadwalTerstrukturContainer.innerHTML += dayHtml; } }); if (jadwalTerstrukturContainer.innerHTML === '') jadwalTerstrukturContainer.innerHTML = '<p class="text-center text-sub py-4">Belum ada jadwal.</p>'; }
        window.showEditJadwalModal = (day, scheduleId) => { const jadwal = allJadwalTerstruktur[day]?.[scheduleId]; if(!jadwal) return; let dayOpts = '', mapelOpts = ''; ['senin','selasa','rabu','kamis','jumat','sabtu'].forEach(d=>{dayOpts+=`<option value="${d}" ${d===day?'selected':''}>${d.charAt(0).toUpperCase()+d.slice(1)}</option>`;}); Object.entries(allMapel).sort(([,a],[,b])=>a.nama.localeCompare(b.nama)||a.kelas.localeCompare(b.kelas)).forEach(([id,m])=>{mapelOpts+=`<option value="${id}" ${id===jadwal.mapelId?'selected':''}>${m.nama} - ${m.kelas}</option>`;}); openModal(`<h3 class="text-lg font-bold mb-4">Edit Jadwal</h3><div class="space-y-4"><div><label for="edit-jadwal-hari" class="block text-sm font-medium text-sub mb-1">Hari</label><select id="edit-jadwal-hari" class="w-full p-2 input-bg rounded-lg">${dayOpts}</select></div><div class="grid grid-cols-2 gap-4"><div><label for="edit-jadwal-jam-mulai" class="block text-sm font-medium text-sub mb-1">Mulai</label><input type="time" id="edit-jadwal-jam-mulai" value="${jadwal.jam_mulai}" class="w-full p-2 input-bg rounded-lg"></div><div><label for="edit-jadwal-jam-selesai" class="block text-sm font-medium text-sub mb-1">Selesai</label><input type="time" id="edit-jadwal-jam-selesai" value="${jadwal.jam_selesai}" class="w-full p-2 input-bg rounded-lg"></div></div><div><label for="edit-jadwal-mapel" class="block text-sm font-medium text-sub mb-1">Mapel</label><select id="edit-jadwal-mapel" class="w-full p-2 input-bg rounded-lg">${mapelOpts}</select></div></div><div class="flex justify-end space-x-2 mt-6"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleEditJadwal('${day}','${scheduleId}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`); }
        async function handleEditJadwal(originalDay, scheduleId) { const newDay = el('edit-jadwal-hari').value, newStart = el('edit-jadwal-jam-mulai').value, newEnd = el('edit-jadwal-jam-selesai').value, newMapelId = el('edit-jadwal-mapel').value; if (!newDay || !newStart || !newEnd || !newMapelId) return showToast("Semua kolom wajib.", true); if (newStart >= newEnd) return showToast("Jam tidak valid.", true); showLoader(); try { const mapelData = allMapel[newMapelId]; const updatedData = { jam_mulai: newStart, jam_selesai: newEnd, mapelId: newMapelId, mapelNama: mapelData.nama, kelas: mapelData.kelas }; const updates = {}; updates[`users_data/${currentUserKey}/jadwal_terstruktur/${originalDay}/${scheduleId}`] = null; updates[`users_data/${currentUserKey}/jadwal_terstruktur/${newDay}/${scheduleId}`] = updatedData; await update(ref(db), updates); showToast("Jadwal berhasil diperbarui."); closeModal(); } catch (err) { showAlertModal("Error", `Gagal memperbarui: ${err.message}`, true); } finally { hideLoader(); } }
        function handleDeleteJadwalEntry(day, scheduleId) { openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Jadwal?</h3><p class="mb-6">Yakin ingin menghapus jadwal ini?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.confirmDeleteJadwalEntry('${day}','${scheduleId}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`); }
        window.confirmDeleteJadwalEntry = async (day, scheduleId) => { closeModal(); showLoader(); try { await remove(ref(db, `users_data/${currentUserKey}/jadwal_terstruktur/${day}/${scheduleId}`)); showToast("Jadwal berhasil dihapus."); } catch (err) { showAlertModal("Error", `Gagal menghapus: ${err.message}`, true); } finally { hideLoader(); } };

        function handleToggleJadwalMode() { currentJadwalMode = currentJadwalMode === 'dinamis' ? 'gambar' : 'dinamis'; const isGambar = currentJadwalMode === 'gambar'; toggleJadwalModeSwitch.style.transform = isGambar ? 'translateX(0)' : 'translateX(1.25rem)'; toggleJadwalModeBtn.classList.toggle('bg-blue-600', !isGambar); toggleJadwalModeBtn.classList.toggle('bg-gray-200', isGambar); jadwalModeLabel.textContent = `Mode: ${isGambar ? 'Gambar' : 'Buat Jadwal'}`; jadwalViewDinamis.classList.toggle('hidden', isGambar); jadwalViewGambar.classList.toggle('hidden', !isGambar); }
        function displayDashboard() { const now = new Date(); const hours = now.getHours(); let greeting = 'Selamat Pagi!'; if (hours >= 11 && hours < 15) greeting = 'Selamat Siang!'; else if (hours >= 15 && hours < 19) greeting = 'Selamat Sore!'; else if (hours >= 19 || hours < 5) greeting = 'Selamat Malam!'; dashboardGreeting.textContent = greeting; dashboardDate.textContent = formatDateToIndonesian(now); renderSmartScheduleDashboard(); }
        
        function renderSmartScheduleDashboard() {
            dashboardJadwalCerdas.innerHTML = '';
            const now = new Date();
            const todayDateString = getLocalISODate(now);
            const days = ['minggu', 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
            const todayName = days[now.getDay()];
            const currentTime = now.toTimeString().slice(0, 5);

            let cardsToRender = [];
            const processedPastEntries = new Set();

            const today = new Date(todayDateString + 'T00:00:00');
            for (let i = 1; i <= 14; i++) {
                const pastDate = new Date(today);
                pastDate.setDate(today.getDate() - i);
                const pastDateString = getLocalISODate(pastDate);
                const pastDayName = days[pastDate.getDay()];
                const pastDaySchedule = allJadwalTerstruktur[pastDayName] ? Object.values(allJadwalTerstruktur[pastDayName]) : [];

                pastDaySchedule.forEach(item => {
                    const entryKey = `${pastDateString}-${item.mapelId}-${item.kelas}`;
                    if (processedPastEntries.has(entryKey)) return;

                    const hasPresensi = allPresensiData[item.kelas]?.[item.mapelId]?.[pastDateString];
                    const hasKegiatan = allKegiatanData[item.kelas]?.[item.mapelId]?.[pastDateString]?.deskripsi;

                    if (hasPresensi && !hasKegiatan) {
                        cardsToRender.push({ ...item, date: pastDateString, isPastIncomplete: true });
                        processedPastEntries.add(entryKey);
                    }
                });
            }
            
            const todaySchedule = allJadwalTerstruktur[todayName] ? Object.values(allJadwalTerstruktur[todayName]).map(item => ({ ...item, date: todayDateString })) : [];
            todaySchedule.forEach(item => {
                 cardsToRender.push(item);
            });


            const enrichedCards = cardsToRender.map(item => {
                if (item.isPastIncomplete) {
                    return { ...item, sortOrder: 0 }; 
                }
                const isPast = currentTime >= item.jam_selesai;
                const isCurrent = currentTime >= item.jam_mulai && currentTime < item.jam_selesai;
                const hasPresensi = !!allPresensiData[item.kelas]?.[item.mapelId]?.[item.date];
                const hasKegiatan = !!allKegiatanData[item.kelas]?.[item.mapelId]?.[item.date]?.deskripsi;
                const isComplete = hasPresensi && hasKegiatan;
                
                let sortOrder;
                
                if (isPast && !isComplete) { 
                    sortOrder = 1; 
                } else if (isCurrent) { 
                    sortOrder = 2; 
                } else if (!isPast && !isCurrent) { 
                    sortOrder = 3; 
                } else { 
                    sortOrder = 4; 
                }
                return { ...item, sortOrder };
            });

            enrichedCards.sort((a, b) => {
                if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
                if (a.sortOrder === 0) return new Date(b.date) - new Date(a.date);
                return a.jam_mulai.localeCompare(b.jam_mulai);
            });

            let dashboardHTML = '';
            if (enrichedCards.length > 0) {
                enrichedCards.forEach(item => {
                    
                    const hasPresensi = !!allPresensiData[item.kelas]?.[item.mapelId]?.[item.date];
                    const hasKegiatan = !!allKegiatanData[item.kelas]?.[item.mapelId]?.[item.date]?.deskripsi;
                    const isComplete = hasPresensi && hasKegiatan;
                    
                    let cardHeader, cardHeaderColor, cardBorderColor, cardIcon, dateDisplay = '';

                    if (item.isPastIncomplete) {
                        cardHeader = "PERLU DILENGKAPI"; cardHeaderColor = "text-yellow-600"; cardBorderColor = "persistent-card"; cardIcon = `<i class="fa-solid fa-exclamation-triangle text-xl ${cardHeaderColor}"></i>`;
                        const pastDate = new Date(item.date + 'T00:00:00');
                        dateDisplay = `<p class="text-xs font-semibold text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full">${formatDateToIndonesian(pastDate)}</p>`;
                    
                    } else if (item.sortOrder === 1) { 
                        cardHeader = "PERLU DILENGKAPI"; cardHeaderColor = "text-yellow-600"; cardBorderColor = "persistent-card"; cardIcon = `<i class="fa-solid fa-exclamation-triangle text-xl ${cardHeaderColor}"></i>`;
                    
                    } else if (item.sortOrder === 2) { 
                        cardHeader = "SEDANG BERLANGSUNG"; cardHeaderColor = "text-blue-600"; cardBorderColor = "highlight-card"; cardIcon = `<i class="fa-solid fa-person-chalkboard text-xl ${cardHeaderColor}"></i>`;
                    
                    } else if (item.sortOrder === 3) { 
                        cardHeader = "SELANJUTNYA"; cardHeaderColor = "text-gray-500"; cardBorderColor = "future-card"; cardIcon = `<i class="fa-solid fa-hourglass-start text-xl ${cardHeaderColor}"></i>`;
                    
                    } else { 
                        cardHeader = "SELESAI"; cardHeaderColor = "text-green-600"; cardBorderColor = "completed-card"; cardIcon = `<i class="fa-solid fa-check-circle text-xl ${cardHeaderColor}"></i>`;
                    }

                    const mapelColor = getDeterministicColor(item.mapelNama, 'mapel');
                    const kelasColor = getDeterministicColor(item.kelas, 'kelas');
                    const presensiData = allPresensiData[item.kelas]?.[item.mapelId]?.[item.date];
                    const kegiatanData = allKegiatanData[item.kelas]?.[item.mapelId]?.[item.date];
                    let presensiHTML = '', presensiDetailHTML = '', buttonHTML = '', kegiatanHTML = '';
                    
                    const canAccess = item.sortOrder !== 3 || isBebasPresensi;

                    if (canAccess) {
                        let buttonText = "Mulai Presensi"; let buttonClass = "bg-blue-600 hover:bg-blue-700"; let buttonIcon = `<i class="fa-solid fa-arrow-right-to-bracket mr-2"></i>`;
                        if(hasPresensi && !hasKegiatan){ buttonText = "Lengkapi Kegiatan"; buttonClass = "bg-yellow-500 hover:bg-yellow-600"; buttonIcon = `<i class="fa-solid fa-file-pen mr-2"></i>`; }
                        else if(isComplete) { buttonText = "Lihat/Ubah Data"; buttonClass = "bg-green-600 hover:bg-green-700"; buttonIcon = `<i class="fa-solid fa-eye mr-2"></i>`; }
                        buttonHTML = `<button onclick="window.handlePresensiShortcut('${item.mapelId}', '${item.kelas}', '${item.date}')" class="${buttonClass} text-white font-bold py-2 px-4 rounded-lg flex items-center transition text-sm">${buttonIcon}<span>${buttonText}</span></button>`;
                    }

                    if (presensiData) { let h = 0, s = 0, i = 0, a = 0; let sakitList = [], izinList = [], alpaList = [], hadirDenganCatatanList = []; Object.entries(presensiData).forEach(([studentId, p]) => { const studentName = allStudents[studentId]?.nama || 'Siswa Dihapus'; switch(p.status) { case 'Hadir': h++; if(p.catatan) hadirDenganCatatanList.push({name: studentName, note: p.catatan}); break; case 'Sakit': s++; sakitList.push({name: studentName, note: p.catatan}); break; case 'Izin': i++; izinList.push({name: studentName, note: p.catatan}); break; case 'Alpa': a++; alpaList.push({name: studentName, note: p.catatan}); break; } }); presensiHTML = `<div class="mt-4 pt-4 border-t border-main"><p class="text-sm font-bold mb-2">Rekap Presensi</p><div class="flex justify-around text-center text-sm"><div><strong>${h}</strong><p>Hadir</p></div><div><strong class="text-orange-600">${s}</strong><p>Sakit</p></div><div><strong class="text-green-600">${i}</strong><p>Izin</p></div><div><strong class="text-red-600">${a}</strong><p>Alpa</p></div></div></div>`; if (sakitList.length > 0 || izinList.length > 0 || alpaList.length > 0 || hadirDenganCatatanList.length > 0) { presensiDetailHTML += '<div class="mt-3 text-xs space-y-1">'; const createList = (title, list) => { if(list.length > 0) presensiDetailHTML += `<div><strong>${title}:</strong> ${list.map(item => `${item.name}${item.note ? ` (<span class="italic text-sub">${item.note}</span>)` : ''}`).join(', ')}</div>`; }; createList('Sakit', sakitList); createList('Izin', izinList); createList('Alpa', alpaList); createList('Hadir (dgn catatan)', hadirDenganCatatanList); presensiDetailHTML += '</div>'; } }
                    
                    if (kegiatanData?.deskripsi) {
                        const label = item.date === todayDateString ? "Kegiatan Hari Ini" : "Kegiatan Tercatat";
                        kegiatanHTML = `<div class="mt-4 pt-4 border-t border-main">
                                            <p class="text-sm font-bold mb-1">${label} (${formatReadableDate(item.date, 'long')})</p>
                                            <p class="text-sm p-2 rounded text-black" style="background-color: #F0F8FF;">${kegiatanData.deskripsi}</p>
                                        </div>`;
                    } 
                    else {
                        const mapelKegiatan = allKegiatanData[item.kelas]?.[item.mapelId];
                        let lastKegiatanFound = false;
                        if (mapelKegiatan) {
                            const previousDates = Object.keys(mapelKegiatan)
                                                      .filter(d => d < item.date && mapelKegiatan[d]?.deskripsi) 
                                                      .sort()
                                                      .reverse();
                            
                            if (previousDates.length > 0) {
                                const lastDate = previousDates[0];
                                const lastKegiatan = mapelKegiatan[lastDate];
                                const formattedDate = formatReadableDate(lastDate, 'long');
                                
                                kegiatanHTML = `<div class="mt-4 pt-4 border-t border-main">
                                                    <p class="text-sm font-bold mb-1 text-yellow-800">Pengingat: Pertemuan Lalu (${formattedDate})</p>
                                                    <p class="text-sm p-2 rounded text-black" style="background-color: #FFFACD;">${lastKegiatan.deskripsi}</p>
                                                </div>`;
                                lastKegiatanFound = true;
                            }
                        }
                        
                        if (!lastKegiatanFound && hasPresensi && (item.isPastIncomplete || item.sortOrder === 3 || item.sortOrder === 1)) {
                            kegiatanHTML = `<div class="mt-4 pt-4 border-t border-main">
                                                <p class="text-sm font-bold mb-1">Kegiatan</p>
                                                <p class="text-sm text-orange-600 font-semibold">Belum diisi.</p>
                                            </div>`;
                        }
                    }
                    
                    const detailContent = (kegiatanHTML + presensiHTML + presensiDetailHTML);
                    dashboardHTML += ` <div class="card-bg dashboard-card rounded-xl shadow-md ${cardBorderColor} mb-4 p-4"> <div class="flex justify-between items-center mb-2"> <div class="flex items-center space-x-3"> ${cardIcon} <p class="text-sm font-bold ${cardHeaderColor}">${cardHeader}</p> </div> ${dateDisplay || `<p class="font-mono text-sm text-black px-2 py-1 rounded" style="background-color: #F0F8FF;">${item.jam_mulai} - ${item.jam_selesai}</p>`} </div> <div class="flex justify-between items-start"> <div> <h4 class="text-2xl font-bold mb-1"> <span class="px-2 py-1 rounded-md text-xl ${mapelColor.bg} ${mapelColor.text}"> ${item.mapelNama} </span> </h4> <p class="text-lg text-sub"> <span class="font-semibold px-2 py-1 rounded-md text-base ${kelasColor.bg} ${kelasColor.text}"> Kelas ${item.kelas} </span> </p> </div> ${buttonHTML ? `<div class="mt-2 sm:mt-0">${buttonHTML}</div>` : ''} </div> ${(hasPresensi || kegiatanHTML) ? `${detailContent}` : ''} </div>`;
                });
            }
            if (dashboardHTML === '') {
                 dashboardHTML = `<div class="card-bg dashboard-card text-center p-6 rounded-xl"><i class="fa-solid fa-calendar-check text-4xl text-gray-400 mb-3"></i><h4 class="font-bold text-lg">Tidak Ada Jadwal</h4><p class="mb-4 text-sub">Tidak ada jadwal untuk hari ini atau jadwal yang perlu dilengkapi.</p><button onclick="window.goToBuatJadwal()" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Buat Jadwal</button></div>`;
            }
            dashboardJadwalCerdas.innerHTML = dashboardHTML;
        }

        window.goToBuatJadwal = () => { switchPage('jadwal'); if (currentJadwalMode !== 'dinamis') handleToggleJadwalMode(); }
        async function handlePresensiShortcut(mapelId, kelas, dateString) {
            const mapelData = allMapel[mapelId];
            if (!mapelData) return showAlertModal("Error", "Mapel tidak ditemukan.", true);
            switchPage('presensi');
            filterMapel.value = mapelData.nama;
            await updateClassFilter('presensi');
            filterKelas.value = kelas;
            filterTanggal.value = dateString;
            await handleTerapkanFilter(true);
            el('filter-container').scrollIntoView({ behavior: 'smooth' });
        }
        async function syncOfflineData() { const pending = loadFromLocal('pending-updates'); if (!pending || Object.keys(pending).length === 0) return; showToast("Menyinkronkan data..."); showLoader(); try { await update(ref(db), pending); localStorage.removeItem('pending-updates'); showToast("Sinkronisasi berhasil."); } catch (e) { showToast("Gagal sinkronisasi.", true); } finally { hideLoader(); } }
        function handleOnlineStatus() { offlineIndicator.classList.add('hidden'); syncOfflineData(); }
        function handleOfflineStatus() { 
            offlineIndicator.classList.remove('hidden'); 
            showToast("Anda offline.", true); 
        }
        
        // --- 
        // --- KODE BARU UNTUK NOTIFIKASI NATIVE (APK) ---
        // ---
        
        /**
         * Membatalkan semua notifikasi lokal yang tertunda.
         * Ini dipanggil saat "Bebas Presensi" diaktifkan atau saat jadwal diperbarui.
         */
        async function cancelAllNotifications() {
            try {
                // Cek apakah kita ada di dalam Capacitor (APK)
                if (typeof Capacitor === 'undefined' || !Capacitor.Plugins || !Capacitor.Plugins.LocalNotifications) return;
                
                const { LocalNotifications } = Capacitor.Plugins;
                const pending = await LocalNotifications.getPending();
                
                if (pending.notifications.length > 0) {
                    console.log("Membatalkan notifikasi...", pending);
                    await LocalNotifications.cancel(pending);
                }
            } catch (err) {
                console.error("Gagal membatalkan notifikasi:", err);
            }
        }

        /**
         * Menjadwalkan semua notifikasi (2 menit sebelum & 40 menit sesudah)
         * berdasarkan allJadwalTerstruktur.
         * Kode ini HANYA akan berjalan di dalam APK (Capacitor).
         */
        async function scheduleAllNotifications() {
            try {
                // 1. Cek apakah di dalam APK
                if (typeof Capacitor === 'undefined' || !Capacitor.Plugins || !Capacitor.Plugins.LocalNotifications) {
                    console.log("Mode browser, skip notifikasi native.");
                    return;
                }
                const { LocalNotifications } = Capacitor.Plugins;

                // 2. PERMINTAAN ANDA: Cek "Bebas Presensi"
                if (isBebasPresensi) {
                    console.log("Bebas Presensi aktif, membatalkan notifikasi.");
                    await cancelAllNotifications();
                    showToast("Notifikasi dinonaktifkan (Bebas Presensi).");
                    return;
                }

                // 3. Minta Izin (jika perlu)
                let permission = await LocalNotifications.checkPermissions();
                if (permission.display === 'prompt') {
                    permission = await LocalNotifications.requestPermissions();
                }
                if (permission.display !== 'granted') {
                    return showAlertModal("Izin Ditolak", "Izin notifikasi ditolak. Fitur pengingat tidak akan berfungsi.", true);
                }

                // 4. Bersihkan notifikasi lama
                await cancelAllNotifications();
                console.log("Menjadwalkan notifikasi baru...");

                const daysOfWeek = { senin: 2, selasa: 3, rabu: 4, kamis: 5, jumat: 6, sabtu: 7 };
                const notificationsToSchedule = [];
                let notificationId = 1; // ID unik

                for (const dayName in allJadwalTerstruktur) {
                    const dayNumber = daysOfWeek[dayName];
                    if (!dayNumber) continue;

                    const daySchedule = allJadwalTerstruktur[dayName];
                    for (const scheduleKey in daySchedule) {
                        const item = daySchedule[scheduleKey];
                        const [startHour, startMinute] = item.jam_mulai.split(':').map(Number);

                        // Notifikasi A (2 Menit SEBELUM)
                        const notifTimeA = new Date();
                        notifTimeA.setHours(startHour, startMinute, 0, 0);
                        notifTimeA.setMinutes(notifTimeA.getMinutes() - 2);
                        
                        notificationsToSchedule.push({
                            id: notificationId++,
                            title: "Pengingat Mengajar",
                            body: `Kelas ${item.mapelNama} (${item.kelas}) akan dimulai 2 menit lagi.`,
                            schedule: { 
                                on: { weekday: dayNumber, hour: notifTimeA.getHours(), minute: notifTimeA.getMinutes() },
                                repeats: true // Ulangi setiap minggu
                            }
                        });

                        // Notifikasi B (40 Menit SESUDAH)
                        const notifTimeB = new Date();
                        notifTimeB.setHours(startHour, startMinute, 0, 0);
                        notifTimeB.setMinutes(notifTimeB.getMinutes() + 40);

                        notificationsToSchedule.push({
                            id: notificationId++,
                            title: "Pengingat Presensi",
                            body: `Jangan lupa lengkapi presensi & kegiatan untuk ${item.mapelNama} (${item.kelas}).`,
                            schedule: { 
                                on: { weekday: dayNumber, hour: notifTimeB.getHours(), minute: notifTimeB.getMinutes() },
                                repeats: true // Ulangi setiap minggu
                            }
                        });
                    }
                }

                // 5. Jadwalkan semua
                if (notificationsToSchedule.length > 0) {
                    await LocalNotifications.schedule({ notifications: notificationsToSchedule });
                    showToast(`Notifikasi berhasil diatur.`);
                } else {
                    showToast("Tidak ada jadwal untuk diatur notifikasinya.");
                }

            } catch (err) {
                console.error("Gagal menjadwalkan notifikasi:", err);
                showAlertModal("Error Notifikasi", `Gagal: ${err.message}`, true);
            }
        }
        
        if (installPwaBtn) {
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installPwaBtn.classList.remove('hidden'); });
            installPwaBtn.addEventListener('click', async () => { installPwaBtn.classList.add('hidden'); deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; });
            window.addEventListener('appinstalled', () => { installPwaBtn.classList.add('hidden'); deferredPrompt = null; showToast("Aplikasi berhasil diinstal!"); });
        }

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed: ', err)); }); }
        window.handleDeleteDailyData = handleDeleteDailyData; window.handleDeleteJadwal = handleDeleteJadwal; window.handleDeleteMapel = handleDeleteMapel; window.handleDeleteStudent = handleDeleteStudent; window.handleEditMapel = handleEditMapel; window.handleEditStudent = handleEditStudent; window.showDeleteMapelModal = showDeleteMapelModal; window.showDeleteStudentModal = showDeleteStudentModal; window.showEditMapelModal = showEditMapelModal; window.showEditStudentModal = showEditStudentModal; window.goToBuatJadwal = goToBuatJadwal; window.handlePresensiShortcut = handlePresensiShortcut; window.showEditJadwalModal = showEditJadwalModal; window.handleEditJadwal = handleEditJadwal; window.handleDeleteJadwalEntry = handleDeleteJadwalEntry;
        setupPreLoginEventListeners();
    </script>
</body>
</html>
