<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Online Guru</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/speropa/presensi/main/ikon%20presensi.jpg">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .animate-shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        .nav-link.active { color: #2563eb; transform: scale(1.1); }
        .vertical-th { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; padding-bottom: 8px; padding-top: 8px; }
        button:disabled, select:disabled { background-color: #e5e7eb; cursor: not-allowed; color: #9ca3af; }
        .pin-input-dashes { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 4rem; }
        .pin-input-dashes .pin-dash { width: 16px; height: 16px; border-radius: 50%; background-color: #d1d5db; transition: background-color 0.2s ease; }
        .pin-input-dashes .pin-dash.filled { background-color: #1f2937; }
        .ios-keypad-button { display: flex; align-items: center; justify-content: center; width: 75px; height: 75px; background-color: #e5e7eb; border-radius: 50%; font-size: 2rem; font-weight: 400; color: #1f2937; transition: background-color 0.2s ease; cursor: pointer; }
        .ios-keypad-button:active { background-color: #d1d5db; }
        .ios-keypad-button.functional { background-color: transparent; border: none; }
        .dashboard-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-2px); }
        .highlight-card { border-left: 5px solid #2563eb; }
        .persistent-card { border-left: 5px solid #f59e0b; }
        .completed-card { border-left: 5px solid #22c55e; }
        .future-card { border-left: 5px solid #9ca3af; }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div></div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden fade-in z-[100]"><p id="toast-message"></p></div>
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-100 p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Login Guru</h2>
            <p class="text-center text-gray-500 mb-8">Gunakan akun yang terdaftar untuk masuk.</p>
            <form id="login-form">
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div>
                <div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div>
                <p id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">Masuk</button>
            </form>
        </div>
    </div>
    <div id="app" class="hidden">
        <div id="offline-indicator" class="bg-yellow-500 text-center text-white p-2 text-sm hidden fixed top-0 w-full z-[90]">Anda sedang offline. Perubahan akan disinkronkan saat kembali online.</div>
        <header class="w-full">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center bg-white shadow-md rounded-b-xl">
                <h1 id="user-display-name" class="text-xl font-bold text-gray-700">Memuat...</h1>
                <div class="flex items-center space-x-2">
                     <button id="install-pwa-btn" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-600 transition hidden flex items-center space-x-2"><i class="fa-solid fa-download"></i><span>Install</span></button>
                     <button id="logout-btn" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-red-600 transition">Keluar</button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 pb-24">
            <div id="page-dashboard" class="page-content">
                <div id="dashboard-container" class="mb-6">
                    <div class="mb-4">
                        <h2 id="dashboard-greeting" class="text-2xl font-bold text-gray-800">Selamat Datang!</h2>
                        <p id="dashboard-date" class="text-gray-500"></p>
                    </div>
                    <div id="dashboard-jadwal-cerdas"></div>
                </div>
            </div>
            <div id="page-presensi" class="page-content hidden">
                <div class="bg-white p-4 rounded-xl shadow-md mb-6" id="filter-container">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Filter Presensi & Nilai</h3>
                        <button id="delete-daily-data-btn" class="bg-red-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="hidden sm:inline">Hapus Data Hari Ini</span></button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="filter-mapel" class="text-sm font-medium">Mata Pelajaran</label><select id="filter-mapel" class="w-full mt-1 p-2 border rounded-lg bg-gray-50"><option value="">Pilih Mapel...</option></select></div>
                        <div><label for="filter-kelas" class="text-sm font-medium">Kelas</label><select id="filter-kelas" class="w-full mt-1 p-2 border rounded-lg bg-gray-50" disabled><option value="">Pilih Kelas...</option></select></div>
                        <div><label for="filter-tanggal" class="text-sm font-medium">Tanggal</label><input type="date" id="filter-tanggal" class="w-full mt-1 p-2 border rounded-lg bg-gray-50"></div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button id="terapkan-filter-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Terapkan</button>
                        <div class="flex items-center space-x-2"><span id="mode-label" class="text-sm font-medium text-gray-600">Mode: Presensi</span><button id="toggle-mode-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 focus:outline-none"><span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" id="toggle-mode-switch"></span></button></div>
                    </div>
                </div>
                <div id="content-area" class="hidden">
                    <!-- MODIFIED KEGIATAN CARD -->
                    <div class="bg-amber-50 border border-amber-200 p-4 rounded-xl shadow-md mb-6">
                        <label for="kegiatan-pembelajaran" class="text-sm font-bold text-amber-800">Kegiatan Pembelajaran Hari Ini</label>
                        <input type="text" id="kegiatan-pembelajaran" placeholder="Ketikkan ringkasan kegiatan di sini..." class="w-full mt-2 p-2 border border-amber-300 rounded-lg bg-white focus:ring-amber-500 focus:border-amber-500">
                        <div class="mt-4 pt-4 border-t border-amber-200">
                            <h4 class="text-sm font-semibold mb-2 text-amber-700">Riwayat Kegiatan</h4>
                            <div id="kegiatan-history-list" class="space-y-3 text-xs"></div>
                            <button id="kegiatan-history-toggle-more" data-state="partial" class="text-amber-600 text-xs font-semibold mt-2 hidden">Selengkapnya &darr;</button>
                        </div>
                    </div>
                    <!-- END OF MODIFIED KEGIATAN CARD -->
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6" id="presensi-search-container">
                        <label for="search-presensi-student" class="block text-sm font-medium text-gray-700 mb-1">Cari Siswa:</label>
                        <input type="text" id="search-presensi-student" placeholder="Cari berdasarkan nama..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="student-list-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    <div id="save-all-container" class="mt-6 text-center"><button id="save-all-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">Simpan Semua Perubahan</button></div>
                </div>
            </div>
            <div id="page-kelola-siswa" class="page-content hidden">
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Tambah Siswa Baru</h3>
                        <div class="flex items-center space-x-2">
                            <label for="csv-upload" class="bg-blue-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-blue-600 cursor-pointer flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span class="hidden sm:inline">Unggah</span></label>
                            <input type="file" id="csv-upload" class="hidden" accept=".csv">
                            <button id="download-template-btn" class="bg-gray-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-gray-700 flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span class="hidden sm:inline">Unduh</span></button>
                            <button id="delete-all-students-btn" class="bg-red-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-red-600 flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="hidden sm:inline">Hapus Semua</span></button>
                        </div>
                    </div>
                    <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="student-name" class="text-sm font-medium">Nama Lengkap</label><input type="text" id="student-name" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50"></div>
                        <div><label for="student-class" class="text-sm font-medium">Kelas</label><input type="text" id="student-class" required placeholder="Contoh: 7A" class="w-full mt-1 p-2 border rounded-lg bg-gray-50"></div>
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 h-fit">Tambah Siswa</button>
                    </form>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="text-lg font-bold mb-2 sm:mb-0">Daftar Semua Siswa</h3>
                        <input type="text" id="search-all-students" placeholder="Cari siswa..." class="w-full sm:w-auto px-3 py-2 border rounded-lg bg-gray-50">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100"><tr><th class="p-3">No</th><th class="p-3">Nama Lengkap</th><th class="p-3">Kelas</th><th class="p-3 text-center">Aksi</th></tr></thead>
                            <tbody id="all-students-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="page-kelola-mapel" class="page-content hidden">
                 <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-lg font-bold mb-3">Tambah Mata Pelajaran</h3>
                    <form id="add-mapel-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="mapel-name" class="text-sm font-medium">Nama Mapel</label><input type="text" id="mapel-name" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50"></div>
                        <div><label for="mapel-class" class="text-sm font-medium">Untuk Kelas</label><select id="mapel-class" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50"><option value="">Memuat Kelas...</option></select></div>
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 h-fit">Tambah Mapel</button>
                    </form>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-lg font-bold mb-4">Daftar Mata Pelajaran</h3>
                    <div id="mapel-list-container" class="space-y-3"></div>
                </div>
            </div>
            <div id="page-jadwal" class="page-content hidden">
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Jadwal Pelajaran</h3>
                        <div class="flex items-center space-x-3">
                            <span id="jadwal-mode-label" class="text-sm font-medium text-gray-600">Mode: Gambar</span>
                            <button id="toggle-jadwal-mode-btn" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-blue-600 focus:outline-none"><span id="toggle-jadwal-mode-switch" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-5"></span></button>
                        </div>
                    </div>
                </div>
                <div id="jadwal-view-gambar" class="hidden">
                     <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Jadwal (Gambar)</h3>
                            <div class="flex items-center space-x-2">
                                <label id="jadwal-upload-label" for="jadwal-upload" class="bg-blue-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-600 cursor-pointer flex items-center space-x-2 transition-colors"><i class="fa-solid fa-upload"></i><span class="hidden sm:inline">Unggah</span></label>
                                <input type="file" id="jadwal-upload" class="hidden" accept="image/*">
                                <button id="delete-jadwal-btn" class="bg-red-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-600 flex items-center space-x-2 transition-colors hidden"><i class="fa-solid fa-trash"></i><span class="hidden sm:inline">Hapus</span></button>
                            </div>
                        </div>
                        <div id="jadwal-image-container" class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-[60vh] flex items-center justify-center bg-gray-50">
                             <div id="jadwal-placeholder" class="text-center text-gray-500"><i class="fa-solid fa-image text-5xl mb-4"></i><p>Belum ada jadwal yang diunggah.</p><p class="text-sm">Silakan unggah gambar jadwal Anda.</p></div>
                            <img id="jadwal-image" src="" alt="Jadwal Pelajaran" class="max-w-full max-h-[70vh] rounded-lg hidden object-contain"/>
                        </div>
                    </div>
                </div>
                <div id="jadwal-view-dinamis">
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                        <h3 class="text-lg font-bold mb-4">Buat Jadwal Pelajaran</h3>
                        <form id="add-jadwal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label for="jadwal-hari" class="text-sm font-medium">Hari</label>
                                <select id="jadwal-hari" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50">
                                    <option value="senin">Senin</option><option value="selasa">Selasa</option><option value="rabu">Rabu</option><option value="kamis">Kamis</option><option value="jumat">Jumat</option><option value="sabtu">Sabtu</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label for="jadwal-jam-mulai" class="text-sm font-medium">Mulai</label><input type="time" id="jadwal-jam-mulai" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50"></div>
                                <div><label for="jadwal-jam-selesai" class="text-sm font-medium">Selesai</label><input type="time" id="jadwal-jam-selesai" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50"></div>
                            </div>
                            <div><label for="jadwal-mapel" class="text-sm font-medium">Mata Pelajaran</label><select id="jadwal-mapel" required class="w-full mt-1 p-2 border rounded-lg bg-gray-50"><option value="">Pilih Mapel...</option></select></div>
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 h-fit w-full">Tambah Jadwal</button>
                        </form>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4">Jadwal Tersimpan</h3>
                        <div id="jadwal-terstruktur-container" class="space-y-6"></div>
                    </div>
                </div>
            </div>
            <div id="page-hasil-rekap" class="page-content hidden">
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-lg font-bold mb-4">Rekapitulasi Presensi & Nilai</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="rekap-filter-mapel" class="text-sm font-medium">Mata Pelajaran</label><select id="rekap-filter-mapel" class="w-full mt-1 p-2 border rounded-lg bg-gray-50"><option value="">Pilih Mapel...</option></select></div>
                        <div><label for="rekap-filter-kelas" class="text-sm font-medium">Kelas</label><select id="rekap-filter-kelas" class="w-full mt-1 p-2 border rounded-lg bg-gray-50" disabled><option value="">Pilih Kelas...</option></select></div>
                        <div class="flex items-end"><button id="terapkan-rekap-btn" class="w-full bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Terapkan</button></div>
                    </div>
                </div>
                <div id="rekap-table-container" class="bg-white p-4 rounded-xl shadow-md overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Data Rekapitulasi</h3>
                        <div class="relative inline-block text-left">
                            <button id="rekap-download-dropdown-btn" class="bg-gray-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-gray-700 flex items-center space-x-2 hidden"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span class="hidden sm:inline">Unduh Rekap</span><svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                            <div id="rekap-download-options" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden"><div class="py-1"><button id="download-csv-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100">Unduh sebagai CSV</button><button id="print-rekap-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100">Cetak (PDF)</button></div></div>
                        </div>
                    </div>
                    <div id="rekap-search-container" class="mb-4 hidden"><label for="search-rekap-student" class="block text-sm font-medium text-gray-700 mb-1">Cari Siswa:</label><input type="text" id="search-rekap-student" placeholder="Cari berdasarkan nama..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                    <div id="rekap-dynamic-table-content"></div>
                </div>
            </div>
        </main>
        <div class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.1)] z-40">
            <nav class="container mx-auto flex justify-around">
                <button data-page="dashboard" class="nav-link active flex flex-col items-center text-gray-500 hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span class="text-xs font-medium">Dasbor</span></button>
                <button data-page="presensi" class="nav-link flex flex-col items-center text-gray-500 hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg><span class="text-xs font-medium">Presensi</span></button>
                <button data-page="kelola-siswa" class="nav-link flex flex-col items-center text-gray-500 hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 013.39-2.142 3.002 3.002 0 013.39 2.142M9 11a4 4 0 110-8 4 4 0 010 8z"></path></svg><span class="text-xs font-medium">Siswa</span></button>
                <button data-page="kelola-mapel" class="nav-link flex flex-col items-center text-gray-500 hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span class="text-xs font-medium">Mapel</span></button>
                <button data-page="jadwal" class="nav-link flex flex-col items-center text-gray-500 hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="text-xs font-medium">Jadwal</span></button>
                <button data-page="hasil-rekap" class="nav-link flex flex-col items-center text-gray-500 hover:text-blue-600 p-2 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="text-xs font-medium">Rekap</span></button>
            </nav>
        </div>
    </div>
    <div id="pin-verification-modal" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50 hidden p-8">
        <div class="w-full max-w-xs text-center flex-grow flex flex-col justify-center">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Masukkan PIN</h3>
            
            <div id="pin-dashes" class="pin-input-dashes">
                <div class="pin-dash"></div>
                <div class="pin-dash"></div>
                <div class="pin-dash"></div>
                <div class="pin-dash"></div>
                <div class="pin-dash"></div>
                <div class="pin-dash"></div>
            </div>
            <input type="hidden" id="pin-input-field" value="" maxlength="6">
            <p id="pin-error" class="text-red-500 text-sm h-5 mb-6 hidden"></p>

            <div id="pin-keypad-modal" class="grid grid-cols-3 gap-x-6 gap-y-4 mx-auto">
                <button type="button" class="ios-keypad-button" data-value="1">1</button>
                <button type="button" class="ios-keypad-button" data-value="2">2</button>
                <button type="button" class="ios-keypad-button" data-value="3">3</button>
                <button type="button" class="ios-keypad-button" data-value="4">4</button>
                <button type="button" class="ios-keypad-button" data-value="5">5</button>
                <button type="button" class="ios-keypad-button" data-value="6">6</button>
                <button type="button" class="ios-keypad-button" data-value="7">7</button>
                <button type="button" class="ios-keypad-button" data-value="8">8</button>
                <button type="button" class="ios-keypad-button" data-value="9">9</button>
                <div class="functional"></div> 
                <button type="button" class="ios-keypad-button" data-value="0">0</button>
                <button type="button" class="ios-keypad-button functional" data-value="backspace">
                    <i class="fa-solid fa-delete-left text-3xl text-gray-500"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden p-4"><div id="modal-content" class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md fade-in"></div></div>

    <div id="image-viewer-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[70] hidden p-4 fade-in">
        <button id="close-image-viewer-btn" class="absolute top-4 right-4 text-white text-5xl font-bold hover:text-gray-300 transition-colors">&times;</button>
        <img id="fullscreen-image" src="" class="max-w-full max-h-full object-contain">
    </div>

    <script type="module">
        // --- PENTING: GANTI DENGAN URL DARI CLOUDFLARE ANDA ---
        const CLOUDFLARE_WORKER_URL = "https://sekretaris-notifikasi.examsperopa.workers.dev"; 
        // ---------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const GITHUB_USERNAME = "speropa";
        const GITHUB_REPO = "presensi";
        const firebaseConfig = { apiKey: "AIzaSyDPJFRn9ymq3OH0Kg9E09rEjc6W9SASh2Q", authDomain: "presensi-online-fe404.firebaseapp.com", databaseURL: "https://presensi-online-fe404-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "presensi-online-fe404", storageBucket: "presensi-online-fe404.firebasestorage.app", messagingSenderId: "608665441560", appId: "1:608665441560:web:90fea4bb8596289e048ba6d" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentMode = 'presensi', allStudents = {}, allMapel = {}, allJadwalTerstruktur = {}, hasUnsavedChanges = false, pendingAction = null, pendingPage = null, currentUserKey = null, currentUserName = null, githubToken = null, deferredPrompt, allLoginData = null, currentJadwalMode = 'dinamis', dashboardUpdateInterval = null;
        let availableClasses = new Set(), currentPresensiStudentsData = [], currentRekapData = { presensi: {}, nilai: {}, kelas: '' };
        let allPresensiData = {}, allKegiatanData = {};
        let isOneSignalInitialized = false;

        const el = id => document.getElementById(id);
        const loadingSpinner = el('loading-spinner'), loginPage = el('login-page'), mainApp = el('app'), loginForm = el('login-form'), loginError = el('login-error'), logoutBtn = el('logout-btn'), userDisplayName = el('user-display-name'), offlineIndicator = el('offline-indicator'), installPwaBtn = el('install-pwa-btn'), emailInput = el('email'), passwordInput = el('password'), pinVerificationModal = el('pin-verification-modal'), pinInputField = el('pin-input-field'), pinDashes = el('pin-dashes'), pinKeypadModal = el('pin-keypad-modal'), pinError = el('pin-error'), filterMapel = el('filter-mapel'), filterKelas = el('filter-kelas'), filterTanggal = el('filter-tanggal'), terapkanBtn = el('terapkan-filter-btn'), rekapFilterMapel = el('rekap-filter-mapel'), rekapFilterKelas = el('rekap-filter-kelas'), terapkanRekapBtn = el('terapkan-rekap-btn'), deleteDailyDataBtn = el('delete-daily-data-btn'), toggleModeBtn = el('toggle-mode-btn'), toggleModeSwitch = el('toggle-mode-switch'), modeLabel = el('mode-label'), contentArea = el('content-area'), kegiatanInput = el('kegiatan-pembelajaran'), studentListContainer = el('student-list-container'), saveAllBtn = el('save-all-btn'), kegiatanHistoryList = el('kegiatan-history-list'), kegiatanHistoryToggleMore = el('kegiatan-history-toggle-more'), presensiSearchContainer = el('presensi-search-container'), searchPresensiStudentInput = el('search-presensi-student'), addStudentForm = el('add-student-form'), studentNameInput = el('student-name'), studentClassInput = el('student-class'), allStudentsTable = el('all-students-table'), csvUploadInput = el('csv-upload'), downloadTemplateBtn = el('download-template-btn'), deleteAllStudentsBtn = el('delete-all-students-btn'), searchAllStudentsInput = el('search-all-students'), addMapelForm = el('add-mapel-form'), mapelNameInput = el('mapel-name'), mapelClassSelect = el('mapel-class'), mapelListContainer = el('mapel-list-container'), jadwalUploadInput = el('jadwal-upload'), jadwalUploadLabel = el('jadwal-upload-label'), jadwalImageContainer = el('jadwal-image-container'), jadwalImage = el('jadwal-image'), jadwalPlaceholder = el('jadwal-placeholder'), deleteJadwalBtn = el('delete-jadwal-btn'), imageViewerModal = el('image-viewer-modal'), closeImageViewerBtn = el('close-image-viewer-btn'), fullscreenImage = el('fullscreen-image'), rekapTableContainer = el('rekap-table-container'), rekapDownloadDropdownBtn = el('rekap-download-dropdown-btn'), rekapDownloadOptions = el('rekap-download-options'), downloadCsvBtn = el('download-csv-btn'), printRekapBtn = el('print-rekap-btn'), rekapSearchContainer = el('rekap-search-container'), searchRekapStudentInput = el('search-rekap-student'), rekapDynamicTableContent = el('rekap-dynamic-table-content'), addJadwalForm = el('add-jadwal-form'), jadwalHariSelect = el('jadwal-hari'), jadwalJamMulaiInput = el('jadwal-jam-mulai'), jadwalJamSelesaiInput = el('jadwal-jam-selesai'), jadwalMapelSelect = el('jadwal-mapel'), jadwalTerstrukturContainer = el('jadwal-terstruktur-container'), toggleJadwalModeBtn = el('toggle-jadwal-mode-btn'), toggleJadwalModeSwitch = el('toggle-jadwal-mode-switch'), jadwalModeLabel = el('jadwal-mode-label'), jadwalViewGambar = el('jadwal-view-gambar'), jadwalViewDinamis = el('jadwal-view-dinamis'), dashboardGreeting = el('dashboard-greeting'), dashboardDate = el('dashboard-date'), dashboardJadwalCerdas = el('dashboard-jadwal-cerdas'), modal = el('modal'), modalContent = el('modal-content');
        const navLinks = document.querySelectorAll('.nav-link'), pages = document.querySelectorAll('.page-content');
        
        // --- Fungsi Utilitas & Konfigurasi ---
        function getNextScheduleDateTime(day, time) {
            const days = ['minggu', 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
            const targetDayIndex = days.indexOf(day.toLowerCase());
            if (targetDayIndex === -1) return null;
            const now = new Date();
            const currentDayIndex = now.getDay();
            let dayDifference = targetDayIndex - currentDayIndex;
            if (dayDifference < 0 || (dayDifference === 0 && now.toTimeString().slice(0, 5) >= time)) {
                dayDifference += 7;
            }
            const nextDate = new Date(now);
            nextDate.setDate(now.getDate() + dayDifference);
            const [hours, minutes] = time.split(':');
            nextDate.setHours(hours, minutes, 0, 0);
            const year = nextDate.getFullYear();
            const month = (nextDate.getMonth() + 1).toString().padStart(2, '0');
            const date = nextDate.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${date} ${time}:00 GMT+0700`;
        }

        async function callCloudflareWorker(action, payload) {
            if (CLOUDFLARE_WORKER_URL === "URL_WORKER_ANDA_DI_SINI") {
                console.error("URL Cloudflare Worker belum diatur!");
                return null;
            }
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Gagal memanggil Cloudflare Worker untuk aksi "${action}":`, error);
                return null;
            }
        }

        const showLoader = () => loadingSpinner.classList.remove('hidden'); 
        const hideLoader = () => loadingSpinner.classList.add('hidden'); 
        const showToast = (message, isError = false) => { const toast = el('toast'); el('toast-message').textContent = message; toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg fade-in z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`; toast.classList.remove('hidden'); setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.classList.add('hidden'), 300); }, 3000); }; 
        const openModal = (content) => { modalContent.innerHTML = content; modal.classList.remove('hidden'); }; 
        window.closeModal = () => { modalContent.classList.add('fade-out'); setTimeout(() => { modal.classList.add('hidden'); modalContent.classList.remove('fade-out'); modalContent.innerHTML = ''; }, 300); }; 
        const showAlertModal = (title, message, isError = false) => { const titleColorClass = isError ? 'text-red-600' : 'text-gray-800'; const content = `<h3 class="text-lg font-bold mb-2 ${titleColorClass}">${title}</h3><p class="text-gray-700 mb-6">${message}</p><div class="flex justify-end"><button onclick="window.closeModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Oke</button></div>`; openModal(content); }; 
        const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); 
        function sanitizeForPath(name) { if (!name) return 'unknown-user'; return name.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, ''); }
        function getLocalISODate(date = new Date()) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        // --- Alur Login & Inisialisasi (MODIFIED) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    allLoginData = (await get(ref(db, 'login'))).val();
                    await requestNotificationPermissionAndShowPin();
                } catch (error) {
                    showAlertModal("Error", "Gagal memuat data login awal.", true);
                    hideLoader();
                }
            } else {
                // Jika tidak ada user, coba login otomatis atau tampilkan halaman login
                try {
                    showLoader();
                    await signInWithEmailAndPassword(auth, 'mdsr@gmail.com', '12345678');
                } catch (error) {
                    loginPage.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    pinVerificationModal.classList.add('hidden');
                } finally {
                    hideLoader();
                }
            }
        });

        async function requestNotificationPermissionAndShowPin() {
            await window.OneSignalDeferred.push(async () => {
                try {
                    // Inisialisasi OneSignal terlebih dahulu
                    if (!isOneSignalInitialized) {
                        const oneSignalAppIdRef = ref(db, 'one/signal');
                        const snapshot = await get(oneSignalAppIdRef);
                        const oneSignalAppId = snapshot.val();
                        if (!oneSignalAppId) throw new Error("OneSignal App ID tidak ditemukan.");
                        await OneSignal.init({ appId: oneSignalAppId, serviceWorkerPath: "OneSignalSDKWorker.js", serviceWorkerUpdaterPath: "OneSignalSDKUpdaterWorker.js" });
                        isOneSignalInitialized = true;
                    }

                    // Cek status izin
                    const permission = await OneSignal.Notifications.getPermissionStatus();
                    if (permission === 'default') {
                        await OneSignal.Notifications.requestPermission();
                        const newPermission = await OneSignal.Notifications.getPermissionStatus();
                        if (newPermission === 'denied') {
                            showToast("Notifikasi tidak akan aktif.", true);
                        }
                    } else if (permission === 'denied') {
                        showToast("Notifikasi tidak aktif. Aktifkan di setelan browser.", true);
                    }
                } catch (error) {
                    console.error("Gagal inisialisasi/meminta izin OneSignal:", error);
                    showAlertModal("Error Notifikasi", `Gagal mengaktifkan fitur notifikasi: ${error.message}`, true);
                } finally {
                    // Tampilkan modal PIN setelah proses notifikasi selesai
                    showPinVerificationModal();
                    hideLoader();
                }
            });
        }
        
        loginForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            showLoader(); 
            const email = emailInput.value, password = passwordInput.value; 
            if (!email || !password) { 
                loginError.textContent = "Email & Password wajib diisi."; 
                loginError.classList.remove('hidden'); 
                hideLoader(); 
                return; 
            } 
            try { 
                await signInWithEmailAndPassword(auth, email, password); 
                loginError.classList.add('hidden'); 
                passwordInput.value = ''; 
                // onAuthStateChanged akan menangani sisanya
            } catch (error) { 
                loginError.textContent = "Email atau Password salah."; 
                loginError.classList.remove('hidden'); 
                hideLoader(); 
            }
        });

        function showPinVerificationModal() { 
            loginPage.classList.add('hidden'); 
            mainApp.classList.add('hidden'); 
            pinVerificationModal.classList.remove('hidden'); 
            pinInputField.value = ''; 
            updatePinDashes(); 
            pinError.classList.add('hidden'); 
        }

        pinKeypadModal.addEventListener('click', (e) => { 
            const target = e.target.closest('.ios-keypad-button'); 
            if (!target) return; 
            const value = target.dataset.value; 
            let currentPin = pinInputField.value; 
            if (value === 'backspace') { 
                pinInputField.value = currentPin.slice(0, -1); 
            } else if (currentPin.length < 6) { 
                pinInputField.value = currentPin + value; 
            } 
            updatePinDashes(); 
            pinError.classList.add('hidden'); 
            if (pinInputField.value.length === 6) {
                checkPin(); 
            }
        });

        function updatePinDashes() { 
            const dashes = pinDashes.querySelectorAll('.pin-dash'); 
            const pinLength = pinInputField.value.length; 
            dashes.forEach((dash, index) => { 
                dash.classList.toggle('filled', index < pinLength); 
            }); 
        }

        async function checkPin() {
            const enteredPin = pinInputField.value;
            if (!allLoginData) {
                pinError.textContent = "Data login belum siap.";
                pinError.classList.remove('hidden');
                return;
            }
            let foundUserKey = Object.keys(allLoginData).find(key => allLoginData[key].login && String(allLoginData[key].login) === enteredPin);
            if (foundUserKey) {
                showLoader(); // Tampilkan spinner SEGERA setelah PIN valid
                await handleSuccessfulLogin(foundUserKey);
            } else {
                pinError.textContent = "PIN salah";
                pinError.classList.remove('hidden');
                pinDashes.classList.add('animate-shake');
                setTimeout(() => {
                    pinDashes.classList.remove('animate-shake');
                    pinInputField.value = '';
                    updatePinDashes();
                }, 800);
            }
        }

        async function handleSuccessfulLogin(userKey) {
            try {
                currentUserKey = userKey;

                // Jalankan semua proses inisialisasi secara paralel jika memungkinkan,
                // atau secara sekuensial jika ada dependensi.
                const initPromises = [
                    updateUserDisplayName(userKey),
                    fetchGithubToken(),
                    setOneSignalExternalId(currentUserKey)
                ];
                await Promise.all(initPromises);
                
                // Setup listener setelah data dasar siap
                setupEventListeners();
                initializeDataListeners();

                // Jadwalkan notifikasi dan tampilkan dasbor
                await rescheduleRecurringNotifications();
                displayDashboard();

                if (dashboardUpdateInterval) clearInterval(dashboardUpdateInterval);
                dashboardUpdateInterval = setInterval(displayDashboard, 10000);
                
                // Tampilkan aplikasi setelah semua siap
                pinVerificationModal.classList.add('hidden');
                mainApp.classList.remove('hidden');
                showToast("Verifikasi PIN berhasil!");

            } catch (error) {
                console.error("Error detail saat login:", error);
                showAlertModal("Error", `Terjadi kesalahan setelah login: ${error.message}`, true);
            } finally {
                hideLoader(); // Sembunyikan spinner HANYA setelah semua selesai
            }
        }
        
        async function setOneSignalExternalId(userId) {
            try {
                if (!isOneSignalInitialized || !userId) return;
                const previousUserKey = sessionStorage.getItem('lastUserKeyForOneSignal');
                if (previousUserKey && previousUserKey !== userId) {
                    await removePlayerIdFromFirebase(previousUserKey, OneSignal.User.PushSubscription.id);
                }
                await OneSignal.login(userId);
                await savePlayerIdToFirebase(userId, OneSignal.User.PushSubscription.id);
                sessionStorage.setItem('lastUserKeyForOneSignal', userId);
            } catch (error) {
                console.error("Gagal mengatur OneSignal External ID:", error);
            }
        }

        async function savePlayerIdToFirebase(userId, playerId) { if(!playerId) return; const playerIdsRef = ref(db, `users_data/${userId}/playerIds/${playerId}`); try { await set(playerIdsRef, true); console.log(`Player ID ${playerId} disimpan untuk user ${userId}`); } catch (error) { console.error("Gagal menyimpan Player ID:", error); } }
        async function removePlayerIdFromFirebase(userId, playerId) { if (!userId || !playerId) return; const playerIdsRef = ref(db, `users_data/${userId}/playerIds/${playerId}`); try { await remove(playerIdsRef); console.log(`Player ID ${playerId} dihapus untuk user ${userId}`); } catch (error) { console.error("Gagal menghapus Player ID:", error); } }

        // --- Sisanya adalah fungsi-fungsi aplikasi yang sudah ada ---
        async function updateUserDisplayName(userKey) { if (!userKey || !userDisplayName) return; try { const userName = allLoginData?.[userKey]?.nama || (await get(ref(db, `login/${userKey}/nama`))).val() || "Pengguna"; currentUserName = userName; userDisplayName.textContent = `Halo, ${userName.charAt(0).toUpperCase() + userName.slice(1)}`; } catch (error) { currentUserName = "UnknownUser"; userDisplayName.textContent = "Pengguna"; } }
        async function fetchGithubToken() { try { githubToken = (await get(ref(db, 'token/github'))).val(); if(!githubToken) showAlertModal("Konfigurasi Error", "Token GitHub tidak ditemukan.", true); } catch (error) { showAlertModal("Konfigurasi Error", "Gagal mengambil token GitHub.", true); } }
        logoutBtn.addEventListener('click', async () => { if (hasUnsavedChanges) { showUnsavedChangesModal('logout'); } else { try { if (window.OneSignal) { await OneSignal.logout(); console.log("OneSignal user logged out."); } } catch(e) { console.error("Gagal logout dari OneSignal", e); } sessionStorage.removeItem('lastUserKeyForOneSignal'); if (dashboardUpdateInterval) clearInterval(dashboardUpdateInterval); signOut(auth); } });
        function switchPage(pageId, force = false) { if (!force && hasUnsavedChanges && !el('page-presensi').classList.contains('hidden')) { showUnsavedChangesModal('changePage', pageId); return; } document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden')); el(`page-${pageId}`).classList.remove('hidden'); document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active')); document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active'); if (pageId === 'hasil-rekap') handleTerapkanRekap(); }
        navLinks.forEach(link => { link.addEventListener('click', () => switchPage(link.dataset.page)); });
        function initializeDataListeners() { if (!currentUserKey) return; const userPath = `users_data/${currentUserKey}`; onValue(ref(db, `${userPath}/siswa/`), (s) => { allStudents = s.val() || {}; renderStudentsTable(); updateClassFilters(); displayDashboard(); }); onValue(ref(db, `${userPath}/mapel/`), (s) => { allMapel = s.val() || {}; renderMapelList(); updateMapelFilter(); updateJadwalMapelFilter(); displayDashboard(); }); onValue(ref(db, `${userPath}/jadwal_terstruktur`), (s) => { allJadwalTerstruktur = s.val() || {}; renderJadwalTerstruktur(); displayDashboard(); }); onValue(ref(db, `${userPath}/jadwal`), (s) => { const d = s.val(); const hasImage = d && d.imageUrl; jadwalImage.src = hasImage ? d.imageUrl : ''; jadwalImage.classList.toggle('hidden', !hasImage); jadwalImage.classList.toggle('cursor-pointer', hasImage); jadwalPlaceholder.classList.toggle('hidden', hasImage); jadwalUploadLabel.classList.toggle('hidden', hasImage); deleteJadwalBtn.classList.toggle('hidden', !hasImage); }); onValue(ref(db, `${userPath}/presensi`), (s) => { allPresensiData = s.val() || {}; displayDashboard(); }); onValue(ref(db, `${userPath}/kegiatan`), (s) => { allKegiatanData = s.val() || {}; displayDashboard(); }); }
        const mapelColorPalette = [{ bg: 'bg-sky-100', text: 'text-sky-800' }, { bg: 'bg-amber-100', text: 'text-amber-800' }, { bg: 'bg-violet-100', text: 'text-violet-800' }, { bg: 'bg-lime-100', text: 'text-lime-800' }, { bg: 'bg-rose-100', text: 'text-rose-800' }, { bg: 'bg-teal-100', text: 'text-teal-800' }, { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800' }, { bg: 'bg-indigo-100', text: 'text-indigo-800' }, { bg: 'bg-emerald-100', text: 'text-emerald-800' }, { bg: 'bg-cyan-100', text: 'text-cyan-800' }, { bg: 'bg-pink-100', text: 'text-pink-800' }, { bg: 'bg-green-100', text: 'text-green-800' }, { bg: 'bg-purple-100', text: 'text-purple-800' }];
        const kelasColorPalette = { 'A': { bg: 'bg-red-100', text: 'text-red-800' }, 'B': { bg: 'bg-orange-100', text: 'text-orange-800' }, 'C': { bg: 'bg-yellow-100', text: 'text-yellow-800' }, 'D': { bg: 'bg-green-100', text: 'text-green-800' }, 'E': { bg: 'bg-blue-100', text: 'text-blue-800' }, 'F': { bg: 'bg-purple-100', text: 'text-purple-800' }, 'DEFAULT': { bg: 'bg-gray-100', text: 'text-gray-800' } };
        function getDeterministicColor(str, type) { if (!str) return kelasColorPalette['DEFAULT']; if (type === 'kelas') { const rombel = str.charAt(str.length - 1).toUpperCase(); return kelasColorPalette[rombel] || kelasColorPalette['DEFAULT']; } if (type === 'mapel') { let hash = 0; for (let i = 0; i < str.length; i++) { hash += str.charCodeAt(i); } const index = hash % mapelColorPalette.length; return mapelColorPalette[index]; } return kelasColorPalette['DEFAULT']; }
        const showUnsavedChangesModal = (action, targetPage = null) => { pendingAction = action; pendingPage = targetPage; const content = `<h3 class="text-lg font-bold mb-2">Perubahan Belum Disimpan</h3><p class="text-gray-600 mb-6">Ada perubahan presensi atau nilai yang belum disimpan. Apakah Anda ingin menyimpannya?</p><div class="flex justify-end space-x-2"><button onclick="window.handleUnsavedChangesAction('cancel')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleUnsavedChangesAction('save')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`; openModal(content); }; window.handleUnsavedChangesAction = async (action) => { closeModal(); if (action === 'save') { await handleSaveAllData(); if (pendingAction === 'applyFilter') { handleTerapkanFilter(true); } else if (pendingAction === 'changePage' && pendingPage) { switchPage(pendingPage, true); } else if (pendingAction === 'logout') { logoutBtn.click(); } } pendingAction = null; pendingPage = null; }; function renderFilteredPresensiStudents(filteredStudents) { studentListContainer.innerHTML = ''; if (filteredStudents.length === 0) { studentListContainer.innerHTML = `<p class="col-span-full text-center text-gray-500">Tidak ada siswa yang cocok.</p>`; return; } filteredStudents.forEach((student, index) => { studentListContainer.innerHTML += createStudentCard(student, index, student); }); filteredStudents.forEach(student => { attachHistoryListeners(student.id); }); } function filterPresensiStudents() { const query = searchPresensiStudentInput.value.toLowerCase(); const filtered = currentPresensiStudentsData.filter(student => student.nama.toLowerCase().includes(query)); renderFilteredPresensiStudents(filtered); } function filterAllStudentsTable() { allStudentsTable.innerHTML = ''; const query = searchAllStudentsInput.value.toLowerCase(); const fullStudents = JSON.parse(allStudentsTable.dataset.fullStudents || '[]'); const filteredStudents = fullStudents.filter(student => student.nama.toLowerCase().includes(query) || student.kelas.toLowerCase().includes(query)); let tableRowsHtml = ''; if (filteredStudents.length === 0) { tableRowsHtml = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada data siswa.</td></tr>`; } else { filteredStudents.forEach((student, index) => { tableRowsHtml += `<tr class="border-b hover:bg-gray-50"><td class="p-3 text-center">${index + 1}</td><td class="p-3 font-medium">${student.nama}</td><td class="p-3">${student.kelas}</td><td class="p-3 text-center"><div class="flex justify-center items-center space-x-2"><button onclick="window.showEditStudentModal('${student.id}')" class="p-2 rounded-full hover:bg-blue-100 text-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onclick="window.showDeleteStudentModal('${student.id}', '${student.nama}')" class="p-2 rounded-full hover:bg-red-100 text-red-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></td></tr>`; }); } allStudentsTable.innerHTML = tableRowsHtml; } function filterRekapTable() { const query = searchRekapStudentInput.value.toLowerCase(); const { presensi: presensiData, nilai: nilaiData, kelas } = currentRekapData; if (!presensiData && !nilaiData) { rekapDynamicTableContent.innerHTML = '<p class="text-center text-gray-500">Tidak ada data.</p>'; return; } if (Object.values(allStudents).filter(s => s.kelas === kelas).length === 0) { rekapDynamicTableContent.innerHTML = '<p class="text-center text-gray-500">Tidak ada siswa.</p>'; return; } const sortedDates = Array.from(new Set([...Object.keys(presensiData), ...Object.keys(nilaiData)])).sort(); if (sortedDates.length === 0) { rekapDynamicTableContent.innerHTML = '<p class="text-center text-gray-500">Tidak ada data.</p>'; return; } let tableHTML = `<table class="w-full text-xs text-left whitespace-nowrap"><thead class="bg-gray-100"><tr><th class="p-2 border text-center w-10">No</th><th class="p-2 border text-center">Nama</th>`; sortedDates.forEach(date => { const [y, m, d] = date.split('-'); tableHTML += `<th class="vertical-th border">${d}/${m}/${y.slice(-2)}</th>`; }); tableHTML += `</tr></thead><tbody>`; const statusSymbols = { Hadir: '•', Sakit: 'S', Izin: 'I', Alpa: 'A' }, statusColors = { S: 'text-orange-600', I: 'text-green-600', A: 'text-red-600' }; let filteredCount = 0; Object.entries(allStudents).filter(([id, student]) => student.kelas === kelas).sort(([, a], [, b]) => a.nama.localeCompare(b.nama)).forEach(([studentId, student]) => { if (student.nama.toLowerCase().includes(query)) { tableHTML += `<tr class="border-b"><td class="p-2 border text-center">${filteredCount + 1}</td><td class="p-2 border font-medium">${student.nama}</td>`; sortedDates.forEach(date => { const status = presensiData[date]?.[studentId]?.status, nilai = nilaiData[date]?.[studentId]?.nilai; let cellContent = '-'; if (status || nilai || nilai === 0) { const symbol = status ? statusSymbols[status] || '?' : '•', colorClass = status ? statusColors[status] || '' : '', nilaiHtml = (nilai || nilai === 0) ? `<br><span class="font-bold">${nilai}</span>` : ''; cellContent = `<span class="${colorClass}">${symbol}</span>${nilaiHtml}`; } tableHTML += `<td class="p-2 border text-center">${cellContent}</td>`; }); tableHTML += `</tr>`; filteredCount++; } }); tableHTML += `</tbody></table>`; rekapDynamicTableContent.innerHTML = tableHTML; if (filteredCount === 0 && query !== '') { rekapDynamicTableContent.innerHTML = `<p class="text-center text-gray-500">Siswa tidak ditemukan.</p>`; } }
        function renderStudentsTable() { allStudentsTable.innerHTML = ''; if (Object.keys(allStudents).length === 0) { allStudentsTable.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada siswa.</td></tr>`; return; } const sortedStudents = Object.entries(allStudents).map(([id, data]) => ({ id, ...data })).sort((a, b) => a.kelas.localeCompare(b.kelas) || a.nama.localeCompare(b.nama)); allStudentsTable.dataset.fullStudents = JSON.stringify(sortedStudents); filterAllStudentsTable(); }
        function renderMapelList() { mapelListContainer.innerHTML = ''; if (Object.keys(allMapel).length === 0) { mapelListContainer.innerHTML = `<p class="text-center p-4 text-gray-500">Belum ada mapel.</p>`; return; } Object.entries(allMapel).forEach(([id, mapel]) => { mapelListContainer.innerHTML += `<div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center"><div><p class="font-semibold">${mapel.nama}</p><p class="text-sm text-gray-500">Kelas: ${mapel.kelas}</p></div><div class="flex items-center space-x-2"><button onclick="window.showEditMapelModal('${id}')" class="p-2 rounded-full hover:bg-blue-100 text-blue-600"><i class="fa-solid fa-pencil"></i></button><button onclick="window.showDeleteMapelModal('${id}', '${mapel.nama}', '${mapel.kelas}')" class="p-2 rounded-full hover:bg-red-100 text-red-600"><i class="fa-solid fa-trash"></i></button></div></div>`; }); }
        function updateClassFilters() { availableClasses.clear(); Object.values(allStudents).forEach(s => availableClasses.add(s.kelas)); const classOptionsHtml = '<option value="">Pilih Kelas</option>' + Array.from(availableClasses).sort().map(k => `<option value="${k}">${k}</option>`).join(''); mapelClassSelect.innerHTML = classOptionsHtml; }
        function updateMapelFilter() { const uniqueMapelNames = new Set(Object.values(allMapel).map(m => m.nama)); const mapelOptionsHtml = '<option value="">Pilih Mapel...</option>' + Array.from(uniqueMapelNames).sort().map(name => `<option value="${name}">${name}</option>`).join(''); filterMapel.innerHTML = mapelOptionsHtml; rekapFilterMapel.innerHTML = mapelOptionsHtml; updateClassFilter('presensi'); updateClassFilter('rekap'); }
        function updateJadwalMapelFilter() { const mapelOptions = Object.entries(allMapel).map(([id, m]) => ({ id, nama: m.nama, kelas: m.kelas })).sort((a, b) => a.nama.localeCompare(b.nama) || a.kelas.localeCompare(b.kelas)); jadwalMapelSelect.innerHTML = '<option value="">Pilih Mapel & Kelas...</option>' + mapelOptions.map(m => `<option value="${m.id}">${m.nama} - ${m.kelas}</option>`).join(''); }
        function updateClassFilter(prefix) { const mapelSelect = el(prefix === 'presensi' ? 'filter-mapel' : 'rekap-filter-mapel'); const kelasSelect = el(prefix === 'presensi' ? 'filter-kelas' : 'rekap-filter-kelas'); if (!mapelSelect || !kelasSelect) return; const selectedMapel = mapelSelect.value; kelasSelect.innerHTML = '<option value="">Pilih Kelas...</option>'; if (!selectedMapel) { kelasSelect.disabled = true; return; } const classes = new Set(Object.values(allMapel).filter(m => m.nama === selectedMapel).map(m => m.kelas)); kelasSelect.innerHTML += Array.from(classes).sort().map(k => `<option value="${k}">${k}</option>`).join(''); kelasSelect.disabled = false; }
        function setupEventListeners() { addStudentForm.addEventListener('submit', handleAddStudent); csvUploadInput.addEventListener('change', handleCsvUpload); downloadTemplateBtn.addEventListener('click', handleDownloadTemplate); deleteAllStudentsBtn.addEventListener('click', showDeleteAllStudentsConfirmationModal); addMapelForm.addEventListener('submit', handleAddMapel); toggleModeBtn.addEventListener('click', handleToggleMode); terapkanBtn.addEventListener('click', () => handleTerapkanFilter(false)); deleteDailyDataBtn.addEventListener('click', showDeleteDailyDataConfirmationModal); kegiatanInput.addEventListener('change', handleSaveKegiatan); saveAllBtn.addEventListener('click', handleSaveAllData); terapkanRekapBtn.addEventListener('click', handleTerapkanRekap); filterMapel.addEventListener('change', () => updateClassFilter('presensi')); rekapFilterMapel.addEventListener('change', () => updateClassFilter('rekap')); jadwalUploadInput.addEventListener('change', handleJadwalUpload); deleteJadwalBtn.addEventListener('click', showDeleteJadwalConfirmation); rekapDownloadDropdownBtn.addEventListener('click', toggleRekapDownloadDropdown); downloadCsvBtn.addEventListener('click', handleDownloadCSV); printRekapBtn.addEventListener('click', handlePrintRekap); addJadwalForm.addEventListener('submit', handleAddJadwal); toggleJadwalModeBtn.addEventListener('click', handleToggleJadwalMode); document.addEventListener('click', (e) => { if (!rekapDownloadDropdownBtn.contains(e.target) && !rekapDownloadOptions.contains(e.target)) rekapDownloadOptions.classList.add('hidden'); const openDropdown = document.querySelector('.custom-dropdown-options:not(.hidden)'); if (openDropdown && !openDropdown.previousElementSibling.contains(e.target)) openDropdown.classList.add('hidden'); }); kegiatanHistoryToggleMore.addEventListener('click', () => { const isPartial = kegiatanHistoryToggleMore.dataset.state === 'partial'; kegiatanHistoryToggleMore.dataset.state = isPartial ? 'full' : 'partial'; renderKegiatanHistory(JSON.parse(kegiatanHistoryList.dataset.fullhistory || '[]')); }); searchPresensiStudentInput.addEventListener('input', filterPresensiStudents); searchAllStudentsInput.addEventListener('input', filterAllStudentsTable); searchRekapStudentInput.addEventListener('input', filterRekapTable); jadwalImage.addEventListener('click', () => { if (jadwalImage.src) { fullscreenImage.src = jadwalImage.src; imageViewerModal.classList.remove('hidden'); } }); closeImageViewerBtn.addEventListener('click', () => imageViewerModal.classList.add('hidden')); imageViewerModal.addEventListener('click', (e) => { if (e.target === imageViewerModal) imageViewerModal.classList.add('hidden'); }); window.addEventListener('online', handleOnlineStatus); window.addEventListener('offline', handleOfflineStatus); if (!navigator.onLine) handleOfflineStatus(); }
        function handleAddStudent(e) { e.preventDefault(); const nama = studentNameInput.value.trim().toUpperCase(), kelas = studentClassInput.value.trim().toUpperCase(); if (!nama || !kelas) return showToast("Nama dan kelas wajib diisi.", true); showLoader(); set(push(ref(db, `users_data/${currentUserKey}/siswa`)), { nama, kelas }).then(() => { showToast("Siswa berhasil ditambahkan."); addStudentForm.reset(); refreshRekapTableIfNeeded(); }).catch(err => showAlertModal("Error", `Gagal: ${err.message}`, true)).finally(hideLoader); }
        function handleCsvUpload(e) { const file = e.target.files[0]; if (!file) return; showLoader(); Papa.parse(file, { header: false, skipEmptyLines: true, delimiter: ";", complete: (results) => { const data = {}; results.data.slice(1).forEach(row => { if (Array.isArray(row) && row.length > 2) { const nama = row[1]?.trim().toUpperCase(), kelas = row[2]?.trim().toUpperCase(); if (nama && kelas) data[push(ref(db, `users_data/${currentUserKey}/siswa`)).key] = { nama, kelas }; } }); if (Object.keys(data).length > 0) { update(ref(db, `users_data/${currentUserKey}/siswa`), data).then(() => { showToast(`${Object.keys(data).length} siswa diunggah.`); refreshRekapTableIfNeeded(); }).catch(err => showAlertModal("Error", `Gagal: ${err.message}`, true)).finally(hideLoader); } else { showAlertModal("Gagal", "Tidak ada data valid.", true); hideLoader(); } csvUploadInput.value = ''; }, error: (err) => { showAlertModal("Error", `Gagal: ${err.message}`, true); hideLoader(); } }); }
        function handleDownloadTemplate() { window.open('https://drive.google.com/uc?export=download&id=1itiQBK37vt58iorp2ZIUtKSeu19Z7Dhq', '_blank'); }
        function handleAddMapel(e) { e.preventDefault(); const nama = mapelNameInput.value.trim().toUpperCase(), kelas = mapelClassSelect.value.toUpperCase(); if (!nama || !kelas) return showToast("Nama mapel dan kelas wajib diisi.", true); showLoader(); set(push(ref(db, `users_data/${currentUserKey}/mapel`)), { nama, kelas }).then(() => { showToast("Mapel berhasil ditambahkan."); addMapelForm.reset(); }).catch(err => showAlertModal("Error", `Gagal: ${err.message}`, true)).finally(hideLoader); }
        function handleToggleMode() { currentMode = currentMode === 'presensi' ? 'nilai' : 'presensi'; const isNilai = currentMode === 'nilai'; toggleModeSwitch.style.transform = isNilai ? 'translateX(1.25rem)' : 'translateX(0)'; toggleModeBtn.classList.toggle('bg-blue-600', isNilai); toggleModeBtn.classList.toggle('bg-gray-200', !isNilai); modeLabel.textContent = `Mode: ${isNilai ? 'Nilai' : 'Presensi'}`; if (!contentArea.classList.contains('hidden')) handleTerapkanFilter(false); }
        async function handleTerapkanFilter(force = false) { if (!force && hasUnsavedChanges) return showUnsavedChangesModal('applyFilter'); const selectedMapelName = filterMapel.value, kelas = filterKelas.value, tanggal = filterTanggal.value; if (!selectedMapelName || !kelas || !tanggal) return showToast("Filter harus lengkap.", true); let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas); if (!mapelId) return showAlertModal("Error", "Kombinasi Mapel & Kelas tidak ditemukan.", true); showLoader(); contentArea.classList.remove('hidden'); studentListContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">Memuat...</p>'; await fetchAndRenderKegiatanHistory(kelas, mapelId); const kegiatan = (await get(ref(db, `users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}/${tanggal}`))).val(); kegiatanInput.value = kegiatan?.deskripsi || ''; const studentsInClass = Object.entries(allStudents).filter(([, s]) => s.kelas === kelas).map(([id, d]) => ({ id, ...d })).sort((a, b) => a.nama.localeCompare(b.nama)); if (studentsInClass.length === 0) { studentListContainer.innerHTML = `<p class="col-span-full text-center text-gray-500">Tidak ada siswa di kelas ${kelas}.</p>`; hideLoader(); presensiSearchContainer.classList.add('hidden'); return; } const presensi = (await get(ref(db, `users_data/${currentUserKey}/presensi/${kelas}/${mapelId}/${tanggal}`))).val() || {}; const nilai = (await get(ref(db, `users_data/${currentUserKey}/nilai/${kelas}/${mapelId}/${tanggal}`))).val() || {}; currentPresensiStudentsData = studentsInClass.map(s => ({ ...s, ...presensi[s.id], ...nilai[s.id] })); presensiSearchContainer.classList.remove('hidden'); searchPresensiStudentInput.value = ''; filterPresensiStudents(); hasUnsavedChanges = false; hideLoader(); }
        function handleSaveKegiatan() { const selectedMapelName = filterMapel.value, kelas = filterKelas.value, tanggal = filterTanggal.value; let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas); if (!mapelId || !kelas || !tanggal) return; set(ref(db, `users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}/${tanggal}`), { deskripsi: kegiatanInput.value.trim() }).then(() => { kegiatanInput.classList.add('border-green-500'); setTimeout(() => kegiatanInput.classList.remove('border-green-500'), 1500); }).catch(err => showAlertModal("Error", `Gagal menyimpan: ${err.message}`, true)); }
        async function handleSaveAllData() { const selectedMapelName = filterMapel.value, kelas = filterKelas.value, tanggal = filterTanggal.value; if (!selectedMapelName || !kelas || !tanggal) return showAlertModal("Error", "Filter tidak lengkap.", true); let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas); if (!mapelId) return showAlertModal("Error", "Kombinasi Mapel & Kelas tidak valid.", true); showLoader(); const updates = {}; let hasInvalidGrade = false; currentPresensiStudentsData.forEach(s => { const presensiPath = `users_data/${currentUserKey}/presensi/${kelas}/${mapelId}/${tanggal}/${s.id}`; const nilaiPath = `users_data/${currentUserKey}/nilai/${kelas}/${mapelId}/${tanggal}/${s.id}`; if (currentMode === 'presensi') { updates[presensiPath] = { status: s.status || 'Hadir', ...(s.catatan && {catatan: s.catatan}) }; if (s.hasOwnProperty('nilai')) { const nVal = String(s.nilai).trim(); if (nVal === '') { updates[nilaiPath] = null; } else { const n = parseFloat(nVal.replace(',', '.')); if (!isNaN(n) && n >= 0 && n <= 100) updates[nilaiPath] = { nilai: n }; else hasInvalidGrade = true; } } } else { if (s.hasOwnProperty('status')) updates[presensiPath] = { status: s.status, ...(s.catatan && {catatan: s.catatan}) }; const nVal = s.nilai; if (nVal === undefined || nVal === null || String(nVal).trim() === '') { updates[nilaiPath] = { nilai: 0 }; } else { const n = parseFloat(String(nVal).replace(',', '.')); if (isNaN(n) || n < 0 || n > 100) hasInvalidGrade = true; else updates[nilaiPath] = { nilai: n }; } } }); if (hasInvalidGrade) { hideLoader(); return showAlertModal("Gagal", "Nilai harus antara 0-100.", true); } if (Object.keys(updates).length === 0 && !hasUnsavedChanges) { if (currentMode === 'presensi') { currentPresensiStudentsData.forEach(s => { updates[`users_data/${currentUserKey}/presensi/${kelas}/${mapelId}/${tanggal}/${s.id}`] = { status: 'Hadir' }; }); } else { hideLoader(); return showToast("Tidak ada perubahan.", true); } } if (navigator.onLine) { try { await update(ref(db), updates); showToast("Semua perubahan disimpan."); hasUnsavedChanges = false; handleTerapkanFilter(true); } catch (err) { hideLoader(); showAlertModal("Error", `Gagal menyimpan: ${err.message}`, true); } } else { const pending = JSON.parse(localStorage.getItem('pending-updates') || '{}'); Object.assign(pending, updates); localStorage.setItem('pending-updates', JSON.stringify(pending)); showToast("Offline. Perubahan disimpan lokal."); hasUnsavedChanges = false; hideLoader(); } }
        function createStudentCard(student, index, studentData) { const { id, nama } = student; let inputSection; const hasCatatan = studentData.catatan && studentData.catatan.length > 0; if (currentMode === 'presensi') { const initialStatus = studentData.status || 'Hadir'; const statusColors = { Hadir: 'bg-gray-200 text-gray-800', Sakit: 'bg-orange-500 text-white', Izin: 'bg-green-500 text-white', Alpa: 'bg-red-500 text-white' }; inputSection = ` <label class="text-sm font-medium">Presensi:</label> <div class="relative mt-1"> <button id="dropdown-button-${id}" onclick="window.toggleDropdown(this, '${id}')" class="custom-dropdown-button w-full p-2 rounded-lg text-left font-medium cursor-pointer ${statusColors[initialStatus]} flex justify-between items-center"> <span>${initialStatus}</span> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg> </button> <div id="dropdown-options-${id}" class="custom-dropdown-options hidden absolute z-10 w-full mt-1 bg-white rounded-lg shadow-lg border"> <div onclick="window.selectOption(this, '${id}')" data-value="Hadir" class="px-4 py-2 cursor-pointer hover:bg-gray-100">Hadir</div> <div onclick="window.selectOption(this, '${id}')" data-value="Sakit" class="px-4 py-2 cursor-pointer font-medium text-orange-800 bg-orange-100 hover:bg-orange-200">Sakit</div> <div onclick="window.selectOption(this, '${id}')" data-value="Izin" class="px-4 py-2 cursor-pointer font-medium text-green-800 bg-green-100 hover:bg-green-200">Izin</div> <div onclick="window.selectOption(this, '${id}')" data-value="Alpa" class="px-4 py-2 cursor-pointer font-medium text-red-800 bg-red-100 hover:bg-red-200">Alpa</div> </div> </div> <div class="mt-2 text-xs"> <label class="inline-flex items-center"> <input type="checkbox" id="catatan-checkbox-${id}" onchange="window.toggleCatatan(this, '${id}')" ${hasCatatan ? 'checked' : ''} class="form-checkbox h-4 w-4 text-blue-600"> <span class="ml-2">Catatan?</span> </label> </div> <textarea id="catatan-input-${id}" oninput="window.updateCatatanValue(this, '${id}')" class="w-full mt-1 p-2 border rounded-lg text-sm ${hasCatatan ? '' : 'hidden'}" placeholder="...">${studentData.catatan || ''}</textarea> `; } else { const initialNilai = (studentData.nilai !== undefined && studentData.nilai !== null) ? studentData.nilai : ''; inputSection = ` <label class="text-sm font-medium">Nilai:</label> <input type="text" id="nilai-input-${id}" value="${initialNilai}" placeholder="0" inputmode="decimal" class="w-full mt-1 p-2 border rounded-lg" oninput="window.updateNilaiValue(this, '${id}')"> `; } return ` <div class="bg-white rounded-xl shadow-md" data-studentid="${id}"> <div class="flex items-center p-3 bg-sky-50 rounded-t-xl"> <span class="bg-blue-500 text-white font-bold w-7 h-7 flex items-center justify-center rounded-md mr-3">${index + 1}</span> <h4 class="font-bold">${nama}</h4> </div> <div class="p-4"> <div class="mb-4">${inputSection}</div> <div class="border-t pt-3"> <h5 class="text-sm font-semibold mb-2">Riwayat</h5> <div id="history-${id}" class="space-y-1 text-xs"><p class="text-center">Memuat...</p></div> <button id="history-toggle-${id}" onclick="window.toggleHistory('${id}')" data-state="partial" class="text-blue-600 text-xs mt-2 hidden">Lainnya &darr;</button> </div> </div> </div> `; }
        async function attachHistoryListeners(studentId) { const selectedMapelName = filterMapel.value, kelas = filterKelas.value; let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas); if (!mapelId) return; const [presensi, nilai] = await Promise.all([get(ref(db, `users_data/${currentUserKey}/presensi`)), get(ref(db, `users_data/${currentUserKey}/nilai`))]); const allPresensi = presensi.val() || {}, allNilai = nilai.val() || {}; const mergedHistory = {}; if (allPresensi[kelas]?.[mapelId]) { for (const t in allPresensi[kelas][mapelId]) { if (allPresensi[kelas][mapelId][t][studentId]) { if (!mergedHistory[t]) mergedHistory[t] = {}; mergedHistory[t] = { ...allPresensi[kelas][mapelId][t][studentId] }; } } } if (allNilai[kelas]?.[mapelId]) { for (const t in allNilai[kelas][mapelId]) { if (allNilai[kelas][mapelId][t][studentId]) { if (!mergedHistory[t]) mergedHistory[t] = {}; mergedHistory[t].nilai = allNilai[kelas][mapelId][t][studentId].nilai; } } } renderHistory(studentId, Object.entries(mergedHistory).map(([t, d]) => ({ tanggal: t, data: d })).sort((a,b) => b.tanggal.localeCompare(a.tanggal))); }
        function formatDateToIndonesian(date) { return date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }
        function renderHistory(studentId, historyData) { const container = el(`history-${studentId}`), toggleBtn = el(`history-toggle-${studentId}`); if (!container) return; container.innerHTML = ''; if (historyData.length === 0) { container.innerHTML = '<p class="text-center text-gray-400">Tidak ada riwayat.</p>'; toggleBtn.classList.add('hidden'); return; } container.dataset.fullhistory = JSON.stringify(historyData); const isPartial = toggleBtn.dataset.state === 'partial'; const dataToShow = isPartial ? historyData.slice(0, 2) : historyData; const statusColors = { Sakit: 'text-orange-500', Izin: 'text-green-500', Alpa: 'text-red-500' }; dataToShow.forEach(item => { const [y,m,d] = item.tanggal.split('-'), date = new Date(y,m-1,d); const dateFormatted = date.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'}); const status = item.data.status, nilai = item.data.nilai, catatan = item.data.catatan ? `<br><i class="text-gray-500">"${item.data.catatan}"</i>` : ''; let statusHtml = status ? `<span class="${statusColors[status] || ''}">${status}</span>` : ''; let displayText = statusHtml; if (nilai !== undefined && nilai !== null) displayText += (displayText ? ' - ' : '') + `<b>${nilai}</b>`; if (!displayText) displayText = 'Data tersimpan'; container.innerHTML += `<div class="flex justify-between"><p>${dateFormatted}</p><p class="font-semibold text-right">${displayText}${catatan}</p></div>`; }); toggleBtn.classList.toggle('hidden', historyData.length <= 2); toggleBtn.innerHTML = isPartial ? 'Lainnya &darr;' : 'Ringkas &uarr;'; }
        function renderKegiatanHistory(historyData) { kegiatanHistoryList.innerHTML = ''; if (historyData.length === 0) { kegiatanHistoryList.innerHTML = '<p class="text-center text-gray-400">Tidak ada riwayat.</p>'; kegiatanHistoryToggleMore.classList.add('hidden'); return; } kegiatanHistoryList.dataset.fullhistory = JSON.stringify(historyData); const isPartial = kegiatanHistoryToggleMore.dataset.state === 'partial'; const dataToShow = isPartial ? historyData.slice(0, 2) : historyData; dataToShow.forEach(item => { const [y,m,d] = item.tanggal.split('-'), date = new Date(y,m-1,d); kegiatanHistoryList.innerHTML += `<div class="p-2 border-b"><p class="font-semibold">${formatDateToIndonesian(date)}</p><p class="text-gray-600">${item.deskripsi}</p></div>`; }); kegiatanHistoryToggleMore.classList.toggle('hidden', historyData.length <= 2); kegiatanHistoryToggleMore.innerHTML = isPartial ? 'Lainnya &darr;' : 'Ringkas &uarr;'; }
        async function fetchAndRenderKegiatanHistory(kelas, mapelId) { kegiatanHistoryList.innerHTML = '<p>Memuat...</p>'; const allKegiatan = (await get(ref(db, `users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}`))).val() || {}; const historyList = Object.entries(allKegiatan).filter(([,d]) => d.deskripsi).map(([t,d]) => ({ tanggal: t, deskripsi: d.deskripsi })).sort((a,b) => b.tanggal.localeCompare(a.tanggal)); renderKegiatanHistory(historyList); }
        async function handleJadwalUpload(e) { const file = e.target.files[0]; if (!file || !currentUserKey || !currentUserName) return showAlertModal("Error", "Info pengguna tidak lengkap.", true); if (!githubToken) return showAlertModal("Error", "Token GitHub tidak ditemukan.", true); if (!file.type.startsWith('image/')) return showAlertModal("Error", "Pilih file gambar.", true); showLoader(); const sanitizedUserName = sanitizeForPath(currentUserName); const filePath = `schedules/${currentUserKey}/${sanitizedUserName}/schedule.jpg`; const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`; try { const content = await fileToBase64(file); let sha = null; try { const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${githubToken}` } }); if (res.ok) sha = (await res.json()).sha; } catch (e) {} const payload = { message: `Update jadwal ${new Date().toISOString()}`, content, sha }; const res = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!res.ok) throw new Error((await res.json()).message); const data = await res.json(); await set(ref(db, `users_data/${currentUserKey}/jadwal`), { imageUrl: data.content.download_url }); showToast("Jadwal berhasil diunggah."); } catch (error) { showAlertModal("Gagal", `Gagal mengunggah: ${error.message}`, true); } finally { jadwalUploadInput.value = ''; hideLoader(); } }
        function showDeleteJadwalConfirmation() { openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Jadwal?</h3><p class="mb-6">Yakin ingin menghapus gambar jadwal?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteJadwal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`); }
        async function handleDeleteJadwal() { if (!currentUserKey || !currentUserName || !githubToken) return showAlertModal("Error", "Info tidak lengkap.", true); closeModal(); showLoader(); const sanitizedUserName = sanitizeForPath(currentUserName); const filePath = `schedules/${currentUserKey}/${sanitizedUserName}/schedule.jpg`; const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`; try { const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${githubToken}` } }); if (res.ok) { const { sha } = await res.json(); const delRes = await fetch(apiUrl, { method: 'DELETE', headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify({ message: `Hapus jadwal ${new Date().toISOString()}`, sha }) }); if (!delRes.ok) throw new Error((await delRes.json()).message); } await remove(ref(db, `users_data/${currentUserKey}/jadwal`)); showToast("Jadwal berhasil dihapus."); } catch (error) { showAlertModal("Gagal", `Gagal menghapus: ${error.message}`, true); } finally { hideLoader(); } };
        window.updateStudentDataInMemory=(s,d)=>{const i=currentPresensiStudentsData.findIndex(p=>p.id===s);if(i>-1){currentPresensiStudentsData[i]={...currentPresensiStudentsData[i],...d};hasUnsavedChanges=true;}};window.selectOption=(o,s)=>{const v=o.dataset.value,b=el(`dropdown-button-${s}`);const c={Hadir:'bg-gray-200 text-gray-800',Sakit:'bg-orange-500 text-white',Izin:'bg-green-500 text-white',Alpa:'bg-red-500 text-white'};b.querySelector('span').textContent=v;b.className=`custom-dropdown-button w-full p-2 rounded-lg text-left font-medium cursor-pointer ${c[v]} flex justify-between items-center`;window.updateStudentDataInMemory(s,{status:v});o.parentElement.classList.add('hidden');};window.toggleCatatan=(c,s)=>{const t=el(`catatan-input-${s}`);t.classList.toggle('hidden',!c.checked);window.updateStudentDataInMemory(s,{catatan:c.checked?t.value.trim():null});};window.updateCatatanValue=(t,s)=>{window.updateStudentDataInMemory(s,{catatan:t.value.trim()});};window.updateNilaiValue=(i,s)=>{window.updateStudentDataInMemory(s,{nilai:i.value});};window.toggleDropdown=(b,s)=>{const o=b.nextElementSibling;document.querySelectorAll('.custom-dropdown-options').forEach(opt=>{if(opt!==o)opt.classList.add('hidden');});o.classList.toggle('hidden');};
        window.showEditStudentModal=(s)=>{const d=allStudents[s];let c='';Array.from(availableClasses).sort().forEach(k=>{c+=`<option value="${k}" ${k===d.kelas?'selected':''}>${k}</option>`;});openModal(`<h3 class="text-lg font-bold mb-4">Edit Siswa</h3><div class="mb-4"><label>Nama</label><input type="text" id="edit-student-name" value="${d.nama}" class="w-full mt-1 p-2 border rounded-lg"></div><div class="mb-6"><label>Kelas</label><select id="edit-student-class" class="w-full mt-1 p-2 border rounded-lg">${c}</select></div><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleEditStudent('${s}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`);};window.handleEditStudent=(s)=>{const n=el('edit-student-name').value.trim().toUpperCase(),c=el('edit-student-class').value.toUpperCase();if(!n||!c)return showToast("Nama & kelas wajib.",true);showLoader();update(ref(db,`users_data/${currentUserKey}/siswa/${s}`),{nama:n,kelas:c}).then(()=>{showToast("Data siswa diperbarui.");closeModal();refreshRekapTableIfNeeded();}).catch(e=>showAlertModal("Error",e.message,true)).finally(hideLoader);};window.showDeleteStudentModal=(s,n)=>{openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Siswa?</h3><p class="mb-6">Yakin hapus <b>${n}</b> dan semua datanya?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteStudent('${s}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`);};window.handleDeleteStudent=async(s)=>{showLoader();try{const u={};u[`users_data/${currentUserKey}/siswa/${s}`]=null;const[p,n]=await Promise.all([get(ref(db,`users_data/${currentUserKey}/presensi`)),get(ref(db,`users_data/${currentUserKey}/nilai`))]);const ap=p.val()||{},an=n.val()||{};for(const k in ap){for(const m in ap[k]){if(ap[k][m][s])u[`users_data/${currentUserKey}/presensi/${k}/${m}/${s}`]=null;}}for(const k in an){for(const m in an[k]){if(an[k][m][s])u[`users_data/${currentUserKey}/nilai/${k}/${m}/${s}`]=null;}}await update(ref(db),u);showToast("Siswa dihapus.");closeModal();refreshRekapTableIfNeeded();}catch(e){showAlertModal("Error",e.message,true);}finally{hideLoader();}};
        window.showEditMapelModal=(m)=>{const d=allMapel[m];let c='';Array.from(availableClasses).sort().forEach(k=>{c+=`<option value="${k}" ${k===d.kelas?'selected':''}>${k}</option>`;});openModal(`<h3 class="text-lg font-bold mb-4">Edit Mapel</h3><div class="mb-4"><label>Nama</label><input type="text" id="edit-mapel-name" value="${d.nama}" class="w-full mt-1 p-2 border rounded-lg"></div><div class="mb-6"><label>Kelas</label><select id="edit-mapel-class" class="w-full mt-1 p-2 border rounded-lg">${c}</select></div><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleEditMapel('${m}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`);};window.handleEditMapel=(m)=>{const n=el('edit-mapel-name').value.trim().toUpperCase(),c=el('edit-mapel-class').value.toUpperCase();if(!n||!c)return showToast("Nama & kelas wajib.",true);showLoader();update(ref(db,`users_data/${currentUserKey}/mapel/${m}`),{nama:n,kelas:c}).then(()=>{showToast("Mapel diperbarui.");closeModal();}).catch(e=>showAlertModal("Error",e.message,true)).finally(hideLoader);};window.showDeleteMapelModal=(m,n,c)=>{openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Mapel?</h3><p class="mb-6">Yakin hapus <b>${n} (${c})</b> dan semua datanya?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteMapel('${m}','${c}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`);};window.handleDeleteMapel=async(m,c)=>{showLoader();try{const u={};u[`users_data/${currentUserKey}/mapel/${m}`]=null;u[`users_data/${currentUserKey}/presensi/${c}/${m}`]=null;u[`users_data/${currentUserKey}/nilai/${c}/${m}`]=null;u[`users_data/${currentUserKey}/kegiatan/${c}/${m}`]=null;const s={};for(const d in allJadwalTerstruktur){for(const i in allJadwalTerstruktur[d]){if(allJadwalTerstruktur[d][i].mapelId===m)s[`users_data/${currentUserKey}/jadwal_terstruktur/${d}/${i}`]=null;}}await update(ref(db),s);await update(ref(db),u);showToast("Mapel dihapus.");closeModal();refreshRekapTableIfNeeded();}catch(e){showAlertModal("Error",e.message,true);}finally{hideLoader();}};
        window.toggleHistory=(s)=>{const t=el(`history-toggle-${s}`),c=el(`history-${s}`),h=JSON.parse(c.dataset.fullhistory||'[]');if(t.dataset.state==='partial'){t.dataset.state='full';t.innerHTML='Ringkas &uarr;';}else{t.dataset.state='partial';t.innerHTML='Lainnya &darr;';}renderHistory(s,h);};
        async function handleTerapkanRekap() { const selectedMapelName = rekapFilterMapel.value, kelas = rekapFilterKelas.value; if (!selectedMapelName || !kelas) { rekapDynamicTableContent.innerHTML = '<p class="text-center text-gray-500">Pilih Mapel & Kelas.</p>'; rekapSearchContainer.classList.add('hidden'); rekapDownloadDropdownBtn.classList.add('hidden'); return; } let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === selectedMapelName && allMapel[id].kelas === kelas); if (!mapelId) return showAlertModal("Error", "Kombinasi tidak ditemukan.", true); showLoader(); rekapDynamicTableContent.innerHTML = '<p class="text-center text-gray-500">Memuat...</p>'; const [presensi, nilai] = await Promise.all([get(ref(db, `users_data/${currentUserKey}/presensi/${kelas}/${mapelId}`)), get(ref(db, `users_data/${currentUserKey}/nilai/${kelas}/${mapelId}`))]); currentRekapData = { presensi: presensi.val() || {}, nilai: nilai.val() || {}, kelas }; rekapSearchContainer.classList.remove('hidden'); rekapDownloadDropdownBtn.classList.remove('hidden'); searchRekapStudentInput.value = ''; filterRekapTable(); hideLoader(); }
        function toggleRekapDownloadDropdown() { rekapDownloadOptions.classList.toggle('hidden'); }
        function handleDownloadCSV() { rekapDownloadOptions.classList.add('hidden'); const table = rekapDynamicTableContent.querySelector('table'); if (!table) return showToast("Tidak ada data.", true); let csv = [Array.from(table.querySelectorAll('tr')[0].querySelectorAll('th')).map(th => th.textContent.trim()).join(';')]; for (let i = 1; i < table.rows.length; i++) { csv.push(Array.from(table.rows[i].querySelectorAll('td')).map(td => `"${td.textContent.trim().replace(/\s*\n\s*/g, ' - ')}"`).join(';')); } const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const mapel = allMapel[rekapFilterMapel.value]; a.download = `rekap_${mapel?.nama.replace(/\s/g, '_')}_${mapel?.kelas}.csv` || 'rekap.csv'; a.click(); URL.revokeObjectURL(url); showToast("CSV diunduh."); }
        function handlePrintRekap() { rekapDownloadOptions.classList.add('hidden'); const content = rekapDynamicTableContent.innerHTML; if (!content || content.includes('Tidak ada data')) return showToast("Tidak ada data.", true); const pW = window.open('', '', 'height=600,width=800'); pW.document.write('<html><head><title>Cetak Rekap</title><link href="https://cdn.tailwindcss.com" rel="stylesheet"><style>body{font-family:Inter,sans-serif;margin:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #e2e8f0;padding:8px}th{background-color:#f1f5f9}.vertical-th{writing-mode:vertical-rl;transform:rotate(180deg)}@media print{body{-webkit-print-color-adjust:exact}th{background-color:#f1f5f9!important}}</style></head><body><h1>Rekapitulasi</h1>'); pW.document.write(content); pW.document.write('</body></html>'); pW.document.close(); pW.print(); }
        function refreshRekapTableIfNeeded() { const rekapPage = el('page-hasil-rekap'); if (!rekapPage.classList.contains('hidden') && rekapFilterMapel.value) handleTerapkanRekap(); }
        function showDeleteAllStudentsConfirmationModal() { const content = `<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Semua Data?</h3><p class="mb-4">Tindakan ini akan **menghapus semua data siswa, presensi, nilai, mapel, dan jadwal secara permanen!**</p><p class="mb-6">Masukkan password Anda:</p><div class="mb-4"><label for="confirm-password">Password</label><input type="password" id="confirm-password" class="w-full mt-1 p-2 border rounded-lg" required><p id="confirm-password-error" class="text-red-500 mt-2 hidden"></p></div><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button id="confirm-delete-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus Semua</button></div>`; openModal(content); el('confirm-delete-all-btn').addEventListener('click', handleDeleteAllStudents); }
        async function handleDeleteAllStudents() { const pw = el('confirm-password').value, errEl = el('confirm-password-error'); if (!pw) { errEl.textContent = "Password wajib diisi."; errEl.classList.remove('hidden'); return; } errEl.classList.add('hidden'); showLoader(); const user = auth.currentUser; if (!user) { closeModal(); hideLoader(); return showAlertModal("Gagal", "Tidak terautentikasi.", true); } try { await reauthenticateWithCredential(user, EmailAuthProvider.credential(user.email, pw)); await remove(ref(db, `users_data/${currentUserKey}`)); showToast("Semua data berhasil dihapus."); closeModal(); allStudents = {}; allMapel = {}; allJadwalTerstruktur = {}; availableClasses.clear(); currentPresensiStudentsData = []; currentRekapData = { presensi: {}, nilai: {}, kelas: '' }; renderStudentsTable(); renderMapelList(); updateMapelFilter(); updateClassFilters(); studentListContainer.innerHTML = ''; rekapDynamicTableContent.innerHTML = ''; contentArea.classList.add('hidden'); kegiatanInput.value = ''; } catch (error) { if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { errEl.textContent = "Password salah."; errEl.classList.remove('hidden');} else { showAlertModal("Error", `Gagal menghapus: ${error.message}`, true); } } finally { hideLoader(); } }
        function showDeleteDailyDataConfirmationModal() { const mapel = filterMapel.value, kelas = filterKelas.value, tgl = filterTanggal.value; if (!mapel || !kelas || !tgl) return showToast("Filter harus lengkap.", true); const date = new Date(tgl + 'T00:00:00'); const content = `<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Data Hari Ini?</h3><p class="mb-6">Yakin ingin menghapus data <b>${mapel} (${kelas})</b> pada <b>${formatDateToIndonesian(date)}</b>?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleDeleteDailyData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`; openModal(content); }
        async function handleDeleteDailyData() { const mapel = filterMapel.value, kelas = filterKelas.value, tgl = filterTanggal.value; let mapelId = Object.keys(allMapel).find(id => allMapel[id].nama === mapel && allMapel[id].kelas === kelas); if (!mapelId) return showAlertModal("Error", "Gagal menemukan data.", true); closeModal(); showLoader(); try { const updates = {}; updates[`users_data/${currentUserKey}/presensi/${kelas}/${mapelId}/${tgl}`] = null; updates[`users_data/${currentUserKey}/nilai/${kelas}/${mapelId}/${tgl}`] = null; updates[`users_data/${currentUserKey}/kegiatan/${kelas}/${mapelId}/${tgl}`] = null; await update(ref(db), updates); showToast("Data hari ini dihapus."); handleTerapkanFilter(true); } catch (err) { showAlertModal("Error", `Gagal: ${err.message}`, true); } finally { hideLoader(); } }
        async function scheduleNewNotification(scheduleData) {
            const { hari, jam_mulai, mapelNama, kelas, mapelId } = scheduleData;
            const scheduleTime = getNextScheduleDateTime(hari, jam_mulai);
            if (!scheduleTime || !currentUserKey) return null;
            
            const result = await callCloudflareWorker('schedule', {
                userId: currentUserKey,
                scheduleTime: scheduleTime,
                heading: `Saatnya Mengajar!`,
                content: `Anda punya jadwal ${mapelNama} di kelas ${kelas}.`,
                deepLinkData: { page: 'presensi', mapelId, kelas }
            });

            if (result && result.id) {
                console.log('Notifikasi berhasil dijadwalkan:', result.id);
                const scheduledDate = new Date(scheduleTime.replace(' GMT+0700', ''));
                return {
                    notificationId: result.id,
                    notificationScheduledUntil: scheduledDate.getTime()
                };
            }
            return null;
        }
        async function cancelScheduledNotification(notificationId) {
            if (!notificationId) return;
            await callCloudflareWorker('cancel', { notificationId });
            console.log(`Permintaan pembatalan untuk notifikasi ${notificationId} telah dikirim.`);
        }
        async function rescheduleRecurringNotifications() {
            console.log("Memeriksa jadwal untuk penjadwalan ulang notifikasi...");
            if (!allJadwalTerstruktur || Object.keys(allJadwalTerstruktur).length === 0) {
                console.log("Tidak ada jadwal terstruktur untuk diperiksa.");
                return;
            }
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
            const todayTimestamp = now.getTime();
            const updates = {};
            for (const day in allJadwalTerstruktur) {
                for (const scheduleId in allJadwalTerstruktur[day]) {
                    const schedule = allJadwalTerstruktur[day][scheduleId];
                    if (schedule.notificationScheduledUntil && schedule.notificationScheduledUntil >= todayTimestamp) {
                        continue;
                    }
                    console.log(`Menjadwalkan ulang untuk: ${schedule.mapelNama} hari ${day}`);
                    const newNotificationData = await scheduleNewNotification({ ...schedule, hari: day });
                    if (newNotificationData) {
                        const schedulePath = `users_data/${currentUserKey}/jadwal_terstruktur/${day}/${scheduleId}`;
                        updates[`${schedulePath}/notificationId`] = newNotificationData.notificationId;
                        updates[`${schedulePath}/notificationScheduledUntil`] = newNotificationData.notificationScheduledUntil;
                    }
                }
            }
            if (Object.keys(updates).length > 0) {
                console.log("Menerapkan pembaruan penjadwalan notifikasi...", updates);
                await update(ref(db), updates);
                showToast("Jadwal notifikasi telah diperbarui.", false);
            } else {
                console.log("Semua notifikasi sudah up-to-date.");
            }
        }
        async function handleAddJadwal(e) {
            e.preventDefault();
            const hari = jadwalHariSelect.value, jam_mulai = jadwalJamMulaiInput.value, jam_selesai = jadwalJamSelesaiInput.value, mapelId = jadwalMapelSelect.value;
            if (!hari || !jam_mulai || !jam_selesai || !mapelId) return showToast("Semua kolom wajib diisi.", true);
            if (jam_mulai >= jam_selesai) return showToast("Jam mulai harus sebelum jam selesai.", true);
            
            showLoader();
            const mapelData = allMapel[mapelId];
            const newScheduleData = { jam_mulai, jam_selesai, mapelId, mapelNama: mapelData.nama, kelas: mapelData.kelas };
            const newScheduleRef = push(ref(db, `users_data/${currentUserKey}/jadwal_terstruktur/${hari}`));

            try {
                const newNotificationData = await scheduleNewNotification({ ...newScheduleData, hari });
                if (newNotificationData) {
                    newScheduleData.notificationId = newNotificationData.notificationId;
                    newScheduleData.notificationScheduledUntil = newNotificationData.notificationScheduledUntil;
                }
                await set(newScheduleRef, newScheduleData);
                showToast("Jadwal berhasil ditambahkan.");
                addJadwalForm.reset();
            } catch (err) {
                showAlertModal("Error", `Gagal menambahkan jadwal: ${err.message}`, true);
            } finally {
                hideLoader();
            }
        }
        function renderJadwalTerstruktur() { jadwalTerstrukturContainer.innerHTML = ''; const daysOrder = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu']; daysOrder.forEach(day => { const daySchedule = allJadwalTerstruktur[day]; if (daySchedule) { const dayName = day.charAt(0).toUpperCase() + day.slice(1); let dayHtml = `<div class="mb-4"><h4 class="text-md font-bold border-b pb-2 mb-2">${dayName}</h4><div class="space-y-2">`; Object.entries(daySchedule).sort(([,a],[,b])=>a.jam_mulai.localeCompare(b.jam_mulai)).forEach(([id, item]) => { dayHtml += `<div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center"><div><p class="font-medium">${item.jam_mulai} - ${item.jam_selesai}</p><p class="text-sm text-gray-600">${item.mapelNama} - ${item.kelas}</p></div><div class="flex items-center"><button onclick="window.showEditJadwalModal('${day}','${id}')" class="p-2 rounded-full hover:bg-blue-100 text-blue-600"><i class="fa-solid fa-pencil"></i></button><button onclick="window.handleDeleteJadwalEntry('${day}','${id}')" class="p-2 rounded-full hover:bg-red-100 text-red-600"><i class="fa-solid fa-trash"></i></button></div></div>`; }); dayHtml += `</div></div>`; jadwalTerstrukturContainer.innerHTML += dayHtml; } }); if (jadwalTerstrukturContainer.innerHTML === '') jadwalTerstrukturContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada jadwal.</p>'; }
        window.showEditJadwalModal = (day, scheduleId) => { const jadwal = allJadwalTerstruktur[day]?.[scheduleId]; if(!jadwal) return; let dayOpts = '', mapelOpts = ''; ['senin','selasa','rabu','kamis','jumat','sabtu'].forEach(d=>{dayOpts+=`<option value="${d}" ${d===day?'selected':''}>${d.charAt(0).toUpperCase()+d.slice(1)}</option>`;}); Object.entries(allMapel).sort(([,a],[,b])=>a.nama.localeCompare(b.nama)||a.kelas.localeCompare(b.kelas)).forEach(([id,m])=>{mapelOpts+=`<option value="${id}" ${id===jadwal.mapelId?'selected':''}>${m.nama} - ${m.kelas}</option>`;}); openModal(`<h3 class="text-lg font-bold mb-4">Edit Jadwal</h3><div class="space-y-4"><div><label for="edit-jadwal-hari" class="block text-sm font-medium text-gray-700 mb-1">Hari</label><select id="edit-jadwal-hari" class="w-full p-2 border rounded-lg bg-gray-50">${dayOpts}</select></div><div class="grid grid-cols-2 gap-4"><div><label for="edit-jadwal-jam-mulai" class="block text-sm font-medium text-gray-700 mb-1">Mulai</label><input type="time" id="edit-jadwal-jam-mulai" value="${jadwal.jam_mulai}" class="w-full p-2 border rounded-lg bg-gray-50"></div><div><label for="edit-jadwal-jam-selesai" class="block text-sm font-medium text-gray-700 mb-1">Selesai</label><input type="time" id="edit-jadwal-jam-selesai" value="${jadwal.jam_selesai}" class="w-full p-2 border rounded-lg bg-gray-50"></div></div><div><label for="edit-jadwal-mapel" class="block text-sm font-medium text-gray-700 mb-1">Mapel</label><select id="edit-jadwal-mapel" class="w-full p-2 border rounded-lg bg-gray-50">${mapelOpts}</select></div></div><div class="flex justify-end space-x-2 mt-6"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.handleEditJadwal('${day}','${scheduleId}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div>`); }
        async function handleEditJadwal(originalDay, scheduleId) {
            const newDay = el('edit-jadwal-hari').value, newStart = el('edit-jadwal-jam-mulai').value, newEnd = el('edit-jadwal-jam-selesai').value, newMapelId = el('edit-jadwal-mapel').value;
            if (!newDay || !newStart || !newEnd || !newMapelId) return showToast("Semua kolom wajib.", true);
            if (newStart >= newEnd) return showToast("Jam tidak valid.", true);

            showLoader();
            try {
                const originalSchedule = allJadwalTerstruktur[originalDay]?.[scheduleId];
                if (originalSchedule?.notificationId) {
                    await cancelScheduledNotification(originalSchedule.notificationId);
                }

                const mapelData = allMapel[newMapelId];
                const updatedData = { jam_mulai: newStart, jam_selesai: newEnd, mapelId: newMapelId, mapelNama: mapelData.nama, kelas: mapelData.kelas };

                const newNotificationData = await scheduleNewNotification({ ...updatedData, hari: newDay });
                if (newNotificationData) {
                    updatedData.notificationId = newNotificationData.notificationId;
                    updatedData.notificationScheduledUntil = newNotificationData.notificationScheduledUntil;
                }

                const updates = {};
                updates[`users_data/${currentUserKey}/jadwal_terstruktur/${originalDay}/${scheduleId}`] = null;
                updates[`users_data/${currentUserKey}/jadwal_terstruktur/${newDay}/${scheduleId}`] = updatedData;
                
                await update(ref(db), updates);
                showToast("Jadwal berhasil diperbarui.");
                closeModal();
            } catch (err) {
                showAlertModal("Error", `Gagal memperbarui: ${err.message}`, true);
            } finally {
                hideLoader();
            }
        }
        function handleDeleteJadwalEntry(day, scheduleId) { openModal(`<h3 class="text-lg font-bold mb-2 text-red-600">Hapus Jadwal?</h3><p class="mb-6">Yakin ingin menghapus jadwal ini?</p><div class="flex justify-end space-x-2"><button onclick="window.closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button><button onclick="window.confirmDeleteJadwalEntry('${day}','${scheduleId}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button></div>`); }
        window.confirmDeleteJadwalEntry = async (day, scheduleId) => {
            closeModal();
            showLoader();
            try {
                const scheduleToDelete = allJadwalTerstruktur[day]?.[scheduleId];
                if (scheduleToDelete?.notificationId) {
                    await cancelScheduledNotification(scheduleToDelete.notificationId);
                }
                await remove(ref(db, `users_data/${currentUserKey}/jadwal_terstruktur/${day}/${scheduleId}`));
                showToast("Jadwal berhasil dihapus.");
            } catch (err) {
                showAlertModal("Error", `Gagal menghapus: ${err.message}`, true);
            } finally {
                hideLoader();
            }
        };
        function handleToggleJadwalMode() { currentJadwalMode = currentJadwalMode === 'dinamis' ? 'gambar' : 'dinamis'; const isGambar = currentJadwalMode === 'gambar'; toggleJadwalModeSwitch.style.transform = isGambar ? 'translateX(0)' : 'translateX(1.25rem)'; toggleJadwalModeBtn.classList.toggle('bg-blue-600', !isGambar); toggleJadwalModeBtn.classList.toggle('bg-gray-200', isGambar); jadwalModeLabel.textContent = `Mode: ${isGambar ? 'Gambar' : 'Buat Jadwal'}`; jadwalViewDinamis.classList.toggle('hidden', isGambar); jadwalViewGambar.classList.toggle('hidden', !isGambar); }
        function displayDashboard() { const now = new Date(); const hours = now.getHours(); let greeting = 'Selamat Pagi!'; if (hours >= 11 && hours < 15) greeting = 'Selamat Siang!'; else if (hours >= 15 && hours < 19) greeting = 'Selamat Sore!'; else if (hours >= 19 || hours < 5) greeting = 'Selamat Malam!'; dashboardGreeting.textContent = greeting; dashboardDate.textContent = formatDateToIndonesian(now); renderSmartScheduleDashboard(); }
        
        function renderSmartScheduleDashboard() {
            dashboardJadwalCerdas.innerHTML = '';
            const now = new Date();
            const todayDateString = getLocalISODate(now);
            const days = ['minggu', 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
            const todayName = days[now.getDay()];
            const todaySchedule = allJadwalTerstruktur[todayName] ? Object.entries(allJadwalTerstruktur[todayName]).map(([id, data]) => ({ id, ...data })) : [];
            const currentTime = now.toTimeString().slice(0, 5);
            let cardsToRender = [];
            for (const item of todaySchedule) {
                const isPast = currentTime >= item.jam_selesai;
                const hasPresensi = !!allPresensiData[item.kelas]?.[item.mapelId]?.[todayDateString];
                const hasKegiatan = !!allKegiatanData[item.kelas]?.[item.mapelId]?.[todayDateString]?.deskripsi;
                const isTouched = hasPresensi || hasKegiatan;
                if (isPast && !isTouched) {
                    continue;
                }
                cardsToRender.push(item);
            }
            const enrichedCards = cardsToRender.map(item => {
                const isPast = currentTime >= item.jam_selesai;
                const isCurrent = currentTime >= item.jam_mulai && currentTime < item.jam_selesai;
                const hasPresensi = !!allPresensiData[item.kelas]?.[item.mapelId]?.[todayDateString];
                const hasKegiatan = !!allKegiatanData[item.kelas]?.[item.mapelId]?.[todayDateString]?.deskripsi;
                const isComplete = hasPresensi && hasKegiatan;
                let sortOrder;
                if (isCurrent) { sortOrder = 1; } 
                else if (!isPast) { sortOrder = 2; } 
                else { if (!isComplete) { sortOrder = 3; } else { sortOrder = 4; } }
                return { ...item, sortOrder };
            });
            enrichedCards.sort((a, b) => {
                if (a.sortOrder !== b.sortOrder) { return a.sortOrder - b.sortOrder; }
                return a.jam_mulai.localeCompare(b.jam_mulai);
            });
            let dashboardHTML = '';
            if (enrichedCards.length > 0) {
                enrichedCards.forEach(item => {
                    const isPast = currentTime >= item.jam_selesai;
                    const isCurrent = currentTime >= item.jam_mulai && currentTime < item.jam_selesai;
                    const hasPresensi = !!allPresensiData[item.kelas]?.[item.mapelId]?.[todayDateString];
                    const hasKegiatan = !!allKegiatanData[item.kelas]?.[item.mapelId]?.[todayDateString]?.deskripsi;
                    const isComplete = hasPresensi && hasKegiatan;
                    let cardHeader, cardHeaderColor, cardBorderColor, cardIcon;
                    if (isCurrent) {
                        cardHeader = "SEDANG BERLANGSUNG";
                        cardHeaderColor = "text-blue-600";
                        cardBorderColor = "highlight-card";
                        cardIcon = `<i class="fa-solid fa-person-chalkboard text-xl ${cardHeaderColor}"></i>`;
                    } else if (isPast) {
                        if (isComplete) {
                            cardHeader = "SELESAI";
                            cardHeaderColor = "text-green-600";
                            cardBorderColor = "completed-card";
                            cardIcon = `<i class="fa-solid fa-check-circle text-xl ${cardHeaderColor}"></i>`;
                        } else {
                            cardHeader = "PERLU DILENGKAPI";
                            cardHeaderColor = "text-yellow-600";
                            cardBorderColor = "persistent-card";
                            cardIcon = `<i class="fa-solid fa-exclamation-triangle text-xl ${cardHeaderColor}"></i>`;
                        }
                    } else {
                        cardHeader = "SELANJUTNYA";
                        cardHeaderColor = "text-gray-500";
                        cardBorderColor = "future-card";
                        cardIcon = `<i class="fa-solid fa-hourglass-start text-xl ${cardHeaderColor}"></i>`;
                    }
                    const mapelColor = getDeterministicColor(item.mapelNama, 'mapel');
                    const kelasColor = getDeterministicColor(item.kelas, 'kelas');
                    const presensiData = allPresensiData[item.kelas]?.[item.mapelId]?.[todayDateString];
                    const kegiatanData = allKegiatanData[item.kelas]?.[item.mapelId]?.[todayDateString];
                    let presensiHTML = '', presensiDetailHTML = '', buttonHTML = '', kegiatanHTML = '';
                    
                    if (isCurrent || isPast) {
                        let buttonText = "Presensi";
                        let buttonClass = "bg-blue-600 hover:bg-blue-700";
                        
                        if (hasPresensi && !hasKegiatan) {
                            buttonText = "Kegiatan";
                            buttonClass = "bg-yellow-500 hover:bg-yellow-600";
                        } else if (isComplete || (hasPresensi && hasKegiatan)) {
                            buttonText = "Edit";
                            buttonClass = "bg-green-600 hover:bg-green-700";
                        }
                        buttonHTML = `<button onclick="window.handlePresensiShortcut('${item.mapelId}', '${item.kelas}')" class="${buttonClass} text-white font-semibold py-1.5 px-4 rounded-md transition text-sm">${buttonText}</button>`;
                    }

                    if (presensiData) { let h = 0, s = 0, i = 0, a = 0; let sakitList = [], izinList = [], alpaList = [], hadirDenganCatatanList = []; Object.entries(presensiData).forEach(([studentId, p]) => { const studentName = allStudents[studentId]?.nama || 'Siswa Dihapus'; switch(p.status) { case 'Hadir': h++; if(p.catatan) hadirDenganCatatanList.push({name: studentName, note: p.catatan}); break; case 'Sakit': s++; sakitList.push({name: studentName, note: p.catatan}); break; case 'Izin': i++; izinList.push({name: studentName, note: p.catatan}); break; case 'Alpa': a++; alpaList.push({name: studentName, note: p.catatan}); break; } }); presensiHTML = `<div class="mt-4 pt-4 border-t"><p class="text-sm font-bold mb-2">Rekap Presensi</p><div class="flex justify-around text-center text-sm"><div><strong>${h}</strong><p>Hadir</p></div><div><strong class="text-orange-600">${s}</strong><p>Sakit</p></div><div><strong class="text-green-600">${i}</strong><p>Izin</p></div><div><strong class="text-red-600">${a}</strong><p>Alpa</p></div></div></div>`; if (sakitList.length > 0 || izinList.length > 0 || alpaList.length > 0 || hadirDenganCatatanList.length > 0) { presensiDetailHTML += '<div class="mt-3 text-xs space-y-1">'; const createList = (title, list) => { if(list.length > 0) presensiDetailHTML += `<div><strong>${title}:</strong> ${list.map(item => `${item.name}<span class="italic text-gray-500">${item.note ? ` (${item.note})` : ''}</span>`).join(', ')}</div>`; }; createList('Sakit', sakitList); createList('Izin', izinList); createList('Alpa', alpaList); createList('Hadir (dgn catatan)', hadirDenganCatatanList); presensiDetailHTML += '</div>'; } } 
                    if (kegiatanData?.deskripsi) { kegiatanHTML = `<div class="mt-4 pt-4 border-t"><p class="text-sm font-bold mb-1">Kegiatan</p><p class="text-sm bg-gray-100 p-2 rounded">${kegiatanData.deskripsi}</p></div>`; } else if (hasPresensi) { kegiatanHTML = `<div class="mt-4 pt-4 border-t"><p class="text-sm font-bold mb-1">Kegiatan</p><p class="text-sm text-orange-600 font-semibold">Belum diisi.</p></div>`; } 
                    const detailContent = (presensiHTML + presensiDetailHTML + kegiatanHTML); 
                    dashboardHTML += ` <div class="dashboard-card ${cardBorderColor} mb-4"> <div class="flex justify-between items-center mb-2"> <div class="flex items-center space-x-3"> ${cardIcon} <p class="text-sm font-bold ${cardHeaderColor}">${cardHeader}</p> </div> <p class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${item.jam_mulai} - ${item.jam_selesai}</p> </div> <div class="flex justify-between items-center"> <div> <h4 class="text-2xl font-bold mb-1"> <span class="px-2 py-1 rounded-md text-xl ${mapelColor.bg} ${mapelColor.text}"> ${item.mapelNama} </span> </h4> <p class="text-lg text-gray-600"> <span class="font-semibold px-2 py-1 rounded-md text-base ${kelasColor.bg} ${kelasColor.text}"> Kelas ${item.kelas} </span> </p> </div> ${buttonHTML ? `<div class="flex-shrink-0 ml-4">${buttonHTML}</div>` : ''} </div> ${(hasPresensi || hasKegiatan) ? `${detailContent}` : ''} </div>`; 
                });
            }
            if (dashboardHTML === '') { if (todaySchedule.length > 0) { dashboardHTML = `<div class="dashboard-card text-center"><i class="fa-solid fa-check-circle text-4xl text-green-500 mb-3"></i><h4 class="font-bold text-lg">Semua Jadwal Selesai</h4><p class="text-gray-500">Jadwal yang tidak diisi telah disembunyikan. Anda dapat beristirahat.</p></div>`; } else { dashboardHTML = `<div class="dashboard-card text-center"><i class="fa-solid fa-calendar-times text-4xl text-gray-400 mb-3"></i><h4 class="font-bold text-lg">Tidak Ada Jadwal Hari Ini</h4><p class="mb-4">Buat jadwal untuk menggunakan dasbor cerdas.</p><button onclick="window.goToBuatJadwal()" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Buat Jadwal</button></div>`; } } 
            dashboardJadwalCerdas.innerHTML = dashboardHTML;
        }

        window.goToBuatJadwal = () => { switchPage('jadwal'); if (currentJadwalMode !== 'dinamis') handleToggleJadwalMode(); }
        async function handlePresensiShortcut(mapelId, kelas) { const mapelData = allMapel[mapelId]; if (!mapelData) return showAlertModal("Error", "Mapel tidak ditemukan.", true); switchPage('presensi'); filterMapel.value = mapelData.nama; await updateClassFilter('presensi'); filterKelas.value = kelas; filterTanggal.value = getLocalISODate(); await handleTerapkanFilter(true); el('filter-container').scrollIntoView({ behavior: 'smooth' }); }
        async function syncOfflineData() { const pending = JSON.parse(localStorage.getItem('pending-updates') || '{}'); if (Object.keys(pending).length === 0) return; showToast("Menyinkronkan data..."); showLoader(); try { await update(ref(db), pending); localStorage.removeItem('pending-updates'); showToast("Sinkronisasi berhasil."); } catch (e) { showToast("Gagal sinkronisasi.", true); } finally { hideLoader(); } }
        function handleOnlineStatus() { offlineIndicator.classList.add('hidden'); syncOfflineData(); }
        function handleOfflineStatus() { offlineIndicator.classList.remove('hidden'); showToast("Anda offline.", true); }
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installPwaBtn.classList.remove('hidden'); });
        installPwaBtn.addEventListener('click', async () => { installPwaBtn.classList.add('hidden'); deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; });
        window.addEventListener('appinstalled', () => { installPwaBtn.classList.add('hidden'); deferredPrompt = null; showToast("Aplikasi berhasil diinstal!"); });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW registration failed: ', err)); }); }
        window.handleDeleteDailyData = handleDeleteDailyData; window.handleDeleteJadwal = handleDeleteJadwal; window.handleDeleteMapel = handleDeleteMapel; window.handleDeleteStudent = handleDeleteStudent; window.handleEditMapel = handleEditMapel; window.handleEditStudent = handleEditStudent; window.selectOption = selectOption; window.showDeleteMapelModal = showDeleteMapelModal; window.showDeleteStudentModal = showDeleteStudentModal; window.showEditMapelModal = showEditMapelModal; window.showEditStudentModal = showEditStudentModal; window.toggleCatatan = toggleCatatan; window.toggleDropdown = toggleDropdown; window.toggleHistory = toggleHistory; window.updateCatatanValue = updateCatatanValue; window.updateNilaiValue = updateNilaiValue; window.handleDeleteJadwalEntry = handleDeleteJadwalEntry; window.confirmDeleteJadwalEntry = confirmDeleteJadwalEntry; window.goToBuatJadwal = goToBuatJadwal; window.handlePresensiShortcut = handlePresensiShortcut; window.showEditJadwalModal = showEditJadwalModal; window.handleEditJadwal = handleEditJadwal;
        filterTanggal.value = getLocalISODate();
        handleToggleJadwalMode();
        switchPage('dashboard');
    </script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
    </script>
</body>
</html>
